---
import Layout from "../layouts/Layout.astro";
import { AstroSEO } from "astro-seo-plugin";
import { fetchVibePageData } from "../api.js";
import GalleryGrid from "../components/GalleryGrid.astro";

// Ultra-reliable API fetching with retry logic
async function fetchWithRetry(fetchFn, retries = 2) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fetchFn();
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise((resolve) => setTimeout(resolve, 1000));
    }
  }
}

// Bulletproof URL validation
function validateImageUrl(url) {
  if (!url || typeof url !== "string") return null;
  try {
    const parsed = new URL(url);
    return parsed.protocol === "https:" ? url : null;
  } catch {
    return null;
  }
}

// Fetch data with retry protection
let vibeData = null;
let error = null;

try {
  vibeData = await fetchWithRetry(() => fetchVibePageData());
} catch (err) {
  console.error("Failed to load vibe data:", err);
  error = "Failed to load content";
}

if (!vibeData) {
  vibeData = {
    vibeImages: [],
    wildlifeImages: [],
  };
}

// Ultra-safe image processing with validation
const vibeImages = (vibeData.vibeImages || [])
  .filter((item) => validateImageUrl(item?.image?.url))
  .map((item, index) => {
    const image = item.image;
    return {
      src: validateImageUrl(image.thumb800) || validateImageUrl(image.url),
      srcset: `${validateImageUrl(image.thumb400) || validateImageUrl(image.url)} 400w, ${validateImageUrl(image.thumb800) || validateImageUrl(image.url)} 800w`,
      placeholder:
        validateImageUrl(image.placeholder) || validateImageUrl(image.url),
      large: validateImageUrl(image.large) || validateImageUrl(image.url),
      alt:
        (item.altText || "").trim() ||
        `Experience the Limban vibe ${index + 1}`,
      width: parseInt(image.width) || 600,
      height: parseInt(image.height) || 450,
      priority: index < 4, // First 4 images get priority loading
    };
  });

const wildlifeImages = (vibeData.wildlifeImages || [])
  .filter((item) => validateImageUrl(item?.image?.url))
  .map((item, index) => {
    const image = item.image;
    return {
      src: validateImageUrl(image.thumb800) || validateImageUrl(image.url),
      srcset: `${validateImageUrl(image.thumb400) || validateImageUrl(image.url)} 400w, ${validateImageUrl(image.thumb800) || validateImageUrl(image.url)} 800w`,
      placeholder:
        validateImageUrl(image.placeholder) || validateImageUrl(image.url),
      large: validateImageUrl(image.large) || validateImageUrl(image.url),
      alt: (item.alt || "").trim() || `Tadoba wildlife encounter ${index + 1}`,
      width: parseInt(image.width) || 600,
      height: parseInt(image.height) || 450,
      priority: index < 2, // First 2 wildlife images get priority
    };
  });

// Safe hero image for OpenGraph
const heroImage =
  vibeImages.find((img) => img.src)?.src || "/limban-vibe-hero.webp";
---

<Layout title="The Limban Vibe - Feel What Calls You Wild">
  <!-- Performance optimization: DNS prefetch for external images -->
  <link rel="dns-prefetch" href="https://ap-south-1.graphassets.com" />
  <link rel="preconnect" href="https://ap-south-1.graphassets.com" />

  <AstroSEO
    title="The Limban Vibe | Feel What Calls You Wild - Tadoba Safari Experience"
    description="Immerse yourself in the Limban experience. Feel the luxury, taste the wild, live the moment. This is what calls you to Tadoba."
    canonical="https://limban.com/vibe"
    openGraph={{
      title: "The Limban Vibe - Feel What Calls You Wild",
      description:
        "Experience luxury safari living at its finest in Tadoba National Park. Feel the vibe that makes Limban unforgettable.",
      image: heroImage,
      type: "website",
      url: "https://limban.com/vibe",
    }}
  />

  <div class="bg-gray-950 text-gray-100 selection:bg-amber-400/20">
    <!-- Skip to content for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-amber-400 text-gray-900 px-4 py-2 rounded z-50"
    >
      Skip to main content
    </a>

    <!-- Hero Section with optimized loading -->
    <section
      class="relative min-h-screen overflow-hidden"
      role="banner"
      aria-labelledby="hero-heading"
    >
      <!-- Optimized Background Mosaic with priority loading -->
      <div class="absolute inset-0 grid grid-cols-4 grid-rows-3 gap-1">
        {
          vibeImages.slice(0, 12).map((image, index) => (
            <div
              class="relative overflow-hidden opacity-30 hover:opacity-60 transition-opacity duration-1000"
              style={`animation-delay: ${index * 0.2}s`}
            >
              <img
                src={image.placeholder}
                data-src={image.src}
                alt={image.alt}
                class="w-full h-full object-cover scale-110 lazy-image"
                loading={image.priority ? "eager" : "lazy"}
                fetchpriority={index === 0 ? "high" : "auto"}
                decoding="async"
                width={image.width}
                height={image.height}
              />
            </div>
          ))
        }
      </div>

      <!-- Gradient Overlay -->
      <div
        class="absolute inset-0 bg-gradient-to-br from-black/70 via-black/40 to-black/70"
      >
      </div>

      <!-- Hero Content with proper accessibility -->
      <div
        class="relative z-20 min-h-screen flex items-center justify-center text-center px-6"
      >
        <div class="max-w-6xl space-y-12">
          <div class="space-y-6">
            <h1
              id="hero-heading"
              class="font-serif text-6xl md:text-8xl lg:text-9xl text-white leading-none tracking-tight"
            >
              Feel
              <span class="block text-amber-400 italic">The Vibe</span>
            </h1>
            <p
              class="text-2xl md:text-3xl text-gray-200 font-light leading-relaxed max-w-4xl mx-auto"
              aria-live="polite"
            >
              This is what calls you wild. This is what makes you stay.
              <span class="block mt-4 text-amber-400 italic"
                >This is Limban.</span
              >
            </p>
          </div>

          <!-- Accessible scroll indicator -->
          <div class="pt-16">
            <button
              class="animate-bounce cursor-pointer"
              id="scroll-indicator"
              aria-label="Scroll to main content"
            >
              <svg
                class="w-8 h-8 mx-auto text-amber-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1"
                  d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
              </svg>
            </button>
            <p class="text-sm text-gray-400 mt-2">Scroll to feel the magic</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Main content wrapper -->
    <main id="main-content" role="main">
      <!-- Breadcrumb Navigation -->
      <nav class="py-6 border-b border-gray-800/50" aria-label="Breadcrumb">
        <div class="max-w-7xl mx-auto px-6">
          <ol
            class="flex items-center justify-center space-x-2 text-sm text-gray-400"
          >
            <li>
              <a
                href="/"
                class="hover:text-amber-400 transition-colors duration-300"
                >Home</a
              >
            </li>
            <li aria-hidden="true">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd"></path>
              </svg>
            </li>
            <li aria-current="page">
              <span class="text-amber-400 font-medium">The Vibe</span>
            </li>
          </ol>
        </div>
      </nav>

      <!-- Resort Vibe Section -->
      <section class="py-32 bg-gray-900" aria-labelledby="resort-heading">
        <div class="max-w-7xl mx-auto px-6">
          <div class="text-center mb-20">
            <div
              class="inline-block px-6 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-8"
            >
              <span
                class="text-amber-400 text-sm font-medium tracking-widest uppercase"
                >Resort Experience</span
              >
            </div>
            <h2
              id="resort-heading"
              class="font-serif italic text-5xl md:text-7xl text-white mb-8"
            >
              Live the Luxury.
              <span class="block text-amber-400">Feel the Soul.</span>
            </h2>
            <p
              class="text-xl text-gray-300 font-light leading-relaxed max-w-4xl mx-auto"
            >
              Every corner whispers stories. Every moment breathes life. This is
              how luxury feels when it's crafted with soul.
            </p>
          </div>
          <GalleryGrid
            images={vibeImages}
            layout="masonry"
            galleryType="vibe"
          />
        </div>
      </section>

      <!-- Transition Section -->
      <section class="py-20 bg-gradient-to-b from-gray-900 to-green-950/30">
        <div class="max-w-4xl mx-auto text-center px-6">
          <h3 class="font-serif italic text-4xl md:text-5xl text-white mb-6">
            And then...
            <span class="block text-amber-400">The Wild Calls</span>
          </h3>
          <p class="text-xl text-gray-300 font-light leading-relaxed">
            Beyond the luxury, beyond the comfort, lies the reason you came
            here. The untamed. The magnificent. The wild heart of Tadoba.
          </p>
        </div>
      </section>

      <!-- Wildlife Gallery Section -->
      <section class="py-32 bg-gray-950" aria-labelledby="wildlife-heading">
        <div class="max-w-7xl mx-auto px-6">
          <div class="text-center mb-20">
            <div
              class="inline-block px-6 py-2 bg-green-400/10 border border-green-400/30 rounded-full mb-8"
            >
              <span
                class="text-green-400 text-sm font-medium tracking-widest uppercase"
                >Wild Encounters</span
              >
            </div>
            <h2
              id="wildlife-heading"
              class="font-serif italic text-5xl md:text-7xl text-white mb-8"
            >
              Meet Your
              <span class="block text-green-400">Wild Neighbours</span>
            </h2>
            <p
              class="text-xl text-gray-300 font-light leading-relaxed max-w-4xl mx-auto"
            >
              In Tadoba, you're not just a visitor—you're a guest in their
              ancient kingdom. These are the moments that change you forever.
            </p>
          </div>
          <GalleryGrid
            images={wildlifeImages}
            layout="grid"
            galleryType="wildlife"
          />
        </div>
      </section>

      <!-- Call to Action -->
      <section class="py-32 bg-gray-900">
        <div class="max-w-5xl mx-auto px-6 text-center">
          <h2 class="font-serif italic text-5xl md:text-7xl text-white mb-8">
            Ready to Experience
            <span class="block text-amber-400">The Limban Vibe?</span>
          </h2>
          <p
            class="text-2xl text-gray-300 font-light leading-relaxed mb-12 max-w-4xl mx-auto"
          >
            Every image tells a story. Your story begins the moment you arrive.
            The wild is calling. Limban is waiting.
          </p>
          <div class="flex flex-col sm:flex-row gap-6 justify-center">
            <a
              href="/rooms"
              class="inline-flex items-center px-10 py-5 bg-amber-400 text-gray-900 font-semibold rounded-full hover:bg-amber-300 hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-2xl text-lg focus:outline-none focus:ring-4 focus:ring-amber-400/50"
            >
              Book Your Experience
              <svg
                class="w-6 h-6 ml-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
              </svg>
            </a>
            <a
              href="/safaris"
              class="inline-flex items-center px-10 py-5 border-2 border-amber-400 text-amber-400 font-semibold rounded-full hover:bg-amber-400/10 hover:scale-105 transition-all duration-300 text-lg focus:outline-none focus:ring-4 focus:ring-amber-400/50"
            >
              Plan Your Safari
              <svg
                class="w-6 h-6 ml-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                ></path>
              </svg>
            </a>
          </div>
        </div>
      </section>
    </main>
  </div>
</Layout>

<script define:vars={{ vibeImages, wildlifeImages }}>
  // Enhanced lazy loading system
  class OptimizedLazyLoader {
    constructor() {
      this.observer = null;
      this.loadQueue = new Set();
      this.init();
    }

    init() {
      if ("IntersectionObserver" in window) {
        this.observer = new IntersectionObserver(
          (entries) => this.handleIntersection(entries),
          { rootMargin: "50px 0px", threshold: 0.1 }
        );
      }
      this.observeImages();
    }

    observeImages() {
      const lazyImages = document.querySelectorAll(".lazy-image");
      lazyImages.forEach((img) => {
        if (this.observer) {
          this.observer.observe(img);
        } else {
          this.loadImage(img);
        }
      });
    }

    handleIntersection(entries) {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          this.loadImage(entry.target);
          this.observer.unobserve(entry.target);
        }
      });
    }

    async loadImage(img) {
      const src = img.dataset.src;
      if (!src || this.loadQueue.has(src)) return;

      this.loadQueue.add(src);

      try {
        await this.preloadImage(src);
        img.src = src;
        img.classList.add("opacity-100");
        img.classList.remove("lazy-image");
      } catch (error) {
        console.warn("Failed to load image:", src);
      } finally {
        this.loadQueue.delete(src);
      }
    }

    preloadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = resolve;
        img.onerror = reject;
        img.src = src;
      });
    }
  }

  // Initialize optimized loader
  new OptimizedLazyLoader();

  // Gallery modal integration
  const galleryData = { vibe: vibeImages, wildlife: wildlifeImages };

  document.querySelectorAll("[data-gallery-type]").forEach((el) => {
    el.addEventListener("click", () => {
      const galleryType = el.dataset.galleryType;
      const index = parseInt(el.dataset.galleryIndex, 10);
      const images = galleryData[galleryType];

      if (images && images.length > 0) {
        document.dispatchEvent(
          new CustomEvent("open-gallery", {
            detail: { images, index },
          })
        );
      }
    });
  });

  // Smooth scroll to main content
  document.getElementById("scroll-indicator")?.addEventListener("click", () => {
    document.getElementById("main-content")?.scrollIntoView({
      behavior: "smooth",
    });
  });
</script>

<style>
  /* Performance-optimized transitions */
  .lazy-image {
    transition: opacity 0.7s ease-in-out;
    will-change: opacity;
  }

  /* Staggered animation for hero mosaic */
  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(1.1);
    }
    to {
      opacity: 0.3;
      transform: scale(1);
    }
  }

  /* Accessible focus states */
  .focus\:not-sr-only:focus {
    position: absolute !important;
    width: auto !important;
    height: auto !important;
    padding: 1rem !important;
    margin: 0 !important;
    overflow: visible !important;
    clip: auto !important;
    white-space: normal !important;
  }

  /* Custom scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #1f2937;
  }
  ::-webkit-scrollbar-thumb {
    background: #f59e0b;
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #d97706;
  }
</style>
