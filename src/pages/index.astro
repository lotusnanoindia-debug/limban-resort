---
import Layout from "../layouts/Layout.astro";
import { AstroSEO } from "astro-seo-plugin";
import HeroSection from "../components/HeroSection.astro";
import SubHeroSection from "../components/SubHeroSection.astro";
import RoomsSection from "../components/RoomsSection.astro";
import ExperiencesSection from "../components/ExperiencesSection.astro";
import TestimonialsSection from "../components/TestimonialsSection.astro";
import AwardsSection from "../components/AwardsSection.astro";
import ContactSection from "../components/ContactSection.astro";
import { fetchAllHomepageData } from "../api.js";
import { getImage } from "astro:assets";

// Ultra-reliable API fetching with retry logic
async function fetchWithRetry(fetchFn, retries = 2) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fetchFn();
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise((resolve) => setTimeout(resolve, 1000));
    }
  }
}

// üéØ SIMPLE: Single image optimizer for all types
async function optimizeImage(url, width, height, quality = 60) {
  if (!url) return null;
  try {
    const optimized = await getImage({
      src: url,
      width: width,
      height: height,
      format: "avif",
      quality: quality,
      fit: "cover",
      inferSize: true,
    });
    return optimized;
  } catch (error) {
    return { src: url };
  }
}

// Server-side data fetching
let data = {
  heroes: [],
  subHero: null,
  rooms: [],
  experiences: null,
  specialDeal: null,
};
let error = null;

try {
  data = await fetchWithRetry(() => fetchAllHomepageData());

  // üéØ OPTIMIZE: ALL hero images with individual quality settings
  if (data.heroes?.length > 0) {
    data.heroes = await Promise.all(
      data.heroes.map(async (hero, index) => {
        const optimizedImages = {};

        // üéØ QUALITY CONTROL: First hero gets highest quality, others lower
        const qualitySettings = {
          hero4K: index === 0 ? 75 : 65, // Ultra-high res
          desktop: index === 0 ? 80 : 70, // Primary desktop
          tablet: index === 0 ? 85 : 75, // Tablet viewing
          mobile: index === 0 ? 85 : 80, // Mobile (smallest, highest quality)
        };

        // Optimize each responsive breakpoint with individual quality
        if (hero.backgroundImage?.hero4K) {
          optimizedImages.hero4K = await optimizeImage(
            hero.backgroundImage.hero4K,
            2560,
            1440,
            qualitySettings.hero4K
          );
        }
        if (hero.backgroundImage?.heroDesktop) {
          optimizedImages.desktop = await optimizeImage(
            hero.backgroundImage.heroDesktop,
            1920,
            1080,
            qualitySettings.desktop
          );
        }
        if (hero.backgroundImage?.heroTablet) {
          optimizedImages.tablet = await optimizeImage(
            hero.backgroundImage.heroTablet,
            1024,
            576,
            qualitySettings.tablet
          );
        }
        if (hero.backgroundImage?.heroMobile) {
          optimizedImages.mobile = await optimizeImage(
            hero.backgroundImage.heroMobile,
            768,
            432,
            qualitySettings.mobile
          );
        }

        return { ...hero, optimizedImages };
      })
    );
  }

  //  Sub-hero image
  if (data.subHero?.image?.url) {
    const optimizedSubHero = await optimizeImage(
      data.subHero.image.url,
      800,
      600,
      65
    );
    if (optimizedSubHero) {
      data.subHero.optimizedImage = optimizedSubHero;
    }
  }

  // üéØ OPTIMIZE: Only first 3 room images (above fold)
  if (data.rooms?.length > 0) {
    data.rooms = await Promise.all(
      data.rooms.map(async (room, index) => {
        // Only optimize first 3 images that load eagerly
        if (index < 3 && room.heroImage?.optimisedCard) {
          const optimized = await optimizeImage(
            room.heroImage.optimisedCard,
            400,
            300,
            65
          );
          return { ...room, optimizedImage: optimized };
        }
        // Keep other rooms unprocessed - they'll load original images lazily
        return room;
      })
    );
  }

  //  Experience images
  if (data.experiences?.experience?.length > 0) {
    data.experiences.experience = await Promise.all(
      data.experiences.experience.map(async (exp) => {
        if (exp.image?.url) {
          const optimized = await optimizeImage(exp.image.url, 400, 200, 85);
          return { ...exp, optimizedImage: optimized };
        }
        return exp;
      })
    );
  }
} catch (err) {
  console.error("Failed to load homepage data:", err);
  error = "Failed to load content from CMS";
}

// Safe hero image fallback
const heroImage =
  data.heroes[0]?.optimizedImages?.desktop?.src ||
  data.heroes[0]?.optimizedImages?.mobile?.src ||
  data.heroes[0]?.backgroundImage?.heroDesktop ||
  data.heroes[0]?.backgroundImage?.heroMobile ||
  "/img/limban-hero-fallback.avif";

// Full JSON-LD for SEO (CRITICAL - DO NOT CUT)
const enhancedJsonLd = {
  "@context": "https://schema.org",
  "@type": "Resort",
  "@id": "https://limban.com/#resort",
  name: "Limban Resort",
  description:
    "Award-winning eco-luxury safari resort in Tadoba National Park offering sustainable tiger safaris, wellness programs, and conservation-focused hospitality in Maharashtra, India",
  url: "https://limban.com",
  logo: {
    "@type": "ImageObject",
    url: "https://limban.com/img/limban-resort-tadoba-logo.avif",
    width: 300,
    height: 100,
  },
  image: [
    heroImage,
    ...data.rooms
      .slice(0, 3)
      .map((room) => room.optimizedImage?.src || room.heroImage?.optimisedCard)
      .filter(Boolean),
    ...data.experiences?.experience
      ?.slice(0, 2)
      .map((exp) => exp.optimizedImage?.src || exp.image?.url)
      .filter(Boolean),
  ].filter(Boolean),
  sameAs: [
    "https://www.tripadvisor.in/Hotel_Review-g10594630-d12902646-Reviews-Limban_Resort-Chandrapur_District_Maharashtra.html",
    "https://www.instagram.com/limbanresorts/",
    "https://www.facebook.com/limbanresortstadoba/",
    "https://lotus-nano.com",
  ],
  address: {
    "@type": "PostalAddress",
    streetAddress: "Survey No. 306, Village Mudholi, Taluka Bhadravati",
    addressLocality: "Chandrapur",
    addressRegion: "Maharashtra",
    postalCode: "442906",
    addressCountry: "IN",
  },
  geo: {
    "@type": "GeoCoordinates",
    latitude: 20.25602486093492,
    longitude: 79.2847888101826,
  },
  telephone: ["+91-90226-80451"],
  email: "info@limban.com",
  priceRange: "‚Çπ15,000-‚Çπ45,000",
  currenciesAccepted: ["INR"],
  paymentAccepted: ["Cash", "Credit Card", "UPI", "Bank Transfer"],
  checkinTime: "13:00",
  checkoutTime: "11:00",
  numberOfRooms: data.rooms?.length || 6,
  petsAllowed: false,
  smokingAllowed: false,
  starRating: {
    "@type": "Rating",
    ratingValue: 5,
  },
  aggregateRating: {
    "@type": "AggregateRating",
    ratingValue: 4.8,
    reviewCount: 127,
    bestRating: 5,
    worstRating: 1,
  },
  amenityFeature: [
    {
      "@type": "LocationFeatureSpecification",
      name: "Tiger Safari Tours",
      value: true,
    },
    {
      "@type": "LocationFeatureSpecification",
      name: "Eco-Luxury Accommodations",
      value: true,
    },
    {
      "@type": "LocationFeatureSpecification",
      name: "Wildlife Conservation Programs",
      value: true,
    },
    {
      "@type": "LocationFeatureSpecification",
      name: "Spa & Wellness Center",
      value: true,
    },
    {
      "@type": "LocationFeatureSpecification",
      name: "Restaurant & Bar",
      value: true,
    },
    {
      "@type": "LocationFeatureSpecification",
      name: "Swimming Pool",
      value: true,
    },
    {
      "@type": "LocationFeatureSpecification",
      name: "Free WiFi",
      value: true,
    },
    {
      "@type": "LocationFeatureSpecification",
      name: "Airport Transfer",
      value: true,
    },
  ],
  makesOffer: [
    {
      "@type": "Offer",
      name: "Safari Package",
      description: "Tiger safari experience with luxury accommodation",
      priceCurrency: "INR",
      price: "25000",
    },
  ],
  hasMap:
    "https://www.google.com/maps/place/20.25602486093492,79.2847888101826",
  parentOrganization: {
    "@type": "Organization",
    name: "Lotus Nano",
    url: "https://lotus-nano.com",
  },
  award: [
    "TripAdvisor Travelers' Choice 2023",
    "Cond√© Nast Traveller Featured Property",
    "Outlook Traveller Hidden Gem 2022",
  ],
  knowsAbout: [
    "Tiger Conservation",
    "Sustainable Tourism",
    "Wildlife Photography",
    "Eco-Luxury Hospitality",
    "Tadoba Ecosystem",
  ],
};
---

<Layout>
  <AstroSEO
    slot="head"
    title="Limban Resort | Award-Winning Eco-Luxury Tiger Safari Lodge in Tadoba National Park"
    description="Experience sustainable luxury at Limban Resort, Tadoba's premier eco-friendly safari lodge. Award-winning tiger safaris, conservation programs, and luxury accommodations in Maharashtra, India."
    canonical="https://limban.com"
    openGraph={{
      title:
        "Limban Resort - Award-Winning Eco-Luxury Safari Lodge | Tadoba National Park",
      description:
        "Discover India's premier eco-luxury safari experience at Limban Resort. Sustainable tiger safaris, conservation programs, and award-winning hospitality in Tadoba National Park, Maharashtra.",
      image: heroImage,
      type: "website",
      url: "https://limban.com",
      site_name: "Limban Resort",
    }}
    jsonLd={enhancedJsonLd}
  />

  {
    error ? (
      <div class="bg-gray-950 text-gray-100 h-screen flex items-center justify-center">
        <div class="text-center max-w-md mx-auto px-6">
          <h1 class="text-2xl font-serif italic mb-4 text-red-400">
            Content Unavailable
          </h1>
          <p class="text-gray-400 mb-4">{error}</p>
          <button
            onclick="window.location.reload()"
            class="px-6 py-3 bg-amber-400 text-gray-900 font-semibold rounded-full"
          >
            Try Again
          </button>
        </div>
      </div>
    ) : (
      <div class="bg-gray-950 text-gray-100">
        <main>
          <HeroSection heroes={data.heroes} />
          <SubHeroSection subHero={data.subHero} />
          <RoomsSection rooms={data.rooms} specialDeal={data.specialDeal} />
          <ExperiencesSection experiences={data.experiences} />
          <TestimonialsSection />
          <AwardsSection />
          <ContactSection />
        </main>
      </div>
    )
  }
</Layout>
