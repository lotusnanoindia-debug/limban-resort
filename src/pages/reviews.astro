---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import { supabase } from '../lib/supabase';
import { AstroSEO } from "astro-seo-plugin";

// CONFIGURE: Reviews per load
const REVIEWS_PER_LOAD = 9;

// Fetch initial batch of 4-5 star reviews
const { data: reviews, error } = await supabase
  .from('reviews')
  .select('*')
  .gte('rating', 4)
  .not('review_text', 'is', null)
  .order('published_date', { ascending: false })
  .limit(REVIEWS_PER_LOAD);

// Get REAL counts (all reviews, unfiltered) with ratings
const { data: allGoogleReviews } = await supabase
  .from('reviews')
  .select('id, rating')
  .eq('source', 'google')
  .order('published_date', { ascending: true })
  .limit(190); // Match closer to Google's public count (188)

const { data: allTAReviews } = await supabase
  .from('reviews')
  .select('id, rating')
  .eq('source', 'tripadvisor')
  .order('published_date', { ascending: false })

const googleCount = allGoogleReviews?.length || 0;
const tripadvisorCount = allTAReviews?.length || 0;
const totalCount = googleCount + tripadvisorCount;

// Calculate average ratings
const googleAvg = allGoogleReviews?.length 
  ? (allGoogleReviews.reduce((sum, r) => sum + (r.rating || 0), 0) / allGoogleReviews.length).toFixed(1)
  : '0.0';

const taAvg = allTAReviews?.length
  ? (allTAReviews.reduce((sum, r) => sum + (r.rating || 0), 0) / allTAReviews.length).toFixed(1)
  : '0.0';

const overallAvg = (allGoogleReviews?.length || 0) + (allTAReviews?.length || 0) > 0
  ? (([...allGoogleReviews || [], ...allTAReviews || []].reduce((sum, r) => sum + (r.rating || 0), 0)) / totalCount).toFixed(1)
  : '0.0';

// Get total count of 4-5 star reviews (for "Load More" logic)
const { count: totalQualityReviews } = await supabase
  .from('reviews')
  .select('*', { count: 'exact', head: true })
  .gte('rating', 4)
  .not('review_text', 'is', null);

if (error) {
  console.error('Error fetching reviews:', error);
}

// Hero image from Cloudinary
const heroImageRaw = "https://res.cloudinary.com/dfa5hhzej/image/upload/v1761730880/reviews-hero-limban_bbytqm.jpg";
const heroImage = "https://res.cloudinary.com/dfa5hhzej/image/upload/w_800,c_limit,f_auto,q_auto/v1761730880/reviews-hero-limban_bbytqm.jpg";
const heroImageSchema = "https://res.cloudinary.com/dfa5hhzej/image/upload/w_1200,h_675,c_fill,q_85,f_jpg/v1761730880/reviews-hero-limban_bbytqm.jpg";

// Reviews page schema
const reviewsPageSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "@id": "https://limban.com/reviews#page",
  name: "Guest Reviews - Limban Resort",
  description: "Read authentic reviews from guests who experienced Limban Resort in Tadoba National Park. Discover what makes our luxury safari resort special.",
  url: "https://limban.com/reviews",
  mainEntity: {
    "@type": "Hotel",
    "@id": "https://limban.com/#hotel",
    name: "Limban Resort",
  },
};
---

<Layout>
  <AstroSEO
    slot="head"
    title="Guest Reviews | Limban Resort Tadoba National Park"
    description="Read authentic reviews from guests at Limban Resort in Tadoba National Park. Discover why travellers rate our luxury safari resort with 4.9+ stars on Google and TripAdvisor."
    openGraph={{
      title: "Guest Reviews | Limban Resort",
      description: "Read authentic guest experiences from our luxury safari resort in Tadoba National Park. 4.9+ star ratings on Google and TripAdvisor.",
      image: heroImageSchema,
      type: "website",
      url: "https://limban.com/reviews",
    }}
    jsonLd={reviewsPageSchema}
  />

  <main>
    <!-- Hero Section with Background Image -->
    <section class="relative min-h-[70vh] md:min-h-[60vh] flex items-center justify-center overflow-hidden">
      <!-- Background Image -->
      <img
        src={heroImage}
        alt="Experience Tadoba's wilderness - Limban Resort guest reviews"
        class="absolute inset-0 w-full h-full object-cover scale-110"
        loading="eager"
        fetchpriority="high"
      />

      <!-- Background Overlays -->
      <div class="absolute inset-0 bg-black/60 z-10"></div>
      <div class="absolute inset-0 bg-gradient-to-b from-gray-950/40 via-transparent to-gray-950/80 z-10"></div>
      <div class="absolute inset-0 bg-gradient-radial from-transparent via-gray-950/20 to-gray-950/60 z-10"></div>

      <!-- Hero Content -->
      <div class="relative z-20 max-w-7xl mx-auto px-6 text-center">
        <!-- Badge -->
        <div class="inline-block mb-8">
          <div class="bg-gradient-to-r from-amber-400/20 via-amber-500/20 to-emerald-400/20 border border-amber-400/40 rounded-full px-8 py-3">
            Authentic Experiences
          </div>
        </div>

        <!-- Headline -->
        <h1 class="font-serif text-5xl md:text-7xl xl:text-8xl text-white leading-[0.9] mb-6">
         Limban Guest
          <span class="block text-transparent bg-gradient-to-r from-amber-300 via-amber-400 to-yellow-400 bg-clip-text">
            Reviews
          </span>
        </h1>

        <!-- Subtitle -->
        <div class="max-w-4xl mx-auto">
          <p class="text-lg md:text-xl xl:text-2xl text-gray-200 font-semibold leading-[1.3]">
            <span class="inline-block">Every review is a testament to moments that became memories.</span>
            <span class="inline-block">Read what our guests have to say about their time in the wild.</span>
          </p>
        </div>
      </div>
    </section>

    <!-- Breadcrumb Navigation -->
    <nav class="py-6 bg-gray-900/50 border-b border-gray-800" aria-label="Breadcrumb">
      <div class="max-w-7xl mx-auto px-6">
        <ol class="flex items-center justify-center space-x-2 text-sm">
          <li>
            <a
              href="/"
              title="Return to Limban Resort homepage"
              class="text-gray-400 hover:text-amber-400 transition-colors duration-300 flex items-center focus:outline-none focus:ring-2 focus:ring-amber-400/50 rounded"
            >
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
              </svg>
              Home
            </a>
          </li>
          <li aria-hidden="true">
            <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          </li>
          <li aria-current="page">
            <span class="text-amber-400 font-medium">Reviews</span>
          </li>
        </ol>
      </div>
    </nav>

    <!-- Review Stats Section -->
    <section class="py-24 bg-gradient-to-b from-gray-900 to-gray-950">
      <div class="max-w-7xl mx-auto px-6">
        <div class="flex flex-wrap justify-center gap-8">
          
          <!-- Google Reviews Card -->
          <a 
            href="https://cloud.umami.is/q/s9UFkrcx4"
            target="_blank"
            rel="noopener noreferrer"
            class="group w-64 text-center bg-gray-900/50 backdrop-blur-xl border border-gray-800 hover:border-amber-400/50 rounded-2xl p-8 transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl hover:shadow-black/20"
          >
            <div class="space-y-4">
              <div class="text-5xl font-bold text-amber-400 group-hover:text-amber-300 transition-colors">{googleCount}</div>
              <div class="text-sm text-gray-400 uppercase tracking-wider">Google Reviews</div>
              <div class="flex items-center justify-center gap-1">
                <svg class="w-4 h-4 text-amber-400 fill-current" viewBox="0 0 20 20">
                  <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                </svg>
                <span class="text-sm text-gray-300 font-semibold">{googleAvg}</span>
              </div>
              <div class="!mt-6 inline-flex items-center justify-center gap-2 text-xs text-amber-400 bg-gray-800/50 border border-gray-700/70 rounded-full px-4 py-2 group-hover:bg-amber-400/10 group-hover:border-amber-400/30 transition-colors">
                <span>Leave a Review</span>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
              </div>
            </div>
          </a>

          <!-- TripAdvisor Reviews Card -->
          <a 
            href="https://cloud.umami.is/q/WfxhdN5aF"
            target="_blank"
            rel="noopener noreferrer"
            class="group w-64 text-center bg-gray-900/50 backdrop-blur-xl border border-gray-800 hover:border-amber-400/50 rounded-2xl p-8 transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl hover:shadow-black/20"
          >
            <div class="space-y-4">
              <div class="text-5xl font-bold text-amber-400 group-hover:text-amber-300 transition-colors">{tripadvisorCount}</div>
              <div class="text-sm text-gray-400 uppercase tracking-wider">TripAdvisor Reviews</div>
              <div class="flex items-center justify-center gap-1">
                <svg class="w-4 h-4 text-amber-400 fill-current" viewBox="0 0 20 20">
                  <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                </svg>
                <span class="text-sm text-gray-300 font-semibold">{taAvg}</span>
              </div>
              <div class="!mt-6 inline-flex items-center justify-center gap-2 text-xs text-amber-400 bg-gray-800/50 border border-gray-700/70 rounded-full px-4 py-2 group-hover:bg-amber-400/10 group-hover:border-amber-400/30 transition-colors">
                <span>Leave a Review</span>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
              </div>
            </div>
          </a>
          
        </div>
      </div>
    </section>

    <!-- Reviews Grid -->
    <section class="py-20 bg-gray-950">
      <div class="max-w-7xl mx-auto px-6">
        
        <div id="reviews-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          {reviews?.map((review) => (
            <article class="review-card group relative bg-gradient-to-br from-gray-900/50 to-gray-800/50 backdrop-blur-xl border border-gray-700 rounded-3xl overflow-hidden transition-all duration-700 hover:border-amber-400/30 hover:-translate-y-2 hover:shadow-2xl hover:shadow-black/20">
              <div class="p-8">
                
                <!-- Header: Photo + Name -->
                <div class="flex items-center gap-4 mb-6">
                  {review.reviewer_photo_url ? (
                    <img 
                      src={review.reviewer_photo_url}
                      alt={review.reviewer_name || 'Guest'}
                      class="w-14 h-14 rounded-full object-cover border-2 border-gray-600 group-hover:border-amber-400/50 transition-colors duration-500"
                      loading="lazy"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                  ) : null}
                  <div class={`w-14 h-14 rounded-full bg-gray-700 items-center justify-center border-2 border-gray-600 group-hover:border-amber-400/50 transition-colors duration-500 ${review.reviewer_photo_url ? 'hidden' : 'flex'}`}>
                    <span class="text-2xl font-semibold text-gray-400 uppercase">{review.reviewer_name?.charAt(0).toUpperCase() || 'G'}</span>
                  </div>
                  
                  <div class="flex-1">
                    <div class="font-semibold text-lg text-white mb-1">
                      {review.reviewer_name || 'Anonymous Guest'}
                    </div>
                    {review.reviewer_location && (
                      <div class="text-sm text-gray-400">{review.reviewer_location}</div>
                    )}
                  </div>
                </div>

                <!-- Rating Stars -->
                <div class="flex gap-1 mb-4">
                  {[...Array(5)].map((_, i) => (
                    <svg
                      key={i}
                      class={`w-5 h-5 ${i < (review.rating || 0) ? 'text-amber-400 fill-current' : 'text-gray-600'}`}
                      viewBox="0 0 20 20"
                    >
                      <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                    </svg>
                  ))}
                </div>

                <!-- Review Title (TripAdvisor) -->
                {review.review_title && (
                  <h3 class="font-serif text-xl text-amber-400 mb-3 group-hover:text-amber-300 transition-colors duration-300">
                    {review.review_title}
                  </h3>
                )}

                <!-- Review Text -->
                <blockquote class="text-gray-300 leading-relaxed mb-6 group-hover:text-gray-200 transition-colors duration-500">
                  {review.review_text?.slice(0, 280)}{review.review_text?.length > 280 ? '...' : ''}
                </blockquote>

                <!-- Footer: Date + Source Link -->
                <div class="flex items-center justify-between pt-4 border-t border-gray-700/50 group-hover:border-amber-400/20 transition-colors duration-500">
                  <div class="text-xs text-gray-500 group-hover:text-gray-400 transition-colors duration-300">
                    {review.published_date ? new Date(review.published_date).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }) : 'Recent'}
                  </div>
                  
                  {review.review_url && (
                    <a 
                      href={review.review_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-xs text-gray-500 uppercase tracking-wider hover:text-amber-400 transition-colors duration-300 flex items-center gap-1"
                    >
                      <span>{review.source === 'google' ? 'Google' : 'TripAdvisor'}</span>
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                      </svg>
                    </a>
                  )}
                </div>

                <!-- Hover Glow Effect -->
                <div class="absolute inset-0 rounded-3xl bg-gradient-to-br from-amber-400/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none"></div>
              </div>
            </article>
          ))}
        </div>

        <!-- Load More Button -->
        {totalQualityReviews > REVIEWS_PER_LOAD && (
          <div class="text-center mt-16">
            <button
              id="load-more-btn"
              data-per-load={REVIEWS_PER_LOAD}
              data-total={totalQualityReviews}
              data-initial-count={REVIEWS_PER_LOAD}
              class="group inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-amber-400 to-amber-600 hover:from-amber-500 hover:to-amber-700 text-gray-900 font-semibold rounded-full transition-all duration-300 hover:scale-105 hover:shadow-2xl hover:shadow-amber-400/20"
            >
              <span id="btn-text">Load {REVIEWS_PER_LOAD} More Reviews</span>
              <svg class="w-5 h-5 transition-transform duration-300 group-hover:translate-y-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </button>
          </div>
        )}
      </div>
    </section>

    <!-- CTA Section -->
    <section class="py-32 bg-gray-0">
      <div class="max-w-4xl mx-auto px-6 text-center">
        <h2 class="font-serif text-4xl md:text-6xl text-white mb-8">
          Experience It Yourself
        </h2>
        <p class="text-xl text-gray-300 font-light leading-relaxed mb-12 max-w-3xl mx-auto">
          See what our guests mean. Enquire now to learn more about your stay at Limban.
        </p>
        <div class="flex flex-col sm:flex-row gap-6 justify-center">
          <a href="/reserve" title="Book your stay at Limban Resort" class="cta-filled">
            Reserve Your Stay
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </a>
          <a href="/rooms" title="View accommodations" class="cta-outlined">
            View Rooms
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </a>
        </div>
      </div>
    </section>

  </main>
</Layout>

<script>
  const loadMoreBtn = document.getElementById('load-more-btn');
  const btnText = document.getElementById('btn-text');
  const reviewsContainer = document.getElementById('reviews-container');
  
if (loadMoreBtn && reviewsContainer && btnText) {
  const perLoad = parseInt(loadMoreBtn.dataset.perLoad || '9');
  const total = parseInt(loadMoreBtn.dataset.total || '0');
  const initialCount = parseInt(loadMoreBtn.dataset.initialCount || '9');
  let offset = initialCount;

  console.log('Initial setup:', { perLoad, total, initialCount, offset }); // DEBUG

  loadMoreBtn.addEventListener('click', async () => {
    console.log('Before fetch - offset:', offset); // DEBUG
    
    btnText.textContent = 'Loading...';
    loadMoreBtn.disabled = true;

    try {

      const response = await fetch('/api/load-more-reviews', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ offset, limit: perLoad }),
        cache: 'no-store'
      });


      const data = await response.json();
      
      console.log('Received reviews:', data.reviews?.length); // DEBUG

      if (data.reviews && data.reviews.length > 0) {
        data.reviews.forEach(review => {
          const reviewCard = createReviewCard(review);
          reviewsContainer.insertAdjacentHTML('beforeend', reviewCard);
        });

        offset += data.reviews.length;
        console.log('After increment - offset:', offset); // DEBUG
        
        const remaining = total - offset;

        if (remaining > 0) {
          const nextLoad = Math.min(remaining, perLoad);
          btnText.textContent = `Load ${nextLoad} More Reviews`;
          loadMoreBtn.disabled = false;
        } else {
          loadMoreBtn.style.display = 'none';
        }
      } else {
        loadMoreBtn.style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading reviews:', error);
      btnText.textContent = 'Error - Try Again';
      loadMoreBtn.disabled = false;
    }
  });
}

  function createReviewCard(review) {
    const stars = Array(5).fill(0).map((_, i) => 
      `<svg class="w-5 h-5 ${i < review.rating ? 'text-amber-400 fill-current' : 'text-gray-600'}" viewBox="0 0 20 20">
        <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
      </svg>`
    ).join('');

    const publishedDate = review.published_date 
      ? new Date(review.published_date).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' })
      : 'Recent';

    return `
      <article class="review-card group relative bg-gradient-to-br from-gray-900/50 to-gray-800/50 backdrop-blur-xl border border-gray-700 rounded-3xl overflow-hidden transition-all duration-700 hover:border-amber-400/30 hover:-translate-y-2 hover:shadow-2xl hover:shadow-black/20">
        <div class="p-8">
          <div class="flex items-center gap-4 mb-6">
            ${review.reviewer_photo_url 
              ? `<img src="${review.reviewer_photo_url}" alt="${review.reviewer_name || 'Guest'}" class="w-14 h-14 rounded-full object-cover border-2 border-gray-600 group-hover:border-amber-400/50 transition-colors duration-500" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />` 
              : ''
            }
            <div class="w-14 h-14 rounded-full bg-gray-700 ${review.reviewer_photo_url ? 'hidden' : 'flex'} items-center justify-center border-2 border-gray-600 group-hover:border-amber-400/50 transition-colors duration-500">
              <span class="text-2xl font-semibold text-gray-400 uppercase">${(review.reviewer_name?.charAt(0) || 'G').toUpperCase()}</span>
            </div>
            <div class="flex-1">
              <div class="font-semibold text-lg text-white mb-1">${review.reviewer_name || 'Anonymous Guest'}</div>
              ${review.reviewer_location ? `<div class="text-sm text-gray-400">${review.reviewer_location}</div>` : ''}
            </div>
          </div>
          <div class="flex gap-1 mb-4">${stars}</div>
          ${review.review_title ? `<h3 class="font-serif text-xl text-amber-400 mb-3 group-hover:text-amber-300 transition-colors duration-300">${review.review_title}</h3>` : ''}
          <blockquote class="text-gray-300 leading-relaxed mb-6 group-hover:text-gray-200 transition-colors duration-500">
            ${review.review_text?.slice(0, 280)}${review.review_text?.length > 280 ? '...' : ''}
          </blockquote>
          <div class="flex items-center justify-between pt-4 border-t border-gray-700/50 group-hover:border-amber-400/20 transition-colors duration-500">
            <div class="text-xs text-gray-500 group-hover:text-gray-400 transition-colors duration-300">${publishedDate}</div>
            ${review.review_url ? `<a href="${review.review_url}" target="_blank" rel="noopener noreferrer" class="text-xs text-gray-500 uppercase tracking-wider hover:text-amber-400 transition-colors duration-300 flex items-center gap-1">
              <span>${review.source === 'google' ? 'Google' : 'TripAdvisor'}</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
              </svg>
            </a>` : `<div class="text-xs text-gray-500 uppercase tracking-wider">${review.source === 'google' ? 'Google' : 'TripAdvisor'}</div>`}
          </div>
          <div class="absolute inset-0 rounded-3xl bg-gradient-to-br from-amber-400/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none"></div>
        </div>
      </article>
    `;
  }
</script>
