---
import Layout from '../../layouts/Layout.astro';
import { AstroSEO } from 'astro-seo-plugin';
import { fetchDiningExperienceBySlug, fetchDiningExperiencesData, fetchSpecialDealData } from '../../api.js';
import GalleryGrid from '../../components/GalleryGrid.astro';
import DiningReservationForm from '../../components/DiningReservationForm.astro';

// Server-side data fetching
let data = {
  experiences: [],
  specialDeal: null
};

let error = null;

try {
  const [experiences, specialDeal] = await Promise.all([
    fetchDiningExperiencesData(),
    fetchSpecialDealData()
  ]);
  data = { experiences, specialDeal };
} catch (err) {
  console.error('Failed to load dining experiences data:', err);
  error = 'Failed to load content from Hygraph';
}

export async function getStaticPaths() {
  const experiences = await fetchDiningExperiencesData();
  return experiences.map((experience) => ({
    params: { slug: experience.url },
    props: { experienceData: experience },
  }));
}

const { slug } = Astro.params;
const experience = await fetchDiningExperienceBySlug(slug);

if (!experience) {
  return Astro.redirect('/dining');
}

// Process gallery images for popup slider
const galleryImages = experience.images?.map((item, index) => ({
  src: item.thumb800 || item.url,
  srcset: `${item.thumb400} 400w, ${item.thumb800} 800w`,
  large: item.large || item.url,
  placeholder: item.placeholder || item.url,
  alt: `${experience.restaurantName} - Gallery image ${index + 1}`,
  width: item.width,
  height: item.height,
})) || [];

// Helper function for alt text generation
function generateAltText(experienceName, shortIntro) {
  if (!experienceName) return "Dining experience at Limban Resort";
  const baseDescription = shortIntro?.split('.')[0] || "dining experience";
  return `${experienceName} - ${baseDescription} at Limban Resort, Tadoba`;
}
---

<link rel="preload" as="image" href={experience.images?.[0]?.heroImage || experience.images?.[0]?.url} />
<meta name="theme-color" content="#1f2937" />
<meta name="msapplication-TileColor" content="#1f2937" />

<Layout title={`${experience.restaurantName} - Limban Resort`}>
  <AstroSEO
    title={`${experience.restaurantName} | Dining Experience - Limban Resort`}
    description={`Experience authentic dining at ${experience.restaurantName} - ${experience.shortIntro} Discover flavors that connect you to the heart of Tadoba National Park.`}
    canonical={`https://limban.com/dining/${slug}`}
    openGraph={{
      title: `${experience.restaurantName} - Dining Experience at Limban Resort`,
      description: `${experience.shortIntro} Experience authentic flavors and intimate dining in the wilderness of Tadoba National Park.`,
      image: experience.images?.[0]?.heroImage || '/img/default-dining.jpg',
      type: 'article',
      url: `https://limban.com/dining/${slug}`
    }}
    jsonLd={{
      "@context": "https://schema.org",
      "@type": "Restaurant",
      "@id": `https://limban.com/dining/${slug}#restaurant`,
      "name": experience.restaurantName,
      "description": experience.shortIntro,
      "url": `https://limban.com/dining/${slug}`,
      "image": [
        experience.images?.[0]?.heroImage,
        ...galleryImages.slice(0, 6).map(img => img.large || img.thumbnail)
      ].filter(Boolean),
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "Survey No. 306, Village Mudholi, Taluka Bhadravati",
        "addressLocality": "Chandrapur",
        "addressRegion": "Maharashtra", 
        "postalCode": "442906",
        "addressCountry": "IN"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": "20.25602486093492",
        "longitude": "79.2847888101826"
      },
      "telephone": "+91 90226 80451",
      "email": "info@limban.com",
      "servesCuisine": "Indian",
      "priceRange": "₹₹₹",
      "acceptsReservations": true,
      "hasMenu": true,
      "menuStyle": "Fresh, Local, Seasonal",
      "isPartOf": {
        "@type": "Resort",
        "name": "Limban Resort",
        "url": "https://limban.com"
      },
      "amenityFeature": [
        {
          "@type": "LocationFeatureSpecification",
          "name": "Local Ingredients",
          "value": true
        },
        {
          "@type": "LocationFeatureSpecification", 
          "name": "Outdoor Dining",
          "value": true
        },
        {
          "@type": "LocationFeatureSpecification",
          "name": "Bush Dining Experience",
          "value": true
        }
      ]
    }}
    additionalMetaTags={[
      { name: "robots", content: "index, follow" },
      { name: "keywords", content: `${experience.restaurantName}, Tadoba dining, safari resort restaurant, local cuisine Maharashtra` },
      { name: "geo.region", content: "IN-MH" },
      { name: "geo.placename", content: "Tadoba National Park" },
      { name: "geo.position", content: "20.25602486093492;79.2847888101826" },
      { name: "ICBM", content: "20.25602486093492, 79.2847888101826" }
    ]}
    additionalLinkTags={[
      { rel: "apple-touch-icon", sizes: "180x180", href: "/apple-touch-icon.png" },
      { rel: "icon", type: "image/png", sizes: "32x32", href: "/favicon-32x32.png" },
      { rel: "icon", type: "image/png", sizes: "16x16", href: "/favicon-16x16.png" },
      { rel: "manifest", href: "/site.webmanifest" },
      { rel: "shortcut icon", href: "/favicon.ico" }
    ]}
  />

  <div class="bg-gray-950 text-gray-100 font-sans antialiased selection:bg-gray-700">
    
    <!-- Hero Section -->
    <section class="relative pt-36 pb-16 overflow-hidden bg-gray-900">
      <!-- Background Image Layer -->
      <div 
        class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-40"
        style={`background-image: url(${experience.images?.[0]?.heroImage || experience.images?.[0]?.url});`}
      ></div>
      
      <!-- Gradient Overlay for Better Text Contrast -->
      <div class="absolute inset-0 bg-gradient-to-b from-gray-900/80 via-gray-900/50 to-gray-900/80"></div>
      
      <!-- Content -->
      <div class="relative z-10 max-w-7xl mx-auto px-6">
        <div class="text-center mb-12">
          <div class="text-sm text-gray-300 tracking-[0.2em] uppercase mb-4">
            Authentic Dining Experience
          </div>
          <h1 class="font-serif italic text-4xl md:text-6xl text-white mb-6 drop-shadow-lg">
            {experience.restaurantName}
          </h1>
          <p class="text-xl text-gray-200 max-w-3xl mx-auto leading-relaxed drop-shadow-sm">
            {experience.shortIntro}
          </p>
          
          <!-- Special Deal Section -->
          {data.specialDeal && data.specialDeal.html && (
              <div class="max-w-3xl mx-auto px-6 mt-12">
                <div class="bg-purple-900/50 border border-purple-300 rounded-xl p-6 text-center shadow-lg">
                  <div class="font-semibold text-base text-white max-w-none" set:html={data.specialDeal.html} />
                </div>
              </div>
          )}
        </div>
      </div>
    </section>
    
    <!-- Breadcrumbs -->
    <section class="py-6 bg-gray-900/50 border-b border-gray-800">
      <div class="max-w-7xl mx-auto px-6">
        <nav class="flex items-center justify-center space-x-2 text-sm" aria-label="Breadcrumb">
          <script type="application/ld+json">
            {
              "@context": "https://schema.org",
              "@type": "BreadcrumbList",
              "itemListElement": [
                {
                  "@type": "ListItem",
                  "position": 1,
                  "name": "Home",
                  "item": "https://limban.com/"
                },
                {
                  "@type": "ListItem",
                  "position": 2,
                  "name": "Dining Experiences",
                  "item": "https://limban.com/dining"
                },
                {
                  "@type": "ListItem",
                  "position": 3,
                  "name": "${experience.restaurantName}",
                  "item": "https://limban.com/dining/${slug}"
                }
              ]
            }
          </script>
          <a 
            href="/" 
            class="text-gray-400 hover:text-amber-400 transition-colors duration-300 flex items-center"
          >
            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
            </svg>
            Home
          </a>
          <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
          </svg>
          <a 
            href="/dining" 
            class="text-gray-400 hover:text-amber-400 transition-colors duration-300"
          >
            Dining Experiences
          </a>
          <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
          </svg>
          <span class="text-amber-400 font-medium">{experience.restaurantName}</span>
        </nav>
      </div>
    </section>
    
    <!-- Gallery Section with Popup Slider -->
    <section class="py-32 bg-gray-800">
      <div class="max-w-7xl mx-auto px-6">
        <div class="text-center mb-12">
          <h2 class="font-serif italic text-4xl md:text-6xl text-white mb-6">
            {experience.restaurantName} Gallery
          </h2>
          <p class="text-gray-300">
            Discover the atmosphere and flavors of our dining experience
          </p>
        </div>
        
        <!-- Gallery Grid -->
        <GalleryGrid images={galleryImages} layout="grid" />
      </div>
    </section>

    <!-- Dining Experience Details Section -->
    <section class="py-16 bg-gray-900">
      <div class="max-w-7xl mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start">
          
          <!-- Left Column - Experience Description -->
          <div class="space-y-8">
            <div>
              <h2 class="font-serif italic text-3xl md:text-4xl text-white mb-6">
                A Taste of the Wild
              </h2>
              <p class="text-lg text-gray-300 leading-relaxed mb-6">
                {experience.shortIntro}
              </p>
              {experience.longDescription && (
                <div class="text-gray-300 leading-relaxed prose prose-invert max-w-none">
                  <p>{experience.longDescription}</p>
                </div>
              )}
            </div>

            <!-- Dining Philosophy -->
            <div>
              <h3 class="font-serif italic text-3xl text-white mb-6">
                Our Philosophy
              </h3>
              <p class="text-gray-300 mb-8">
                Fresh. Local. Authentic. Every dish tells the story of Tadoba's wilderness.
              </p>

              <!-- Special Features Cards -->
              <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                <div class="group relative p-5 bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-xl border border-gray-700 rounded-2xl hover:border-gray-500 transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl hover:shadow-black/20 flex flex-col items-center text-center">
                  <div class="mb-4 w-12 h-12 flex items-center justify-center bg-gradient-to-br from-green-700/20 to-green-500/20 rounded-xl group-hover:from-amber-400/30 group-hover:to-orange-400/30 transition-all duration-300">
                    <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                    </svg>
                  </div>
                  <h4 class="text-xs font-light text-gray-300 group-hover:text-amber-100 transition-colors duration-300">
                    Local Ingredients
                  </h4>
                </div>

                <div class="group relative p-5 bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-xl border border-gray-700 rounded-2xl hover:border-gray-500 transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl hover:shadow-black/20 flex flex-col items-center text-center">
                  <div class="mb-4 w-12 h-12 flex items-center justify-center bg-gradient-to-br from-orange-700/20 to-orange-500/20 rounded-xl group-hover:from-amber-400/30 group-hover:to-orange-400/30 transition-all duration-300">
                    <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
                    </svg>
                  </div>
                  <h4 class="text-xs font-light text-gray-300 group-hover:text-amber-100 transition-colors duration-300">
                    Cooked to Order
                  </h4>
                </div>

                <div class="group relative p-5 bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-xl border border-gray-700 rounded-2xl hover:border-gray-500 transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl hover:shadow-black/20 flex flex-col items-center text-center">
                  <div class="mb-4 w-12 h-12 flex items-center justify-center bg-gradient-to-br from-purple-700/20 to-purple-500/20 rounded-xl group-hover:from-amber-400/30 group-hover:to-orange-400/30 transition-all duration-300">
                    <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                  </div>
                  <h4 class="text-xs font-light text-gray-300 group-hover:text-amber-100 transition-colors duration-300">
                    Personal Touch
                  </h4>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column - Reservation Form -->
          <div class="space-y-8">
            <DiningReservationForm itemName={experience.restaurantName} itemSlug={slug} />
          </div>
        </div>
      </div>
    </section>

    <!-- Other Dining Experiences Section -->
    <section class="py-20 bg-gray-950 border-t border-gray-800">
      <div class="max-w-7xl mx-auto px-6">
        <div class="text-center mb-12">
          <h2 class="font-serif italic text-3xl md:text-4xl text-white mb-4">
            Explore Other Dining Experiences
          </h2>
          <p class="text-gray-400 text-lg">
            Each venue offers its own unique flavors and atmosphere
          </p>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
          {data.experiences
            .filter(otherExp => otherExp.url !== slug)
            .map((otherExp) => {
              const otherSlug = otherExp.url;
              return (
                <a 
                  href={`/dining/${otherSlug}`}
                  class="group relative aspect-[4/5] overflow-hidden rounded-xl border border-gray-800 hover:border-amber-400/50 transition-all duration-500 hover:scale-105 hover:shadow-xl hover:shadow-black/20"
                >
                  <!-- Background Image -->
                  <div 
                    class="absolute inset-0 bg-cover bg-center bg-no-repeat group-hover:scale-110 transition-transform duration-700"
                    style={`background-image: url(${otherExp.images?.[0]?.heroImage || otherExp.images?.[0]?.url});`}
                  ></div>
                  
                  <!-- Gradient Overlay -->
                  <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/30 to-transparent group-hover:from-black/70 transition-all duration-500"></div>
                  
                  <!-- Content Overlay -->
                  <div class="absolute inset-0 flex flex-col justify-end p-4">
                    <h3 class="font-serif italic text-lg md:text-xl text-white mb-1 group-hover:text-amber-400 transition-colors duration-300 line-clamp-2">
                      {otherExp.restaurantName}
                    </h3>
                    <p class="text-gray-300 text-xs md:text-sm group-hover:text-gray-100 transition-colors duration-300 line-clamp-2">
                      {otherExp.shortIntro}
                    </p>
                  </div>
                  
                  <!-- Subtle Glow Effect -->
                  <div class="absolute inset-0 rounded-xl bg-gradient-to-br from-amber-500/0 to-orange-500/0 group-hover:from-amber-500/10 group-hover:to-orange-500/10 transition-all duration-500"></div>
                </a>
              );
            })
          }
        </div>
      </div>
    </section>
  </div>
</Layout>

<script define:vars={{ galleryImages }}>
  // Dispatch event to open the global gallery modal
  document.querySelectorAll('[data-gallery-index]').forEach(el => {
    el.addEventListener('click', () => {
      const index = parseInt(el.dataset.galleryIndex, 10);
      const openGalleryEvent = new CustomEvent('open-gallery', {
        detail: {
          images: galleryImages,
          index: index,
        },
      });
      document.dispatchEvent(openGalleryEvent);
    });
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
