---
import Layout from "../../layouts/Layout.astro";
import { AstroSEO } from "astro-seo-plugin";
import {
  fetchDiningExperienceBySlug,
  fetchDiningExperiencesData,
  fetchSpecialDealData,
} from "../../api.js";
import GalleryGrid from "../../components/GalleryGrid.astro";
import LoadMoreGallery from "../../components/LoadMoreGallery.astro";
import DiningReservationForm from "../../components/DiningReservationForm.astro";

// Ultra-reliable API fetching with retry logic
async function fetchWithRetry(fetchFn, retries = 2) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fetchFn();
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise((resolve) => setTimeout(resolve, 1000));
    }
  }
}

// Server-side data fetching with enhanced error handling
let data = {
  experiences: [],
  specialDeal: null,
};

let error = null;

try {
  const [experiences, specialDeal] = await Promise.all([
    fetchWithRetry(() => fetchDiningExperiencesData()),
    fetchWithRetry(() => fetchSpecialDealData()),
  ]);
  data = { experiences, specialDeal };
} catch (err) {
  console.error("Failed to load dining experiences data:", err);
  error = "Failed to load content from Hygraph";
}

export async function getStaticPaths() {
  try {
    const experiences = await fetchDiningExperiencesData();
    return experiences.map((experience) => ({
      params: { slug: experience.url },
      props: { experienceData: experience },
    }));
  } catch (err) {
    console.error("Failed to generate static paths:", err);
    return [];
  }
}

const { slug } = Astro.params;
const experience = await fetchWithRetry(() =>
  fetchDiningExperienceBySlug(slug)
);

if (!experience) {
  return Astro.redirect("/dining");
}

// Simple gallery processing - EXACTLY like rooms page
function processDiningImages(images) {
  if (!images?.length) return [];

  return images.map((item, idx) => ({
    src: item.grid || item.url || "",
    srcset: `${item.grid || ""} 300w, ${item.thumb400 || ""} 400w`,
    placeholder: item.placeholder || item.url || "",
    large: item.large || item.url || "",
    alt: `${experience.restaurantName} - dining experience view ${idx + 1}`,
    width: item.width || 300,
    height: item.height || 300,
  }));
}

// Process dining gallery consistently (EXACTLY like rooms)
const allDiningImages = processDiningImages(experience.images || []);

// Split for load more functionality (EXACTLY like rooms)
const initialDiningImages = allDiningImages.slice(0, 12);
const remainingDiningImages = allDiningImages.slice(12);

// Helper function for alt text generation
function generateAltText(experienceName, shortIntro) {
  if (!experienceName) return "Dining experience at Limban Resort";
  const baseDescription = shortIntro?.split(".")[0] || "dining experience";
  return `${experienceName} - ${baseDescription} at Limban Resort, Tadoba`;
}
---

<!-- Performance optimization: preload critical hero image -->
<link
  rel="preload"
  as="image"
  href={allDiningImages[0]?.src ||
    experience.images?.[0]?.url ||
    "/img/default-dining.jpg"}
  fetchpriority="high"
/>

<Layout title={`${experience.restaurantName} - Limban Resort`}>
  <AstroSEO
    slot="head"
    title={`${experience.restaurantName} | Dining Experience - Limban Resort`}
    description={`Experience authentic dining at ${experience.restaurantName} - ${experience.shortIntro} Discover flavors that connect you to the heart of Tadoba National Park.`}
    canonical={`https://limban.com/dining/${slug}`}
    openGraph={{
      title: `${experience.restaurantName} - Dining Experience at Limban Resort`,
      description: `${experience.shortIntro} Experience authentic flavors and intimate dining in the wilderness of Tadoba National Park.`,
      image:
        allDiningImages[0]?.src ||
        experience.images?.[0]?.url ||
        "/img/default-dining.jpg",
      type: "article",
      url: `https://limban.com/dining/${slug}`,
    }}
    jsonLd={{
      "@context": "https://schema.org",
      "@type": "Restaurant",
      "@id": `https://limban.com/dining/${slug}#restaurant`,
      name: experience.restaurantName,
      alternateName: `${experience.restaurantName} at Limban Resort`,
      description: `${experience.shortIntro} Located in the heart of Tadoba National Park, offering an intimate dining experience that celebrates local flavors and sustainable cuisine.`,
      url: `https://limban.com/dining/${slug}`,
      sameAs: [
        "https://www.tripadvisor.in/Hotel_Review-g10594630-d12902646-Reviews-Limban_Resort-Chandrapur_District_Maharashtra.html",
        "https://www.instagram.com/limbanresorts/",
        "https://www.facebook.com/limbanresortstadoba/",
      ],
      image: [
        allDiningImages[0]?.large || allDiningImages[0]?.src,
        ...allDiningImages.slice(1, 8).map((img) => img.large || img.src),
      ].filter(Boolean),
      logo: "https://limban.com/limban-logo.png",
      address: {
        "@type": "PostalAddress",
        streetAddress: "Survey No. 306, Village Mudholi, Taluka Bhadravati",
        addressLocality: "Chandrapur",
        addressRegion: "Maharashtra",
        postalCode: "442906",
        addressCountry: "IN",
      },
      geo: {
        "@type": "GeoCoordinates",
        latitude: 20.25602486093492,
        longitude: 79.2847888101826,
      },
      contactPoint: [
        {
          "@type": "ContactPoint",
          telephone: "+91 90226 80451",
          contactType: "reservations",
          availableLanguage: ["English", "Hindi"],
        },
        {
          "@type": "ContactPoint",
          email: "dining@limban.com",
          contactType: "customer service",
        },
      ],
      servesCuisine: [
        "Indian Cuisine",
        "Local Maharashtrian",
        "Farm-to-Table",
        "Sustainable Cuisine",
        "Continental",
      ],
      priceRange: "₹₹₹",
      currenciesAccepted: "INR",
      paymentAccepted: ["Cash", "Credit Card", "Debit Card", "UPI"],
      acceptsReservations: true,
      reservationPolicy: "Advance booking recommended",
      hasMenu: true,
      menu: {
        "@type": "Menu",
        name: `${experience.restaurantName} Menu`,
        description:
          "Fresh, locally-sourced ingredients crafted into memorable dining experiences",
        menuAddOn: "Wine pairing available",
        offers: {
          "@type": "Offer",
          availability: "https://schema.org/InStock",
          availableAtOrFrom: experience.restaurantName,
        },
      },
      openingHours: [
        "Mo-Su 07:00-10:30", // Breakfast
        "Mo-Su 12:30-15:00", // Lunch
        "Mo-Su 19:30-22:30", // Dinner
      ],
      specialOpeningHoursSpecification: {
        "@type": "OpeningHoursSpecification",
        dayOfWeek: [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
          "Sunday",
        ],
        opens: "19:30",
        closes: "22:30",
        validFrom: new Date().toISOString().split("T")[0],
        description: "Evening dining experience under the stars",
      },
      amenityFeature: [
        {
          "@type": "LocationFeatureSpecification",
          name: "Outdoor Dining",
          value: true,
        },
        {
          "@type": "LocationFeatureSpecification",
          name: "Wildlife Viewing During Meals",
          value: true,
        },
        {
          "@type": "LocationFeatureSpecification",
          name: "Private Dining Options",
          value: true,
        },
        {
          "@type": "LocationFeatureSpecification",
          name: "Sustainable Local Sourcing",
          value: true,
        },
        {
          "@type": "LocationFeatureSpecification",
          name: "Wine Selection",
          value: true,
        },
        {
          "@type": "LocationFeatureSpecification",
          name: "Vegetarian Options",
          value: true,
        },
        {
          "@type": "LocationFeatureSpecification",
          name: "Vegan Options",
          value: true,
        },
      ],
      isPartOf: {
        "@type": "LodgingBusiness",
        name: "Limban Resort",
        url: "https://limban.com",
        description: "Luxury safari resort in Tadoba National Park",
        "@id": "https://limban.com/#resort",
      },
      containedInPlace: {
        "@type": "TouristDestination",
        name: "Tadoba Andhari Tiger Reserve",
        address: {
          "@type": "PostalAddress",
          addressLocality: "Tadoba",
          addressRegion: "Maharashtra",
          addressCountry: "IN",
        },
      },
      audience: {
        "@type": "Audience",
        audienceType: [
          "Luxury Travelers",
          "Wildlife Enthusiasts",
          "Food Connoisseurs",
          "Eco-Conscious Diners",
          "Resort Guests",
        ],
      },
      knowsAbout: [
        "Sustainable Dining",
        "Local Ingredients",
        "Maharashtrian Cuisine",
        "Farm-to-Table Cooking",
        "Wine Pairing",
        "Dietary Accommodations",
      ],
      additionalProperty: [
        {
          "@type": "PropertyValue",
          name: "Dining Style",
          value: "Fine Casual",
        },
        {
          "@type": "PropertyValue",
          name: "Setting",
          value: "Safari Lodge",
        },
        {
          "@type": "PropertyValue",
          name: "Atmosphere",
          value: "Intimate Wilderness Dining",
        },
        {
          "@type": "PropertyValue",
          name: "Capacity",
          value: "24 guests maximum",
        },
      ],
      makesOffer: [
        {
          "@type": "Offer",
          itemOffered: {
            "@type": "Service",
            name: "Dining Experience",
            description: experience.shortIntro,
          },
          availability: "https://schema.org/InStock",
          availableAtOrFrom: {
            "@type": "Place",
            name: "Limban Resort",
          },
          priceSpecification: {
            "@type": "PriceSpecification",
            priceCurrency: "INR",
            eligibleQuantity: {
              "@type": "QuantitativeValue",
              minValue: 1,
              unitText: "person",
            },
          },
        },
        {
          "@type": "Offer",
          itemOffered: {
            "@type": "Service",
            name: "Private Dining",
            description: "Exclusive dining experiences for special occasions",
          },
          availability: "https://schema.org/PreOrder",
        },
      ],
      potentialAction: [
        {
          "@type": "ReserveAction",
          target: {
            "@type": "EntryPoint",
            urlTemplate: `https://limban.com/dining/${slug}#reservation`,
            actionPlatform: [
              "https://schema.org/DesktopWebPlatform",
              "https://schema.org/MobileWebPlatform",
            ],
          },
          name: "Make Dining Reservation",
        },
        {
          "@type": "ViewAction",
          target: `https://limban.com/dining/${slug}`,
          name: "View Dining Experience Details",
        },
      ],
      hasOfferCatalog: {
        "@type": "OfferCatalog",
        name: "Dining Experiences at Limban",
        itemListElement: [
          {
            "@type": "Offer",
            itemOffered: {
              "@type": "FoodEvent",
              name: "Wilderness Breakfast",
              description: "Dawn dining experience with wildlife viewing",
            },
          },
          {
            "@type": "Offer",
            itemOffered: {
              "@type": "FoodEvent",
              name: "Candlelit Bush Dinner",
              description: "Romantic evening dining under the stars",
            },
          },
        ],
      },
      provider: {
        "@type": "Organization",
        name: "Limban Resort",
        url: "https://limban.com",
        logo: "https://limban.com/limban-logo.jpg",
      },
      publisher: {
        "@type": "Organization",
        name: "Limban Resort",
        url: "https://limban.com",
      },
    }}
  />

  <div
    class="bg-gray-950 text-gray-100 font-sans antialiased selection:bg-gray-700"
  >
    <!-- Hero Section (EXACTLY like rooms) -->
    <section
      class="relative pt-36 pb-16 overflow-hidden bg-gray-900"
      role="banner"
      aria-labelledby="dining-hero-heading"
    >
      <!-- Simplified hero image - no complex transformations -->
      <img
        src={allDiningImages[0]?.src ||
          experience.images?.[0]?.url ||
          "/img/default-dining.jpg"}
        alt={`${experience.restaurantName} hero - authentic dining experience`}
        class="absolute inset-0 w-full h-full object-cover opacity-40"
        loading="eager"
        decoding="async"
        fetchpriority="high"
      />

      <!-- Enhanced gradient overlay for better text contrast -->
      <div
        class="absolute inset-0 bg-gradient-to-b from-gray-900/90 via-gray-900/60 to-gray-900/90"
      >
      </div>

      <!-- Hero content with improved accessibility -->
      <main
        id="main-content"
        class="relative z-10 max-w-7xl mx-auto px-6"
        role="main"
      >
        <div class="text-center mb-12">
          <div
            class="text-sm text-gray-300 tracking-[0.2em] uppercase mb-4"
            role="doc-subtitle"
          >
            Authentic Dining Experience
          </div>
          <h1
            id="dining-hero-heading"
            class="font-serif italic text-4xl md:text-6xl text-white mb-6 drop-shadow-lg"
          >
            {experience.restaurantName}
          </h1>
          <p
            class="text-xl text-gray-200 max-w-3xl mx-auto leading-relaxed drop-shadow-sm"
          >
            {experience.shortIntro}
          </p>

          <!-- Special Deal Section -->
          {
            data.specialDeal && data.specialDeal.html && (
              <div
                class="max-w-3xl mx-auto px-6 mt-12"
                role="complementary"
                aria-label="Special offer"
              >
                <div class="bg-gradient-to-r from-purple-900/60 to-amber-900/60 border border-purple-300/50 rounded-2xl p-8 text-center shadow-2xl backdrop-blur-xl">
                  <div
                    class="font-semibold text-lg text-white max-w-none prose prose-invert"
                    set:html={data.specialDeal.html}
                  />
                </div>
              </div>
            )
          }
        </div>
      </main>
    </section>

    <!-- Breadcrumbs (EXACTLY like rooms) -->
    <nav
      class="py-6 bg-gray-900/50 border-b border-gray-800"
      aria-label="Breadcrumb"
    >
      <div class="max-w-7xl mx-auto px-6">
        <ol class="flex items-center justify-center space-x-2 text-sm">
          <li>
            <a
              href="/"
              class="text-gray-400 hover:text-amber-400 transition-colors duration-300 flex items-center focus:outline-none focus:ring-2 focus:ring-amber-400/50 rounded"
            >
              <svg
                class="w-4 h-4 mr-1"
                fill="currentColor"
                viewBox="0 0 20 20"
                aria-hidden="true"
              >
                <path
                  d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
                ></path>
              </svg>
              Home
            </a>
          </li>
          <li aria-hidden="true">
            <svg
              class="w-4 h-4 text-gray-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                clip-rule="evenodd"></path>
            </svg>
          </li>
          <li>
            <a
              href="/dining"
              class="text-gray-400 hover:text-amber-400 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-amber-400/50 rounded"
            >
              Dining Experiences
            </a>
          </li>
          <li aria-hidden="true">
            <svg
              class="w-4 h-4 text-gray-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                clip-rule="evenodd"></path>
            </svg>
          </li>
          <li aria-current="page">
            <span class="text-amber-400 font-medium"
              >{experience.restaurantName}</span
            >
          </li>
        </ol>
      </div>
    </nav>

    <!-- Enhanced Gallery Section (EXACTLY like rooms) -->
    <section class="py-32 bg-gray-800" aria-labelledby="gallery-heading">
      <div class="max-w-7xl mx-auto px-6">
        <header class="text-center mb-16">
          <h2
            id="gallery-heading"
            class="font-serif italic text-4xl md:text-6xl text-white mb-6"
          >
            {experience.restaurantName} Gallery
          </h2>
          <p class="text-xl text-gray-300 max-w-2xl mx-auto">
            Discover the atmosphere and flavors of our dining experience
          </p>
        </header>

        <GalleryGrid
          images={initialDiningImages}
          layout="grid"
          galleryType="dining"
          gridId="dining-gallery-grid"
        />

        <LoadMoreGallery
          buttonId="load-more-dining"
          remainingImages={remainingDiningImages}
          initialImages={initialDiningImages}
          galleryType="dining"
          galleryGridId="dining-gallery-grid"
          layout="grid"
        />

        <div class="text-center mt-6">
          <p class="text-gray-400 font-light italic">
            Click any image to explore {experience.restaurantName} in detail
          </p>
        </div>
      </div>
    </section>

    <!-- Rest of your content sections... -->
  </div>
</Layout>

<!-- NO SCRIPT SECTIONS - Modal handled by GalleryGrid component just like rooms -->

<style>
  /* Same styles as rooms */
  .group img {
    transform-origin: center center;
    backface-visibility: hidden;
    will-change: transform;
  }

  @media (prefers-reduced-motion: reduce) {
    .transition-all,
    .transition-transform,
    .transition-colors,
    .group-hover\:scale-105,
    .group-hover\:scale-110,
    .hover\:-translate-y-3 {
      transition: none !important;
      transform: none !important;
    }
  }
</style>
