---
import { Icon } from 'astro-icon/components'
import Layout from "../../layouts/Layout.astro";
import { AstroSEO } from "astro-seo-plugin";
import {
  fetchDiningExperienceBySlug,
  fetchDiningExperiencesData,
} from "../../api.js";
import GalleryGrid from "../../components/GalleryGrid.astro";
import LoadMoreGallery from "../../components/LoadMoreGallery.astro";
import GalleryModal from "../../components/GalleryModal.astro";
import DiningReservationForm from "../../components/DiningReservationForm.astro";
import SmartReserveButton from "../../components/SmartReserveButton.astro";
import { processGalleryImage } from "../../components/imageProcessor.js";
import { getImage } from "astro:assets";

// Ultra-reliable API fetching with retry logic
async function fetchWithRetry(fetchFn, retries = 2) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fetchFn();
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise((resolve) => setTimeout(resolve, 1000));
    }
  }
}

// ðŸŽ¯ ENHANCED: Single image optimizer with better quality
async function optimizeImage(url, width, height, quality = 80) {
  if (!url) return null;
  try {
    const optimized = await getImage({
      src: url,
      width: width,
      height: height,
      format: "avif",
      quality: quality,
      fit: "cover",
      inferSize: true,
    });
    return optimized;
  } catch (error) {
    return { src: url };
  }
}

// Server-side data fetching
let data = { experiences: []};
let error = null;

try {
  const [experiences] = await Promise.all([
    fetchWithRetry(() => fetchDiningExperiencesData()),
    ]);
  data = { experiences };
} catch (err) {
  console.error("Failed to load dining experiences data:", err);
  error = "Failed to load content from Hygraph";
}

export async function getStaticPaths() {
  try {
    const experiences = await fetchDiningExperiencesData();
    return experiences.map((experience) => ({
      params: { slug: experience.url },
      props: { experienceData: experience },
    }));
  } catch (err) {
    console.error("Failed to generate static paths:", err);
    return [];
  }
}

const { slug } = Astro.params;
const experience = await fetchWithRetry(() => fetchDiningExperienceBySlug(slug));

if (!experience) {
  return Astro.redirect("/dining");
}

// ðŸŽ¯ ENHANCED: Process all images in parallel with higher quality
const [allDiningImages, optimizedHero, optimizedOtherExperiences] = await Promise.all([
  experience.images && experience.images.length > 0
    ? Promise.all(experience.images.map((item, index) => processGalleryImage(item, index)))
    : Promise.resolve([]),

  // ðŸŽ¯ ENHANCED: Higher quality hero image
  optimizeImage(
    experience.images?.[0]?.large || experience.images?.[0]?.url,
    1920,
    1080,
    95 // Higher quality for hero
  ),

  // ðŸŽ¯ ENHANCED: Better quality other experiences
  Promise.all(
    data.experiences
      .filter((otherExperience) => otherExperience.url !== experience.url)
      .map(async (otherExperience) => {
        const sourceUrl = otherExperience.images?.[0]?.large || otherExperience.images?.[0]?.url;
        const optimized = await optimizeImage(sourceUrl, 400, 300, 85);
                
        return {
          ...otherExperience,
          optimizedCardImg: optimized,
        };
      })
  ),
]);

// Split for load more functionality
const initialDiningImages = allDiningImages.slice(0, 12);
const remainingDiningImages = allDiningImages.slice(12);

// Safe hero image
const heroImage = optimizedHero?.src || 
                  experience.images?.[0]?.large || 
                  experience.images?.[0]?.url || 
                  "/img/default-dining.avif";

---

<link rel="preload" as="image" href={heroImage} fetchpriority="high" />

<Layout>
  <AstroSEO
    slot="head"
    title={`${experience.restaurantName} | Dining Experience - Limban Resort`}
    description={`Experience authentic dining at ${experience.restaurantName} - ${experience.shortIntro} Discover flavors that connect you to the heart of Tadoba National Park.`}
    canonical={`https://limban.com/dining/${slug}`}
    openGraph={{
      title: `${experience.restaurantName} - Dining Experience at Limban Resort`,
      description: `${experience.shortIntro} Experience authentic flavors and intimate dining in the wilderness of Tadoba National Park.`,
      image: heroImage,
      type: "article",
      url: `https://limban.com/dining/${slug}`,
    }}
    jsonLd={{
      "@context": "https://schema.org",
      "@type": "Restaurant",
      "@id": `https://limban.com/dining/${slug}#restaurant`,
      name: experience.restaurantName,
      description: `${experience.shortIntro} - Located in the heart of Tadoba National Park, offering an intimate dining experience that celebrates local flavors and sustainable cuisine.`,
      url: `https://limban.com/dining/${slug}`,
      image: [heroImage, ...allDiningImages.slice(0, 4).map((img) => img.src)].filter(Boolean),
      address: {
        "@type": "PostalAddress",
        streetAddress: "Survey No. 306, Village Mudholi, Taluka Bhadravati",
        addressLocality: "Chandrapur",
        addressRegion: "Maharashtra",
        postalCode: "442906",
        addressCountry: "IN",
      },
    }}
  />

  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-amber-400 text-gray-900 px-4 py-2 rounded z-50">
    Skip to main content
  </a>

  <div class="bg-gray-950 text-gray-100 font-sans antialiased selection:bg-gray-700">
    <!-- ðŸŽ¯ ENHANCED: Hero Section with Dining Type Badge -->
    <section class="relative pt-44 pb-16 overflow-hidden bg-gray-900" role="banner">
      <img
        src={heroImage}
        alt={`${experience.restaurantName} hero - authentic dining experience`}
        class="absolute inset-0 w-full h-full object-cover opacity-50"
        loading="eager"
        fetchpriority="high"
      />

      <!-- ðŸŽ¯ ENHANCED: Better gradient overlay -->
      <div class="absolute inset-0 bg-gradient-to-b from-gray-900/95 via-gray-900/70 to-gray-900/95"></div>
      
      <!-- ðŸŽ¯ NEW: Subtle animated overlay -->
      <div class="absolute inset-0 bg-gradient-to-r from-transparent via-amber-400/5 to-transparent animate-pulse"></div>

      <main id="main-content" class="relative z-10 max-w-7xl mx-auto px-6" role="main">
        <div class="text-center mb-12">
          
          <div class="text-sm text-gray-300 tracking-[0.2em] uppercase mb-4">
            Limban Dining Experience
          </div>
          <h1 class="font-serif italic text-4xl md:text-6xl lg:text-7xl text-white drop-shadow-lg mb-8">
            {experience.restaurantName}
          </h1>

          <!-- ðŸŽ¯ ENHANCED: Better description display -->
          {experience.shortIntro && (
            <div class="mt-2  inline-block max-w-4xl">
              <p class="text-lg md:text-xl text-gray-200 leading-relaxed">
                {experience.shortIntro}
              </p>
            </div>
          )}
        </div>
      </main>
    </section>


    <!-- ðŸŽ¯ ENHANCED: Breadcrumb Navigation -->
    <nav class="py-6 bg-gray-900/50 border-b border-gray-800" aria-label="Breadcrumb">
      <div class="max-w-7xl mx-auto px-6">
        <ol class="flex items-center justify-center space-x-2 text-sm">
          <li>
            <a href="/" class="text-gray-400 hover:text-amber-400 transition-colors duration-300 flex items-center">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
              </svg>
              Home
            </a>
          </li>
          <li><svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg></li>
          <li>
            <a href="/dining" class="text-gray-400 hover:text-amber-400 transition-colors duration-300">Dining Experiences</a>
          </li>
          <li><svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg></li>
          <li><span class="text-amber-400 font-medium">{experience.restaurantName}</span></li>
        </ol>
      </div>
    </nav>

    <!-- ðŸŽ¯ ENHANCED: Gallery Section -->
    <section class="py-32 bg-gray-950">
      <div class="max-w-7xl mx-auto px-6">
        <header class="text-center mb-16">
          <div class="inline-block px-6 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-8">
            <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">Visual Journey</span>
          </div>
          <h2 class="font-serif italic text-4xl md:text-6xl text-white mb-6">
            {experience.restaurantName} Gallery
          </h2>
          <p class="text-xl text-gray-300 max-w-2xl mx-auto">
            Discover the atmosphere and flavors of our authentic dining experience
          </p>
        </header>

        <GalleryGrid
          images={initialDiningImages}
          layout="grid"
          galleryType="dining"
          gridId="dining-gallery-grid"
        />

        <LoadMoreGallery
          buttonId="load-more-dining"
          remainingImages={remainingDiningImages}
          initialImages={initialDiningImages}
          galleryType="dining"
          galleryGridId="dining-gallery-grid"
          layout="grid"
        />

        <div class="text-center mt-8">
          <p class="text-gray-400 font-light italic">
            Click any image to explore {experience.restaurantName} in stunning detail
          </p>
        </div>
      </div>
    </section>

    <!-- ðŸŽ¯ ENHANCED: Experience Details Section -->
    <section class="py-32 bg-gray-900">
      <div class="max-w-7xl mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-32 items-start">
          <!-- Left Column - Experience Description -->
          <div class="space-y-16">
            <!-- ðŸŽ¯ ENHANCED: Experience description -->
            <div>
              <div class="inline-block px-4 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-6">
                <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">Experience</span>
              </div>
              <h2 class="font-serif italic text-3xl md:text-5xl text-white mb-8">
                A Taste of the Wild
              </h2>
              <p class="text-xl text-gray-300 leading-relaxed mb-8">
                {experience.shortIntro}
              </p>
              {experience.longDescription && (
                <div class="text-lg text-gray-300 leading-relaxed prose prose-invert max-w-none">
                  <p>{experience.longDescription}</p>
                </div>
              )}
              
            </div>

            <!-- ðŸŽ¯ ENHANCED: Dining Philosophy -->
            <div>
              <div class="inline-block px-4 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-6">
                <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">Limban Philosophy</span>
              </div>
              <h3 class="font-serif italic text-3xl md:text-4xl text-white mb-6">
                Fresh. Local. Authentic.
              </h3>
              <p class="text-lg text-gray-300 mb-12">
                Every serving tells the story of Tadoba's wilderness, crafted with locally sourced ingredients and prepared with passion.
              </p>

              <!-- ðŸŽ¯ ENHANCED: Interactive feature cards -->
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                {['Local Ingredients', 'Cooked to Order', 'Personal Touch', 'Farm to Table', 'Seasonal Menu', 'Wild Setting'].map((feature, index) => (
                  <div key={feature} class="group/tooltip relative">
                    <div class="p-6 bg-gray-800/60 border border-gray-700/50 rounded-2xl hover:border-amber-400/50 hover:bg-gray-700/60 transition-all duration-500 hover:-translate-y-2 hover:shadow-xl hover:shadow-amber-400/10 flex flex-col items-center text-center">
                      <div class="mb-4 w-12 h-12 flex items-center justify-center bg-gray-600/30 rounded-2xl group-hover:bg-amber-400/20 transition-all duration-500 group-hover:scale-110">
                        <div class="w-6 h-6 text-gray-400 group-hover:text-amber-300 transition-colors duration-300 flex items-center justify-center">
                          {/* Clean professional icons for dining features */}
                          {feature.includes('Local') && (
                            <Icon name="ph:map-pin-simple" class="w-full h-full" />
                          )}
                          {feature.includes('Order') && (
                            <Icon name="material-symbols-light:skillet-outline" class="w-full h-full" />
                          )}
                          {feature.includes('Personal') && (
                            <Icon name="ph:heart-straight" class="w-full h-full" />
                          )}
                          {feature.includes('Farm') && (
                            <Icon name="material-symbols-light:eco-outline" class="w-full h-full" />
                          )}
                          {feature.includes('Seasonal') && (
                            <Icon name="carbon:time" class="w-full h-full" />
                          )}
                          {feature.includes('Wild') && (
                            <Icon name="iconoir:pine-tree" class="w-full h-full" />
                          )}
                          {!feature.includes('Local') && !feature.includes('Order') && !feature.includes('Personal') && !feature.includes('Farm') && !feature.includes('Seasonal') && !feature.includes('Wild') && (
                            <Icon name="material-symbols-light:restaurant-outline" class="w-full h-full" />
                          )}
                        </div>
                      </div>
                      <h4 class="text-sm font-medium text-gray-300 group-hover:text-amber-100 transition-colors duration-300 leading-tight">
                        {feature}
                      </h4>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          <!-- Right Column - Enhanced Reservation Form -->
          <div class="lg:sticky lg:top-32">
            <div class="bg-gray-800/40 border border-gray-700/50 rounded-3xl p-8 backdrop-blur-sm">
              <DiningReservationForm
                itemName={experience.restaurantName}
                itemSlug={slug}
              />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ðŸŽ¯ ENHANCED: Other Dining Experiences Section -->
    <section class="py-32 bg-gradient-to-b from-gray-950 to-gray-900 border-t border-gray-800">
      <div class="max-w-7xl mx-auto px-6">
        <header class="text-center mb-16">
          <div class="inline-block px-6 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-8">
            <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">More Options</span>
          </div>
          <h2 class="font-serif italic text-4xl md:text-5xl text-white mb-6">
            Discover Other Experiences
          </h2>
          <p class="text-xl text-gray-300 max-w-3xl mx-auto">
            Each dining venue offers its own unique flavors and ambiance for an unforgettable culinary journey
          </p>
        </header>

        {optimizedOtherExperiences?.length > 0 ? (
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-8">
            {optimizedOtherExperiences.map((otherExperience) => (
              <article key={otherExperience.id} class="group relative aspect-[4/5] overflow-hidden rounded-2xl border border-gray-800/50 hover:border-amber-400/50 transition-all duration-700 hover:scale-105 hover:shadow-2xl hover:shadow-amber-400/20">
                <a href={`/dining/${otherExperience.url}`} class="block w-full h-full">
                  <img
                    src={otherExperience.optimizedCardImg?.src || otherExperience.images?.[0]?.large || "/img/dining-placeholder.avif"}
                    alt={`${otherExperience.restaurantName} dining experience at Limban Resort`}
                    class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                    loading="lazy"
                  />


                  <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent group-hover:from-black/70 group-hover:via-black/30 transition-all duration-500" />

                  <!-- Logo overlay -->
                  {otherExperience.logo?.optimisedLogo && (
                    <div class="absolute top-3 right-3 w-12 h-12 bg-white/10 backdrop-blur-sm rounded-full p-2 border border-white/20 opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                      <img
                        src={otherExperience.logo.optimisedLogo}
                        alt={`${otherExperience.restaurantName} logo`}
                        class="w-full h-full object-contain"
                        loading="lazy"
                      />
                    </div>
                  )}

                  <div class="absolute inset-0 flex flex-col justify-end p-5">
                    <h3 class="font-serif italic text-xl text-white mb-2 group-hover:text-amber-300 transition-colors duration-300 line-clamp-2">
                      {otherExperience.restaurantName}
                    </h3>
                    <p class="text-gray-300 text-sm mb-3 line-clamp-3 group-hover:text-gray-100 transition-colors">
                      {otherExperience.shortIntro || "Discover our culinary offerings"}
                    </p>
                    <div class="flex items-center justify-between">
                      <div class="text-sm font-bold text-amber-400 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                        Explore Now
                      </div>
                      <div class="opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0">
                        <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                  
                  <!-- ðŸŽ¯ ENHANCED: Glow effect -->
                  <div class="absolute inset-0 rounded-2xl bg-gradient-to-br from-amber-500/0 to-orange-500/0 group-hover:from-amber-500/10 group-hover:to-orange-500/10 transition-all duration-700"></div>
                </a>
              </article>
            ))}
          </div>
        ) : (
          <div class="text-center py-16">
            <div class="w-16 h-16 mx-auto mb-6 text-gray-500">
              <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 14l-7-7-7 7m14 0v3a2 2 0 01-2 2H5a2 2 0 01-2-2v-3" />
              </svg>
            </div>
            <h3 class="text-xl text-gray-400 mb-2">More Experiences Coming Soon</h3>
            <p class="text-gray-500">We're adding new dining options. Please check back soon.</p>
          </div>
        )}
      </div>
    </section>
  </div>

  <SmartReserveButton
    formSelector="#reservation-form"
    buttonText={`Reserve ${experience.restaurantName}`}
    position="bottom-right"
    glowOnScroll={true}
  />
  <GalleryModal />
</Layout>

<style>
  /* Performance optimizations */
  .group {
    will-change: transform;
  }

  .transition-transform {
    will-change: transform;
  }

  /* Respect user motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .transition-all,
    .transition-transform,
    .transition-colors,
    .hover\:scale-105,
    .hover\:scale-110,
    .animate-pulse {
      transition: none !important;
      transform: none !important;
      animation: none !important;
    }
  }
</style>
