---
import Layout from "../../layouts/Layout.astro";
import { AstroSEO } from "astro-seo-plugin";
import {
  fetchDiningExperienceBySlug,
  fetchDiningExperiencesData,
  fetchSpecialDealData,
} from "../../api.js";
import GalleryGrid from "../../components/GalleryGrid.astro";
import LoadMoreGallery from "../../components/LoadMoreGallery.astro";
import GalleryModal from "../../components/GalleryModal.astro";
import DiningReservationForm from "../../components/DiningReservationForm.astro";
import SmartReserveButton from "../../components/SmartReserveButton.astro";
import { processGalleryImages } from "../../components/imageProcessor.js"; // ðŸŽ¯ STEP 1: Import optimizer
import { getImage } from "astro:assets"; // ðŸŽ¯ STEP 1: Import getImage

// Ultra-reliable API fetching with retry logic
async function fetchWithRetry(fetchFn, retries = 2) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fetchFn();
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise((resolve) => setTimeout(resolve, 1000));
    }
  }
}

// ðŸŽ¯ STEP 2: Single image optimizer for hero and other experiences
async function optimizeHero(url) {
  if (!url) return null;
  try {
    return await getImage({
      src: url,
      width: 1920,
      height: 1080,
      format: "webp",
      quality: 50,
      fit: "cover",
      inferSize: true,
    });
  } catch (error) {
    console.error("Failed to optimize hero:", error);
    return null;
  }
}
// Other dining experiences cards (small, optimized for cards)
async function optimizeDiningCard(url) {
  if (!url) return null;
  try {
    return await getImage({
      src: url,
      width: 300, // ðŸŽ¯ MUCH SMALLER for cards
      height: 450, // ðŸŽ¯ Portrait aspect for cards
      format: "webp",
      quality: 5  0,
      fit: "cover",
      inferSize: true,
    });
  } catch (error) {
    console.error("Failed to optimize dining card:", error);
    return null;
  }
}

// Server-side data fetching with enhanced error handling
let data = {
  experiences: [],
  specialDeal: null,
};

let error = null;

try {
  const [experiences, specialDeal] = await Promise.all([
    fetchWithRetry(() => fetchDiningExperiencesData()),
    fetchWithRetry(() => fetchSpecialDealData()),
  ]);
  data = { experiences, specialDeal };
} catch (err) {
  console.error("Failed to load dining experiences data:", err);
  error = "Failed to load content from Hygraph";
}

export async function getStaticPaths() {
  try {
    const experiences = await fetchDiningExperiencesData();
    return experiences.map((experience) => ({
      params: { slug: experience.url },
      props: { experienceData: experience },
    }));
  } catch (err) {
    console.error("Failed to generate static paths:", err);
    return [];
  }
}

const { slug } = Astro.params;
const experience = await fetchWithRetry(() =>
  fetchDiningExperienceBySlug(slug)
);

if (!experience) {
  return Astro.redirect("/dining");
}

// ðŸŽ¯ STEP 3: Optimize ALL images with SPECIFIC functions
const [allDiningImages, optimizedHero, optimizedOtherExperiences] =
  await Promise.all([
    // Process gallery images using the gallery processor (already perfect)
    experience.images ? processGalleryImages(experience.images) : [],

    // ðŸŽ¯ FIX: Use hero optimizer for hero image
    optimizeHero(experience.images?.[0]?.large || experience.images?.[0]?.url),

    // ðŸŽ¯ FIX: Use card optimizer for other experiences
    Promise.all(
      data.experiences
        .filter((otherExperience) => otherExperience.url !== experience.url)
        .map(async (otherExperience) => {
          const sourceUrl =
            otherExperience.images?.[0]?.large ||
            otherExperience.images?.[0]?.url;
          const optimizedCard = await optimizeDiningCard(sourceUrl); // ðŸŽ¯ Use card optimizer
          return {
            ...otherExperience,
            optimizedCardImg:
              optimizedCard?.src || sourceUrl || "/img/dining-placeholder.jpg",
          };
        })
    ),
  ]);

// Split for load more functionality (EXACTLY like rooms)
const initialDiningImages = allDiningImages.slice(0, 12);
const remainingDiningImages = allDiningImages.slice(12);

// ðŸŽ¯ STEP 4: Use optimized hero image or fallback
const heroImage =
  optimizedHero?.src ||
  experience.images?.[0]?.large ||
  experience.images?.[0]?.url ||
  "/img/default-dining.jpg";

// Helper function for alt text generation
function generateAltText(experienceName, shortIntro) {
  if (!experienceName) return "Dining experience at Limban Resort";
  const baseDescription = shortIntro?.split(".")[0] || "dining experience";
  return `${experienceName} - ${baseDescription} at Limban Resort, Tadoba`;
}
---

<Layout>
  <AstroSEO
    slot="head"
    title={`${experience.restaurantName} | Dining Experience - Limban Resort`}
    description={`Experience authentic dining at ${experience.restaurantName} - ${experience.shortIntro} Discover flavors that connect you to the heart of Tadoba National Park.`}
    canonical={`https://limban.com/dining/${slug}`}
    openGraph={{
      title: `${experience.restaurantName} - Dining Experience at Limban Resort`,
      description: `${experience.shortIntro} Experience authentic flavors and intimate dining in the wilderness of Tadoba National Park.`,
      image:
        allDiningImages[0]?.src ||
        experience.images?.[0]?.url ||
        "/img/default-dining.jpg",
      type: "article",
      url: `https://limban.com/dining/${slug}`,
    }}
    jsonLd={{
      "@context": "https://schema.org",
      "@type": "Restaurant",
      "@id": `https://limban.com/dining/${slug}#restaurant`,
      name: experience.restaurantName,
      alternateName: `${experience.restaurantName} at Limban Resort`,
      description: `${experience.shortIntro} - Located in the heart of Tadoba National Park, offering an intimate dining experience that celebrates local flavors and sustainable cuisine.`,
      url: `https://limban.com/dining/${slug}`,
      sameAs: [
        "https://www.tripadvisor.in/Hotel_Review-g10594630-d12902646-Reviews-Limban_Resort-Chandrapur_District_Maharashtra.html",
        "https://www.instagram.com/limbanresorts/",
        "https://www.facebook.com/limbanresortstadoba/",
      ],
      image: [
        allDiningImages[0]?.large || allDiningImages[0]?.src,
        ...allDiningImages.slice(1, 8).map((img) => img.large || img.src),
      ].filter(Boolean),
      logo: "https://limban.com/limban-logo.png",
      address: {
        "@type": "PostalAddress",
        streetAddress: "Survey No. 306, Village Mudholi, Taluka Bhadravati",
        addressLocality: "Chandrapur",
        addressRegion: "Maharashtra",
        postalCode: "442906",
        addressCountry: "IN",
      },
    }}
  />

  <div
    class="bg-gray-950 text-gray-100 font-sans antialiased selection:bg-gray-700"
  >
    <!-- Hero Section  -->
    <section
      class="relative pt-48 pb-32 overflow-hidden bg-gray-900"
      role="banner"
      aria-labelledby="dining-hero-heading"
    >
      <!-- ðŸŽ¯ OPTIMIZED: Hero image -->
      <img
        src={heroImage}
        alt={`${experience.restaurantName} hero - authentic dining experience`}
        class="absolute inset-0 w-full h-full object-cover opacity-40"
        loading="eager"
        decoding="async"
        fetchpriority="high"
      />

      <!-- Enhanced gradient overlay for better text contrast -->
      <div
        class="absolute inset-0 bg-gradient-to-b from-gray-900/90 via-gray-900/60 to-gray-900/90"
      >
      </div>

      <!-- Hero content with improved accessibility -->
      <main
        id="main-content"
        class="relative z-10 max-w-7xl mx-auto px-6"
        role="main"
      >
        <div class="text-center mb-12">
          <div
            class="text-sm text-gray-300 tracking-[0.2em] uppercase mb-4"
            role="doc-subtitle"
          >
            Authentic Dining Experience
          </div>
          <h1
            id="dining-hero-heading"
            class="font-serif italic text-4xl md:text-6xl text-white mb-6 drop-shadow-lg"
          >
            {experience.restaurantName}
          </h1>

          <!-- Special Deal Section -->
          {
            data.specialDeal && data.specialDeal.html && (
              <div
                class="max-w-3xl mx-auto px-6 mt-12"
                role="complementary"
                aria-label="Special offer"
              >
                <div class="bg-gradient-to-r from-purple-900/60 to-amber-900/60 border border-purple-300/50 rounded-2xl p-8 text-center shadow-2xl backdrop-blur-xl">
                  <div
                    class="font-semibold text-lg text-white max-w-none prose prose-invert"
                    set:html={data.specialDeal.html}
                  />
                </div>
              </div>
            )
          }
        </div>
      </main>
    </section>

    <!-- Breadcrumbs -->
    <nav
      class="py-6 bg-gray-900/50 border-b border-gray-800"
      aria-label="Breadcrumb"
    >
      <div class="max-w-7xl mx-auto px-6">
        <ol class="flex items-center justify-center space-x-2 text-sm">
          <li>
            <a
              href="/"
              class="text-gray-400 hover:text-amber-400 transition-colors duration-300 flex items-center focus:outline-none focus:ring-2 focus:ring-amber-400/50 rounded"
            >
              <svg
                class="w-4 h-4 mr-1"
                fill="currentColor"
                viewBox="0 0 20 20"
                aria-hidden="true"
              >
                <path
                  d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
                ></path>
              </svg>
              Home
            </a>
          </li>
          <li aria-hidden="true">
            <svg
              class="w-4 h-4 text-gray-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                clip-rule="evenodd"></path>
            </svg>
          </li>
          <li>
            <a
              href="/dining"
              class="text-gray-400 hover:text-amber-400 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-amber-400/50 rounded"
            >
              Dining Experiences
            </a>
          </li>
          <li aria-hidden="true">
            <svg
              class="w-4 h-4 text-gray-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                clip-rule="evenodd"></path>
            </svg>
          </li>
          <li aria-current="page">
            <span class="text-amber-400 font-medium"
              >{experience.restaurantName}</span
            >
          </li>
        </ol>
      </div>
    </nav>

    <section
      class="py-32 bg-gradient-to-b from-gray-900 to-gray-950 border-t border-gray-800"
      aria-labelledby="gallery-heading"
    >
      <div class="max-w-7xl mx-auto px-6">
        <header class="text-center mb-16">
          <h2
            id="gallery-heading"
            class="font-serif italic text-4xl md:text-6xl text-white mb-6"
          >
            {experience.restaurantName} Gallery
          </h2>
          <p class="text-xl text-gray-300 max-w-2xl mx-auto">
            Discover the atmosphere and flavors of our dining experience
          </p>
        </header>

        <GalleryGrid
          images={initialDiningImages}
          layout="grid"
          galleryType="dining"
          gridId="dining-gallery-grid"
        />

        <LoadMoreGallery
          buttonId="load-more-dining"
          remainingImages={remainingDiningImages}
          initialImages={initialDiningImages}
          galleryType="dining"
          galleryGridId="dining-gallery-grid"
          layout="grid"
        />

        <div class="text-center mt-6">
          <p class="text-gray-400 font-light italic">
            Click any image to explore {experience.restaurantName} in details
          </p>
        </div>
      </div>
    </section>

    <!-- Dining Experience Details Section -->
    <section class="py-32 bg-gray-900">
      <div class="max-w-7xl mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start">
          <!-- Left Column - Experience Description -->
          <div class="space-y-12">
            <div>
              <h2
                class="font-serif italic text-3xl md:text-4xl text-white mb-6"
              >
                A Taste of the Wild
              </h2>
              <p class="text-lg text-gray-300 leading-relaxed mb-6">
                {experience.shortIntro}
              </p>
              {
                experience.longDescription && (
                  <div class="text-gray-300 leading-relaxed prose prose-invert max-w-none">
                    <p>{experience.longDescription}</p>
                  </div>
                )
              }
            </div>

            <!-- Dining Philosophy -->
            <div>
              <h3 class="font-serif italic text-3xl text-white mb-6">
                Our Philosophy
              </h3>
              <p class="text-gray-300 mb-8">
                Fresh. Local. Authentic. Every dish tells the story of Tadoba's
                wilderness.
              </p>

              <!-- Special Features Cards -->
              <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                <div
                  class="group relative p-5 bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-xl border border-gray-700 rounded-2xl hover:border-gray-500 transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl hover:shadow-black/20 flex flex-col items-center text-center"
                >
                  <h4
                    class="text-xs font-light text-gray-300 group-hover:text-amber-100 transition-colors duration-300"
                  >
                    Local Ingredients
                  </h4>
                </div>

                <div
                  class="group relative p-5 bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-xl border border-gray-700 rounded-2xl hover:border-gray-500 transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl hover:shadow-black/20 flex flex-col items-center text-center"
                >
                  <h4
                    class="text-xs font-light text-gray-300 group-hover:text-amber-100 transition-colors duration-300"
                  >
                    Cooked to Order
                  </h4>
                </div>

                <div
                  class="group relative p-5 bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-xl border border-gray-700 rounded-2xl hover:border-gray-500 transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl hover:shadow-black/20 flex flex-col items-center text-center"
                >
                  <h4
                    class="text-xs font-light text-gray-300 group-hover:text-amber-100 transition-colors duration-300"
                  >
                    Personal Touch
                  </h4>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column - Reservation Form -->
          <div class="space-y-8">
            <DiningReservationForm
              itemName={experience.restaurantName}
              itemSlug={slug}
            />
          </div>
        </div>
      </div>
    </section>

    <!-- ðŸŽ¯ OPTIMIZED: Other Dining Experiences Section -->
    <section
      class="py-32 bg-gradient-to-b from-gray-950 to-gray-900 border-t border-gray-800"
      aria-labelledby="other-dining-heading"
    >
      <div class="max-w-7xl mx-auto px-6">
        <header class="text-center mb-16">
          <h2
            id="other-dining-heading"
            class="font-serif italic text-4xl md:text-5xl text-white mb-6"
          >
            Discover Other Dining Experiences
          </h2>
          <p class="text-xl text-gray-300 max-w-3xl mx-auto">
            Each dining venue offers its own unique flavors and ambiance for an
            unforgettable culinary journey
          </p>
        </header>

        {
          optimizedOtherExperiences && optimizedOtherExperiences.length > 0 ? (
            <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-8">
              {optimizedOtherExperiences.map((otherExperience, index) => (
                <article
                  class="group relative aspect-[4/5] overflow-hidden rounded-2xl border border-gray-800/50 hover:border-amber-400/50 transition-all duration-700 hover:scale-105 hover:shadow-2xl hover:shadow-amber-400/20"
                  role="listitem"
                >
                  <a
                    href={`/dining/${otherExperience?.url}`}
                    class="block w-full h-full focus:outline-none focus:ring-4 focus:ring-amber-400/50 rounded-2xl"
                    aria-label={`View ${otherExperience?.restaurantName} details`}
                  >
                    {/* ðŸŽ¯ OPTIMIZED: Use optimized card image */}
                    <img
                      src={otherExperience.optimizedCardImg}
                      alt={`${otherExperience?.restaurantName || "Dining"} experience at Limban Resort`}
                      class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                      loading="lazy"
                      decoding="async"
                    />

                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent group-hover:from-black/70 group-hover:via-black/30 transition-all duration-500" />

                    {/* Logo overlay if available */}
                    {otherExperience?.logo?.optimisedLogo && (
                      <div class="absolute top-4 left-4 w-12 h-12 bg-white/10 backdrop-blur-sm rounded-full p-2 opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                        <img
                          src={otherExperience.logo.optimisedLogo}
                          alt={`${otherExperience.restaurantName} logo`}
                          class="w-full h-full object-contain"
                          loading="lazy"
                          width="40"
                          height="40"
                        />
                      </div>
                    )}

                    <div class="absolute inset-0 flex flex-col justify-end p-5">
                      <h3 class="font-serif italic text-xl text-white mb-2 group-hover:text-amber-300 transition-colors duration-300">
                        {otherExperience?.restaurantName || "Dining Experience"}
                      </h3>
                      <p class="text-gray-300 text-sm group-hover:text-gray-100 transition-colors duration-300 line-clamp-3 mb-3">
                        {otherExperience?.shortIntro ||
                          "Discover our culinary offerings"}
                      </p>
                      <div class="flex items-center justify-between">
                        <div class="text-sm font-semibold text-amber-400 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                          Dining Experience
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0">
                          <svg
                            class="w-5 h-5 text-amber-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            aria-hidden="true"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 5l7 7-7 7"
                            />
                          </svg>
                        </div>
                      </div>
                    </div>

                    {/* Enhanced glow effect */}
                    <div class="absolute inset-0 rounded-2xl bg-gradient-to-br from-amber-500/0 to-orange-500/0 group-hover:from-amber-500/10 group-hover:to-orange-500/10 transition-all duration-700" />
                  </a>
                </article>
              ))}
            </div>
          ) : (
            <div class="text-center py-12">
              <p class="text-gray-400">
                No other dining experiences available at the moment.
              </p>
            </div>
          )
        }
      </div>
    </section>
  </div>

  <!-- Custom button for dining reservations -->
  <SmartReserveButton
    formSelector="#reservation-form"
    buttonText={`Reserve ${experience.restaurantName}`}
    position="bottom-right"
    glowOnScroll={true}
  />
  <GalleryModal />
</Layout>
