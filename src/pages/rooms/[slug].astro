---
import { Icon } from "astro-icon/components";
import Layout from "../../layouts/Layout.astro";
import { AstroSEO } from "astro-seo-plugin";
import GalleryGrid from "../../components/GalleryGrid.astro";
import LoadMoreGallery from "../../components/LoadMoreGallery.astro";
import GalleryModal from "../../components/GalleryModal.astro";
import ReservationForm from "../../components/ReservationForm.astro";
import SmartReserveButton from "../../components/SmartReserveButton.astro";
import imageService, { processGalleryImages } from "../../utils/ImageService.js";
import {
  fetchRoomBySlug,
  fetchRooms,
  fetchSpecialDeal,
} from "../../api.js";

// Server-side data fetching with error handling
let data = { rooms: [], specialDeal: null };
let error = null;

try {
  const [rooms, specialDeal] = await Promise.all([
    fetchRooms(),
    fetchSpecialDeal(),
  ]);
  data = { rooms, specialDeal };
} catch (err) {
  console.error("Failed to load rooms data:", err);
  error = "Failed to load content from CMS";
}

export async function getStaticPaths() {
  try {
    const rooms = await fetchRooms();
    return rooms.map((room) => ({
      params: { slug: room.url },
      props: { roomData: room },
    }));
  } catch (err) {
    console.error("Failed to generate static paths:", err);
    return [];
  }
}

const { slug } = Astro.params;
const room = await fetchRoomBySlug(slug);

if (!room) {
  return Astro.redirect("/rooms");
}

// Process hero image through ImageService
const heroImageData = room.heroImage ? {
  ...room.heroImage,
  context: {
    pageType: 'rooms',
    contentName: room.roomName,
    imageType: 'hero'
  }
} : null;

// Safe price processing
const safePrice = Number(room.basePrice) || 0;

// Process all gallery images through ImageService
const processedGalleryImages = room.gallery && Array.isArray(room.gallery) && room.gallery.length > 0
  ? room.gallery.map((item, index) => {
      const imageData = item.image || item;

      // If you have id/alt/size fields, always set them!
      return {
        id: imageData.id || index,
        alt: imageData.alt || item.caption || `${room.roomName} view ${index + 1}`,
        width: imageData.width,
        height: imageData.height,
        caption: item.caption || imageData.alt || `${room.roomName} view ${index + 1}`,
        processedUrls: {
          thumbnail: imageService.processImage(imageData, "galleryThumbnail"),
          gallery: imageService.processImage(imageData, "gallery"),
          large: imageService.processImage(imageData, "galleryLarge"),
          modal: imageService.processImage(imageData, "heroDesktop"), // Must map to BIG variant!
        }
      };
    }).filter(Boolean)
  : [];


// Split for load more functionality
const initialGalleryImages = processedGalleryImages.slice(0, 12);
const remainingGalleryImages = processedGalleryImages.slice(12);

// Generate SEO-optimized URLs for schema
const heroImageUrl = heroImageData 
  ? imageService.processImage(heroImageData, 'heroDesktop', { quality: 75 })
  : 'https://limban.com/img/room-placeholder.avif';

const schemaImages = [
  heroImageUrl,
  ...processedGalleryImages.slice(0, 4).map(img => img.processedUrls.large)
].filter(Boolean);
---

<link rel="preload" as="image" href={heroImageUrl} fetchpriority="high" />

<Layout>
  <AstroSEO
    slot="head"
    title={`${room.roomName} | Luxury Safari Accommodation - Limban Resort`}
    description={`Experience luxury in our ${room.roomName} at Limban Resort. ${room.shortDescription} Book your exclusive safari accommodation in Tadoba National Park, Maharashtra.`}
    canonical={`https://limban.com/rooms/${room.url}`}
    openGraph={{
      title: `${room.roomName} - Luxury Safari Accommodation at Limban Resort`,
      description: `${room.shortDescription} Experience unparalleled luxury and eco-friendly comfort at Limban Resort in Tadoba National Park.`,
      image: heroImageUrl,
      type: "article",
      url: `https://limban.com/rooms/${room.url}`,
    }}
    jsonLd={{
      "@context": "https://schema.org",
      "@type": "LodgingBusiness",
      "@id": `https://limban.com/rooms/${room.url}#resort`,
      name: "Limban Resort",
      url: "https://limban.com",
      image: schemaImages,
      description: "Luxury safari resort in Tadoba National Park offering premium eco-friendly accommodation and tiger safari experiences in Maharashtra, India.",
      makesOffer: {
        "@type": "Offer",
        itemOffered: {
          "@type": "Accommodation",
          name: room.roomName,
          description: room.shortDescription,
          image: schemaImages,
        },
        price: safePrice,
        priceCurrency: "INR",
        availability: "https://schema.org/InStock",
        url: `https://limban.com/rooms/${room.url}`,
      },
    }}
  />

  <a
    href="#main-content"
    title="Skip to main content"
    class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-amber-400 text-gray-900 px-4 py-2 rounded z-50"
  >
    Skip to main content
  </a>

  <div class="bg-gray-950 text-gray-100 font-sans antialiased selection:bg-gray-700">
    <!-- Hero Section with Processed Image -->
    <section class="relative pt-44 pb-16 overflow-hidden bg-gray-900" role="banner">
    {heroImageData && (
      <img
        src={heroImageUrl}
        alt={`${room.roomName} luxury safari accommodation at Limban Resort`}
        loading="eager"
        fetchpriority="high"
        class="absolute inset-0 w-full h-full opacity-50 object-cover"
      />
    )}

      <!-- Enhanced gradient overlay -->
      <div class="absolute inset-0 bg-gradient-to-b from-gray-900/95 via-gray-900/70 to-gray-900/95"></div>

      <!-- Subtle animated overlay -->
      <div class="absolute inset-0 bg-gradient-to-r from-transparent via-amber-400/5 to-transparent animate-pulse"></div>

      <main id="main-content" class="relative z-10 max-w-7xl mx-auto px-6" role="main">
        <div class="text-center mb-12">
          <div class="text-sm text-gray-300 tracking-[0.2em] uppercase mb-4">
            Your Luxury Safari Accommodation
          </div>
          <h1 class="font-serif italic text-4xl md:text-6xl lg:text-7xl text-white drop-shadow-lg mb-6">
            {room.roomName}
          </h1>

          <!-- Enhanced pricing display -->
          <div class="mt-8 p-8 bg-black/40 backdrop-blur-lg rounded-3xl inline-block border border-gray-700/50">
            <div class="flex items-center justify-center space-x-2 mb-2">
              <span class="text-lg text-gray-400">From</span>
              <span class="text-4xl font-bold text-white drop-shadow-lg">â‚¹{safePrice.toLocaleString()}</span>
              <span class="text-lg text-gray-400">/ night</span>
            </div>

            <!-- Value indicators -->
            <div class="flex items-center justify-center space-x-6 text-sm text-gray-300 mt-3">
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-2 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path>
                </svg>
                Breakfast Included
              </span>
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-2 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Free Cancellation
              </span>
            </div>
          </div>
        </div>
      </main>
    </section>

    <!-- Breadcrumb Navigation -->
    <nav class="py-6 bg-gray-900/50 border-b border-gray-800" aria-label="Breadcrumb">
      <div class="max-w-7xl mx-auto px-6">
        <ol class="flex items-center justify-center space-x-2 text-sm">
          <li>
            <a href="/" title="Return to Limban Resort homepage" class="text-gray-400 hover:text-amber-400 transition-colors duration-300 flex items-center">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
              </svg>
              Home
            </a>
          </li>
          <li>
            <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          </li>
          <li>
            <a href="/rooms" title="View all luxury safari accommodations at Limban Resort" class="text-gray-400 hover:text-amber-400 transition-colors duration-300">Rooms</a>
          </li>
          <li>
            <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          </li>
          <li>
            <span class="text-amber-400 font-medium">{room.roomName}</span>
          </li>
        </ol>
      </div>
    </nav>

    <!-- Gallery Section with Universal Components -->
    <section class="py-32 bg-gray-800">
      <div class="max-w-7xl mx-auto px-6">
        {data.specialDeal?.html && (
          <div class="max-w-3xl mx-auto mb-16">
            <div class="bg-gradient-to-r from-purple-900/60 to-amber-900/60 border border-purple-300/50 rounded-2xl p-8 text-center shadow-2xl backdrop-blur-xl">
              <div class="font-semibold text-lg text-white" set:html={data.specialDeal.html} />
            </div>
          </div>
        )}

        <header class="text-center mb-16">
          <div class="inline-block px-6 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-8">
            <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">Visual Journey</span>
          </div>
          <h2 class="font-serif italic text-4xl md:text-6xl text-white mb-6">
            {room.roomName} Gallery
          </h2>
          <p class="text-xl text-gray-300 max-w-2xl mx-auto">
            Explore every detail of your luxury safari accommodation through our curated visual experience
          </p>
        </header>

        <!-- Universal Gallery Grid -->
        {processedGalleryImages.length > 0 ? (
          <>
            <GalleryGrid
              images={initialGalleryImages}
              galleryType="rooms"
              gridId="room-gallery-grid"
              layout="grid"
              columns={{
                mobile: 2,
                tablet: 4,
                desktop: 6,
                xl: 6
              }}
              aspectRatio="square"
              showOverlay={true}
              loadingStrategy="intersection"
            />

            {remainingGalleryImages.length > 0 && (
              <LoadMoreGallery
                buttonId="load-more-room-gallery"
                remainingImages={remainingGalleryImages}
                galleryType="rooms"
                galleryGridId="room-gallery-grid"
                initialCount={initialGalleryImages.length}
                batchSize={12}
                customLabels={{ rooms: "Room Views" }}
                showProgress={true}
              />
            )}

            <div class="text-center mt-8">
              <p class="text-gray-400 font-light italic">
                Click any image to explore {room.roomName} in stunning detail
              </p>
            </div>
          </>
        ) : (
          <div class="text-center py-16">
            <p class="text-gray-400 text-lg">Gallery images coming soon...</p>
          </div>
        )}
      </div>
    </section>

    <!-- Room Details Section -->
    <section class="py-32 bg-gray-900">
      <div class="max-w-7xl mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-32 items-start">
          <!-- Left Column - Experience & Amenities -->
          <div class="space-y-16">
            <!-- Room description -->
            <div>
              <div class="inline-block px-4 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-6">
                <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">Experience</span>
              </div>
              <h2 class="font-serif italic text-3xl md:text-5xl text-white mb-8">
                {room.roomName}'s Story
              </h2>
              <p class="text-xl text-gray-300 leading-relaxed mb-8">
                {room.shortDescription}
              </p>

              <!-- Room highlights -->
              <div class="mt-8">
                <div class="bg-gray-800/40 rounded-2xl p-6 border border-gray-700/50">
                  <h4 class="text-amber-400 font-semibold mb-2">Max Occupancy</h4>
                  <p class="text-gray-300">2 Guests (Extra Bed on Request)</p>
                </div>
              </div>
            </div>

            <!-- Amenities section -->
            <div>
              <div class="inline-block px-4 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-6">
                <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">Amenities</span>
              </div>
              <h3 class="font-serif italic text-3xl md:text-4xl text-white mb-6">
                Crafted for Your Comfort
              </h3>
              <p class="text-xl text-gray-300 mb-12">
                Every detail in {room.roomName} is carefully curated for your ultimate comfort and luxury.
              </p>

              <!-- Interactive amenities grid -->
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                {room.roomFeature?.map((feature) => (
                  <div key={feature.id} class="group/tooltip relative">
                    <div class="p-6 bg-gray-800/60 border border-gray-700/50 rounded-2xl hover:border-amber-400/50 hover:bg-gray-700/60 transition-all duration-500 hover:-translate-y-2 hover:shadow-xl hover:shadow-amber-400/10 flex flex-col items-center text-center">
                      <div class="mb-4 w-16 h-16 flex items-center justify-center bg-gray-600/30 rounded-2xl group-hover:bg-amber-400/20 transition-all duration-500 group-hover:scale-110">
                        <Icon
                          name={feature.svgImage}
                          class="w-8 h-8 text-gray-400 group-hover:text-amber-300 transition-colors duration-300"
                        />
                      </div>
                      <h4 class="text-sm font-medium text-gray-300 group-hover:text-amber-100 transition-colors duration-300 leading-tight">
                        {feature.featureName}
                      </h4>
                    </div>
                  </div>
                )) || (
                  <div class="col-span-full text-center py-12">
                    <p class="text-gray-400 text-lg">Amenities information coming soon.</p>
                  </div>
                )}
              </div>
            </div>
          </div>

          <!-- Right Column - Enhanced Reservation Form -->
              <ReservationForm
                roomName={room.roomName}
                roomSlug={room.url}
                basePrice={safePrice}
              />
        </div>
      </div>
    </section>

    <!-- Other Rooms Section with Processed Images -->
    <section class="py-32 bg-gradient-to-b from-gray-950 to-gray-900 border-t border-gray-800">
      <div class="max-w-7xl mx-auto px-6">
        <header class="text-center mb-16">
          <div class="inline-block px-6 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-8">
            <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">More Options</span>
          </div>
          <h2 class="font-serif italic text-4xl md:text-5xl text-white mb-6">
            Discover Other Experiences
          </h2>
          <p class="text-xl text-gray-300 max-w-3xl mx-auto">
            Each room offers its own unique perspective on luxury safari living at Limban Resort
          </p>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-8">
          {data.rooms.filter(otherRoom => otherRoom.url !== room.url).map((otherRoom) => {
            // Process other room hero image URL
            const otherRoomImageUrl = otherRoom.heroImage ? 
              imageService.processImage({
                ...otherRoom.heroImage,
                context: {
                  pageType: 'rooms',
                  contentName: otherRoom.roomName,
                  imageType: 'card'
                }
              }, 'roomCard', { quality: 70 }) : '';

            return (
              <article key={otherRoom.id} class="group relative aspect-[4/5] overflow-hidden rounded-2xl border border-gray-800/50 hover:border-amber-400/50 transition-all duration-700 hover:scale-105 hover:shadow-2xl hover:shadow-amber-400/20">
                <a href={`/rooms/${otherRoom.url}`} class="block w-full h-full">
                  {otherRoomImageUrl && (
                    <img
                      src={otherRoomImageUrl}
                      alt={`${otherRoom.roomName} luxury safari room at Limban Resort`}
                      loading="lazy"
                      class="absolute inset-0 w-full h-full group-hover:scale-110 transition-transform duration-700 object-cover"
                    />
                  )}

                  <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent group-hover:from-black/70 group-hover:via-black/30 transition-all duration-500" />

                  <div class="absolute inset-0 flex flex-col justify-end p-5">
                    <h3 class="font-serif italic text-xl text-white mb-2 group-hover:text-amber-300 transition-colors duration-300 line-clamp-2">
                      {otherRoom.roomName}
                    </h3>
                    <p class="text-gray-300 text-sm mb-3 line-clamp-3 group-hover:text-gray-100 transition-colors">
                      {otherRoom.shortDescription}
                    </p>
                    <div class="flex items-center justify-between">
                      <div class="text-sm font-bold text-amber-400 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                        From â‚¹{(Number(otherRoom.basePrice) || 0).toLocaleString()}
                      </div>
                      <div class="opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0">
                        <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Glow effect -->
                  <div class="absolute inset-0 rounded-2xl bg-gradient-to-br from-amber-500/0 to-orange-500/0 group-hover:from-amber-500/10 group-hover:to-orange-500/10 transition-all duration-700"></div>
                </a>
              </article>
            );
          })}
        </div>
      </div>
    </section>
  </div>

  <!-- Smart btn -->
  <SmartReserveButton buttonText={`Reserve ${room.roomName}`} />

  <!-- Universal Gallery Modal -->
  <GalleryModal />
</Layout>

<style>
  /* Performance optimizations */
  .group {
    will-change: transform;
  }

  .transition-transform {
    will-change: transform;
  }

  /* Respect user motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .transition-all,
    .transition-transform,
    .transition-colors,
    .hover\:scale-105,
    .hover\:scale-110,
    .animate-pulse {
      transition: none !important;
      transform: none !important;
      animation: none !important;
    }
  }
</style>
