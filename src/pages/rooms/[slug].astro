---
import Layout from '../../layouts/Layout.astro';
import { AstroSEO } from 'astro-seo-plugin';
import { fetchRoomBySlug, fetchRoomsData, fetchSpecialDealData } from '../../api.js';
import GalleryGrid from '../../components/GalleryGrid.astro';
import ReservationForm from '../../components/ReservationForm.astro';

// Ultra-reliable API fetching with retry logic
async function fetchWithRetry(fetchFn, retries = 2) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fetchFn();
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }
}

// Bulletproof URL validation
function validateImageUrl(url) {
  if (!url || typeof url !== 'string') return null;
  try {
    const parsed = new URL(url);
    return parsed.protocol === 'https:' ? url : null;
  } catch {
    return null;
  }
}

// Server-side data fetching with enhanced error handling
let data = { rooms: [], specialDeal: null };
let error = null;

try {
  const [rooms, specialDeal] = await Promise.all([
    fetchWithRetry(() => fetchRoomsData()),
    fetchWithRetry(() => fetchSpecialDealData())
  ]);
  data = { rooms, specialDeal };
} catch (err) {
  console.error('Failed to load rooms data:', err);
  error = 'Failed to load content from CMS';
}

export async function getStaticPaths() {
  try {
    const rooms = await fetchRoomsData();
    return rooms.map((room) => ({
      params: { slug: room.url },
      props: { roomData: room },
    }));
  } catch (err) {
    console.error('Failed to generate static paths:', err);
    return [];
  }
}

const { slug } = Astro.params;
const room = await fetchWithRetry(() => fetchRoomBySlug(slug));

if (!room) {
  return Astro.redirect('/rooms');
}

// Process and validate gallery images
const galleryImages = (room.gallery || [])
  .filter(item => validateImageUrl(item?.image?.url))
  .map((item, index) => ({
    src: validateImageUrl(item.image?.thumb800) || validateImageUrl(item.image?.url),
    srcset: `${validateImageUrl(item.image?.thumb400) || validateImageUrl(item.image?.url)} 400w, ${validateImageUrl(item.image?.thumb800) || validateImageUrl(item.image?.url)} 800w`,
    large: validateImageUrl(item.image?.large) || validateImageUrl(item.image?.url),
    placeholder: validateImageUrl(item.image?.placeholder) || validateImageUrl(item.image?.url),
    alt: item.caption || `${room.roomName} - luxury safari room view ${index + 1}`,
    width: item.image?.width || 800,
    height: item.image?.height || 600,
    priority: index < 6, // First 6 images get priority loading
  }));

// Validate hero image
const heroImage = validateImageUrl(room.heroImage?.optimisedCard) || 
                  validateImageUrl(room.heroImage?.url) || 
                  '/img/room-placeholder.jpg';

// Safe price processing
const safePrice = Number(room.basePrice) || 0;
---

<!-- Performance optimization: preload critical resources -->
<link rel="preload" as="image" href={heroImage} fetchpriority="high" />
<link rel="dns-prefetch" href="https://ap-south-1.graphassets.com" />
<link rel="preconnect" href="https://ap-south-1.graphassets.com" />

<Layout title={`${room.roomName} - Limban Resort`}>
  <AstroSEO
    title={`${room.roomName} | Luxury Safari Accommodation - Limban Resort`}
    description={`Experience luxury in our ${room.roomName} at Limban Resort. ${room.shortDescription} Book your exclusive safari accommodation in Tadoba National Park, Maharashtra.`}
    canonical={`https://limban.com/rooms/${room.url}`}
    openGraph={{
      title: `${room.roomName} - Luxury Safari Accommodation at Limban Resort`,
      description: `${room.shortDescription} Experience unparalleled luxury and eco-friendly comfort at Limban Resort in Tadoba National Park.`,
      image: heroImage,
      type: 'article',
      url: `https://limban.com/rooms/${room.url}`
    }}
    jsonLd={{
      "@context": "https://schema.org",
      "@type": "Resort",
      "@id": `https://limban.com/rooms/${room.url}#resort`,
      "name": "Limban Resort",
      "url": "https://limban.com",
      "logo": "https://limban.com/limban-logo.png",
      "image": [heroImage, ...galleryImages.slice(0, 6).map(img => img.large)].filter(Boolean),
      "description": "Luxury safari resort in Tadoba National Park offering premium eco-friendly accommodation and tiger safari experiences in Maharashtra, India.",
      "containsPlace": {
        "@type": "Accommodation",
        "name": room.roomName,
        "description": room.shortDescription,
        "image": [heroImage, ...galleryImages.slice(0, 4).map(img => img.large)].filter(Boolean),
        "amenityFeature": room.roomFeature?.map(feature => ({
          "@type": "LocationFeatureSpecification",
          "name": feature.featureName,
          "value": true
        })) || [],
        "offers": {
          "@type": "Offer",
          "price": safePrice,
          "priceCurrency": "INR",
          "availability": "https://schema.org/InStock",
          "url": `https://limban.com/rooms/${room.url}`,
          "validFrom": new Date().toISOString().split('T')[0]
        }
      }
    }}
  />
  
  <!-- Skip to content for accessibility -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-amber-400 text-gray-900 px-4 py-2 rounded z-50">
    Skip to main content
  </a>

  <div class="bg-gray-950 text-gray-100 font-sans antialiased selection:bg-gray-700">
    <!-- Enhanced Hero Section -->
    <section class="relative pt-36 pb-16 overflow-hidden bg-gray-900" role="banner" aria-labelledby="room-hero-heading">
      <!-- Optimized Background Image with Modern Formats -->
      <picture class="absolute inset-0">
        <source 
          srcset={`${heroImage}?format=avif&w=1920&h=1080&q=80`} 
          type="image/avif" 
          media="(min-width: 1200px)"
        />
        <source 
          srcset={`${heroImage}?format=webp&w=1920&h=1080&q=80`} 
          type="image/webp" 
          media="(min-width: 1200px)"
        />
        <source 
          srcset={`${heroImage}?format=avif&w=768&h=1024&q=80`} 
          type="image/avif" 
          media="(max-width: 1199px)"
        />
        <source 
          srcset={`${heroImage}?format=webp&w=768&h=1024&q=80`} 
          type="image/webp" 
          media="(max-width: 1199px)"
        />
        <img
          src={heroImage}
          alt={`${room.roomName} hero - luxury safari accommodation`}
          class="w-full h-full object-cover opacity-40"
          loading="eager"
          decoding="async"
          fetchpriority="high"
        />
      </picture>
      
      <!-- Enhanced gradient overlay for better text contrast -->
      <div class="absolute inset-0 bg-gradient-to-b from-gray-900/90 via-gray-900/60 to-gray-900/90"></div>
      
      <!-- Hero content with improved accessibility -->
      <main id="main-content" class="relative z-10 max-w-7xl mx-auto px-6" role="main">
        <div class="text-center mb-12">
          <div class="text-sm text-gray-300 tracking-[0.2em] uppercase mb-4" role="doc-subtitle">
            Your Luxury Safari Accommodation
          </div>
          <h1 id="room-hero-heading" class="font-serif italic text-4xl md:text-6xl text-white mb-6 drop-shadow-lg">
            {room.roomName}
          </h1>
          <p class="text-xl text-gray-200 max-w-3xl mx-auto leading-relaxed drop-shadow-sm">
            {room.shortDescription}
          </p>
          
          <!-- Enhanced pricing display -->
          <div class="mt-8 p-6 bg-black/30 backdrop-blur-lg rounded-2xl inline-block">
            <span class="text-3xl font-bold text-white drop-shadow-lg">
              From ₹{safePrice.toLocaleString()}
            </span>
            <span class="text-gray-300 block mt-1">Per Night • Breakfast Included</span>
          </div>
          
          <!-- Enhanced Special Deal Section -->
          {data.specialDeal && data.specialDeal.html && (
            <div class="max-w-3xl mx-auto px-6 mt-12" role="complementary" aria-label="Special offer">
              <div class="bg-gradient-to-r from-purple-900/60 to-amber-900/60 border border-purple-300/50 rounded-2xl p-8 text-center shadow-2xl backdrop-blur-xl">
                <div class="font-semibold text-lg text-white max-w-none prose prose-invert" set:html={data.specialDeal.html} />
              </div>
            </div>
          )}
        </div>
      </main>
    </section>
    
    <!-- Enhanced Breadcrumb Navigation -->
    <nav class="py-6 bg-gray-900/50 border-b border-gray-800" aria-label="Breadcrumb">
      <div class="max-w-7xl mx-auto px-6">
        <ol class="flex items-center justify-center space-x-2 text-sm">
          <li>
            <a href="/" class="text-gray-400 hover:text-amber-400 transition-colors duration-300 flex items-center focus:outline-none focus:ring-2 focus:ring-amber-400/50 rounded">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
              </svg>
              Home
            </a>
          </li>
          <li aria-hidden="true">
            <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
          </li>
          <li>
            <a href="/rooms" class="text-gray-400 hover:text-amber-400 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-amber-400/50 rounded">
              Rooms
            </a>
          </li>
          <li aria-hidden="true">
            <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
          </li>
          <li aria-current="page">
            <span class="text-amber-400 font-medium">{room.roomName}</span>
          </li>
        </ol>
      </div>
    </nav>
    
    <!-- Enhanced Gallery Section -->
    <section class="py-32 bg-gray-800" aria-labelledby="gallery-heading">
      <div class="max-w-7xl mx-auto px-6">
        <header class="text-center mb-16">
          <h2 id="gallery-heading" class="font-serif italic text-4xl md:text-6xl text-white mb-6">
            {room.roomName} Gallery
          </h2>
          <p class="text-xl text-gray-300 max-w-2xl mx-auto">
            Explore every detail of your luxury safari accommodation through our immersive gallery
          </p>
        </header>
        
        <GalleryGrid images={galleryImages} layout="grid" galleryType="room" />
      </div>
    </section>

    <!-- Enhanced Room Details Section -->
    <section class="py-32 bg-gray-900" aria-labelledby="room-details-heading">
      <div class="max-w-7xl mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-20 items-start">
          <!-- Left Column - Experience & Amenities -->
          <div class="space-y-16">
            <!-- Room Description -->
            <div>
              <h2 id="room-details-heading" class="font-serif italic text-3xl md:text-5xl text-white mb-8">
                Experience Nature in Luxury
              </h2>
              <div class="prose prose-lg prose-invert max-w-none">
                <p class="text-xl text-gray-300 leading-relaxed mb-8">
                  {room.shortDescription}
                </p>
                {room.description && (
                  <div 
                    class="text-gray-300 leading-relaxed"
                    set:html={room.description.html}
                  />
                )}
              </div>
            </div>

            <!-- Enhanced Amenities Grid -->
            <div>
              <h3 class="font-serif italic text-3xl md:text-4xl text-white mb-6">
                Luxury Amenities
              </h3>
              <p class="text-xl text-gray-300 mb-12">
                Every detail carefully curated for your comfort and luxury
              </p>
              
              <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                {room.roomFeature?.map((feature, index) => (
                  <article 
                    key={feature.id}
                    class="group relative p-6 bg-gradient-to-br from-gray-800/60 to-gray-900/60 backdrop-blur-xl border border-gray-700/50 rounded-3xl hover:border-amber-400/50 hover:from-gray-700/60 hover:to-gray-800/60 transition-all duration-700 hover:-translate-y-3 hover:shadow-2xl hover:shadow-amber-400/10 flex flex-col items-center text-center"
                    tabindex="0"
                    role="listitem"
                  >
                    <!-- Enhanced icon container -->
                    <div class="mb-6 w-16 h-16 flex items-center justify-center bg-gradient-to-br from-amber-500/20 to-orange-500/20 rounded-2xl group-hover:from-amber-400/30 group-hover:to-orange-400/30 transition-all duration-500 group-hover:scale-110">
                      <div 
                        class="w-8 h-8 text-white group-hover:text-amber-300 transition-colors duration-300 flex items-center justify-center [&>svg]:w-full [&>svg]:h-full [&>svg]:object-contain" 
                        set:html={feature.svgImage}
                      />
                    </div>
                    
                    <h4 class="text-sm font-medium text-gray-300 group-hover:text-amber-100 transition-colors duration-300 text-center leading-relaxed">
                      {feature.featureName}
                    </h4>
                    
                    <!-- Enhanced hover glow effect -->
                    <div class="absolute inset-0 rounded-3xl bg-gradient-to-br from-amber-500/0 to-orange-500/0 group-hover:from-amber-500/5 group-hover:to-orange-500/5 transition-all duration-700"></div>
                  </article>
                )) || (
                  <div class="col-span-full text-center py-12">
                    <p class="text-gray-400 text-lg">Amenities information coming soon.</p>
                  </div>
                )}
              </div>
            </div>
          </div>
          
          <!-- Right Column - Enhanced Reservation Form -->
          <div class="lg:sticky lg:top-32">
              <ReservationForm 
                roomName={room.roomName} 
                roomSlug={room.url} 
                basePrice={safePrice} 
              />
          </div>
        </div>
      </div>
    </section>

    <!-- Stunning Other Rooms Section -->
    <section class="py-32 bg-gradient-to-b from-gray-950 to-gray-900 border-t border-gray-800" aria-labelledby="other-rooms-heading">
      <div class="max-w-7xl mx-auto px-6">
        <header class="text-center mb-16">
          <h2 id="other-rooms-heading" class="font-serif italic text-4xl md:text-5xl text-white mb-6">
            Discover Other Experiences
          </h2>
          <p class="text-xl text-gray-300 max-w-3xl mx-auto">
            Each room offers its own unique perspective on luxury safari living
          </p>
        </header>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-8">
          {data.rooms
            .filter(otherRoom => otherRoom.url !== room.url)
            .map((otherRoom, index) => {
              const otherRoomImage = validateImageUrl(otherRoom.heroImage?.optimisedCard) || '/img/room-placeholder.jpg';
              return (
                <article 
                  class="group relative aspect-[4/5] overflow-hidden rounded-2xl border border-gray-800/50 hover:border-amber-400/50 transition-all duration-700 hover:scale-105 hover:shadow-2xl hover:shadow-amber-400/20"
                  role="listitem"
                >
                  <a 
                    href={`/rooms/${otherRoom.url}`}
                    class="block w-full h-full focus:outline-none focus:ring-4 focus:ring-amber-400/50 rounded-2xl"
                    aria-label={`View ${otherRoom.roomName} details`}
                  >
                    <!-- Optimized background image -->
                    <picture>
                      <source 
                        srcset={`${otherRoomImage}?format=avif&w=400&h=500&q=80`} 
                        type="image/avif"
                      />
                      <source 
                        srcset={`${otherRoomImage}?format=webp&w=400&h=500&q=80`} 
                        type="image/webp"
                      />
                      <img
                        src={otherRoomImage}
                        alt={`${otherRoom.roomName} accommodation`}
                        class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                        loading="lazy"
                        decoding="async"
                        width="400"
                        height="500"
                      />
                    </picture>
                    
                    <!-- Enhanced gradient overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent group-hover:from-black/70 group-hover:via-black/30 transition-all duration-500"></div>
                    
                    <!-- Enhanced content overlay -->
                    <div class="absolute inset-0 flex flex-col justify-end p-5">
                      <h3 class="font-serif italic text-xl md:text-lg text-white mb-2 group-hover:text-amber-300 transition-colors duration-300 line-clamp-2 group-hover:font-bold">
                        {otherRoom.roomName}
                      </h3>
                      <p class="text-gray-300 text-sm md:text-sm group-hover:text-gray-100 transition-colors duration-300 line-clamp-3 mb-3">
                        {otherRoom.shortDescription}
                      </p>
                      <div class="flex items-center justify-between">
                        <div class="text-sm font-bold text-amber-400 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                          From ₹{Number(otherRoom.basePrice || 0).toLocaleString()}
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0">
                          <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                          </svg>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Enhanced glow effect -->
                    <div class="absolute inset-0 rounded-2xl bg-gradient-to-br from-amber-500/0 to-orange-500/0 group-hover:from-amber-500/10 group-hover:to-orange-500/10 transition-all duration-700"></div>
                  </a>
                </article>
              );
            })
          }
        </div>
      </div>
    </section>
  </div>
</Layout>

<style>
  /* Enhanced smooth transitions */
  .group img {
    transform-origin: center center;
    backface-visibility: hidden;
    will-change: transform;
  }

  /* Respect user motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .transition-all,
    .transition-transform,
    .transition-colors,
    .group-hover\:scale-105,
    .group-hover\:scale-110,
    .hover\:-translate-y-3 {
      transition: none !important;
      transform: none !important;
    }
  }

  /* Enhanced contrast for accessibility */
  @media (prefers-contrast: high) {
    .border-gray-800,
    .border-gray-700 {
      border-color: rgba(255, 255, 255, 0.3);
    }
  }

  /* Accessible focus states */
  .focus\:not-sr-only:focus {
    position: absolute !important;
    width: auto !important;
    height: auto !important;
    padding: 1rem !important;
    margin: 0 !important;
    overflow: visible !important;
    clip: auto !important;
    white-space: normal !important;
  }
</style>

<script define:vars={{ galleryImages }}>
  // Enhanced gallery modal integration
  class RoomGalleryHandler {
    constructor() {
      this.init();
    }

    init() {
      // Dispatch event to open the global gallery modal
      document.querySelectorAll('[data-gallery-index]').forEach(el => {
        el.addEventListener('click', (e) => {
          e.preventDefault();
          const index = parseInt(el.dataset.galleryIndex, 10);
          if (!isNaN(index) && galleryImages[index]) {
            this.openGallery(index);
          }
        });
      });

      // Add keyboard support for gallery items
      document.querySelectorAll('[data-gallery-index]').forEach(el => {
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            el.click();
          }
        });
      });
    }

    openGallery(index) {
      const openGalleryEvent = new CustomEvent('open-gallery', {
        detail: {
          images: galleryImages,
          index: index,
        },
      });
      document.dispatchEvent(openGalleryEvent);
    }
  }

  // Initialize enhanced gallery handler
  document.addEventListener('DOMContentLoaded', () => {
    new RoomGalleryHandler();
  });

  // Enhanced error handling
  window.addEventListener('error', (e) => {
    if (e.target && e.target.tagName === 'IMG') {
      console.warn('Image failed to load:', e.target.src);
      e.target.src = '/img/room-placeholder.jpg';
      e.target.alt = 'Image temporarily unavailable';
    }
  });
</script>
