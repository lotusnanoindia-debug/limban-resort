---
import Layout from "../layouts/Layout.astro";
import { AstroSEO } from "astro-seo-plugin";
import { fetchVibePageData } from "../api.js";
import GalleryGrid from "../components/GalleryGrid.astro";
import LoadMoreGallery from "../components/LoadMoreGallery.astro";
import GalleryModal from "../components/GalleryModal.astro";
import { processGalleryImages } from "../components/imageProcessor.js";
import { getImage } from "astro:assets";


// Ultra-reliable API fetching with retry logic
async function fetchWithRetry(fetchFn, retries = 2) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fetchFn();
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise((resolve) => setTimeout(resolve, 1000));
    }
  }
}


// ðŸŽ¯ NEW: Process images in batches to prevent build bottlenecks
async function processImagesInBatches(images, batchSize = 4) {
  const results = [];
  
  for (let i = 0; i < images.length; i += batchSize) {
    const batch = images.slice(i, i + batchSize);
    console.log(`Processing batch ${Math.floor(i/batchSize) + 1}: ${batch.length} images`);
    
    const batchResults = await Promise.all(
      batch.map((item, index) => processGalleryImage(item, i + index))
    );
    
    results.push(...batchResults);
    
    // Small delay between batches to be gentle on resources
    if (i + batchSize < images.length) {
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }
  
  return results;
}


// ðŸŽ¯ ENHANCED: Hero mosaic optimizer with LQIP generation
async function optimizeHeroTile(url) {
  if (!url) return null;
  try {
    // Process both main image and tiny placeholder
    const [optimized, placeholder] = await Promise.all([
      getImage({
        src: url,
        width: 300,
        height: 400,
        format: "webp",
        quality: 60,
        fit: "cover",
        inferSize: true,
      }),
      // ðŸŽ¯ NEW: Generate tiny LQIP
      getImage({
        src: url,
        width: 20,
        height: 26, // Maintain 300:400 aspect ratio
        format: "webp",
        quality: 20,
        fit: "cover",
        inferSize: true,
      })
    ]);

    return {
      ...optimized,
      placeholder: placeholder.src
    };
  } catch (error) {
    console.error("Failed to optimize hero tile:", error);
    return null;
  }
}


// Enhanced processGalleryImage with AI-optimised alt text
async function processGalleryImage(item, index = 0) {
  try {
    const imageObj = item.image || item;
    const sourceUrl = imageObj.large || imageObj.thumb400 || imageObj.url;
    
    if (!sourceUrl) {
      throw new Error(`No URL found for image ${index}`);
    }

    const [optimizedThumbnail, optimizedMedium, optimizedLarge] = await Promise.all([
      getImage({
        src: sourceUrl,
        width: 96,
        height: 96,
        format: 'webp',
        quality: 60,
        fit: 'cover',
        inferSize: true,
      }),
      
      getImage({
        src: sourceUrl,
        width: 300,
        height: 300,
        format: 'webp',
        quality: 60,
        fit: 'cover',
        inferSize: true,
      }),
      
      getImage({
        src: sourceUrl,
        width: 1600,
        format: 'webp',
        quality: 80,
        fit: 'inside',
        inferSize: true,
      })
    ]);

    return {
      src: optimizedLarge.src,
      gallerythumbs: optimizedThumbnail.src,
      medium: optimizedMedium.src,
      placeholder: imageObj.placeholder || sourceUrl,
      // ðŸŽ¯ ENHANCED: AI-optimised alt text
      alt: `${item.caption || item.altText || 'Luxury safari experience'} - Premium wildlife resort accommodation at Limban Resort Tadoba National Park Maharashtra`,
      width: optimizedLarge.width,
      height: optimizedLarge.height,
    };
  } catch (error) {
    console.error(`Failed to process image ${index}:`, error);
    
    const imageObj = item.image || item;
    return {
      src: imageObj.large || imageObj.grid || imageObj.url,
      gallerythumbs: imageObj.gallerythumbs || imageObj.grid || imageObj.url,
      medium: imageObj.thumb400 || imageObj.grid || imageObj.url,
      placeholder: imageObj.placeholder || imageObj.url,
      alt: `${item.caption || item.altText || 'Luxury safari experience'} - Premium wildlife resort accommodation at Limban Resort Tadoba National Park Maharashtra ${index + 1}`,
      width: imageObj.width || 300,
      height: imageObj.height || 300,
    };
  }
}


// Fetch data with retry protection
let vibeData = null;
let error = null;

try {
  vibeData = await fetchWithRetry(() => fetchVibePageData());
} catch (err) {
  console.error("Failed to load vibe data:", err);
  error = "Failed to load content";
}

if (!vibeData) {
  vibeData = {
    vibeImages: [],
    wildlifeImages: [],
  };
}


// OPTIMISED: Process images in batches to prevent build bottlenecks
const [initialVibeOptimized, initialWildlifeOptimized] = await Promise.all([
  processImagesInBatches(vibeData.vibeImages?.slice(0, 12) || []),
  processImagesInBatches(vibeData.wildlifeImages?.slice(0, 12) || []),
]);


// ðŸŽ¯ ENHANCED: Process hero tiles with LQIP support
const heroTilesRaw = vibeData.vibeImages?.slice(0, 12) || [];
const heroTiles = await Promise.all(
  heroTilesRaw.map(async (item, index) => {
    const imageObj = item.image || item;
    const sourceUrl = imageObj.large || imageObj.thumb400 || imageObj.url;
    const optimized = await optimizeHeroTile(sourceUrl);
    
    return {
      src: optimized?.src || sourceUrl,
      placeholder: optimized?.placeholder || sourceUrl, // ðŸŽ¯ NEW: LQIP support
      // ENHANCED: alt text for hero images
      alt: `${item.altText || item.caption || 'Limban Resort experience'} - Luxury wilderness resort Tadoba National Park tiger safari accommodation`,
      width: optimized?.width || 300,
      height: optimized?.height || 400,
      caption: item.caption || item.altText || null,
    };
  })
);


// ðŸŽ¯ ENHANCED: Remaining images with optimised alt text
const remainingVibeImages = (vibeData.vibeImages || [])
  .slice(12)
  .map((item, index) => ({
    src: item?.image?.large || item?.image?.url || "",
    gallerythumbs: item?.image?.gallerythumbs || item?.image?.grid || "",
    medium: item?.image?.thumb400 || item?.image?.url || "",
    placeholder: item?.image?.placeholder || item?.image?.url || "",
    alt: `${item?.altText || 'Luxury resort experience'} - Premium safari accommodation Limban Resort Tadoba National Park Maharashtra India ${index + 13}`,
    width: parseInt(item?.image?.width) || 300,
    height: parseInt(item?.image?.height) || 300,
  }));


const remainingWildlifeImages = (vibeData.wildlifeImages || [])
  .slice(12)
  .map((item, index) => ({
    src: item?.image?.large || item?.image?.url || "",
    gallerythumbs: item?.image?.gallerythumbs || item?.image?.grid || "",
    medium: item?.image?.thumb400 || item?.image?.url || "",
    placeholder: item?.image?.placeholder || item?.image?.url || "",
    alt: `${item?.alt || 'Tadoba wildlife encounter'} - Tiger safari wildlife photography Tadoba National Park Maharashtra India ${index + 13}`,
    width: parseInt(item?.image?.width) || 300,
    height: parseInt(item?.image?.height) || 300,
  }));


// Combine optimized initial + remaining images
const allVibeImages = [...initialVibeOptimized, ...remainingVibeImages];
const allWildlifeImages = [...initialWildlifeOptimized, ...remainingWildlifeImages];

// Split for display
const initialVibeImages = initialVibeOptimized;
const initialWildlifeImages = initialWildlifeOptimized;

// Hero image for OpenGraph
const heroImage = heroTiles[0]?.src || initialVibeOptimized[0]?.src || "/limban-vibe-hero.webp";
---


<Layout>
  <AstroSEO
    slot="head"
    title="The Limban Vibe | Feel What Calls You Wild - Tadoba Safari Experience"
    description="Immerse yourself in the Limban experience. Feel the luxury, taste the wild, live the moment. This is what calls you to Tadoba."
    canonical="https://limban.com/vibe"
    openGraph={{
      title: "The Limban Vibe - Feel What Calls You Wild",
      description:
        "Experience luxury safari living at its finest in Tadoba National Park. Feel the vibe that makes Limban unforgettable.",
      image: heroImage,
      type: "website",
      url: "https://limban.com/vibe",
    }}
    jsonLd={{
      "@context": "https://schema.org",
      "@type": "WebPage",
      name: "The Limban Vibe - Feel What Calls You Wild",
      description:
        "Immerse yourself in the Limban experience. Feel the luxury, taste the wild, live the moment. This is what calls you to Tadoba.",
      url: "https://limban.com/vibe",
      mainEntity: {
        "@type": "TouristDestination",
        name: "Limban Resort & Tadoba Experience",
        description:
          "Luxury safari resort experience in Tadoba National Park offering premium eco-friendly accommodation and tiger safari experiences in Maharashtra.",
        image: [
          heroImage,
          ...initialVibeImages.slice(0, 3).map((img) => img.src),
          ...initialWildlifeImages.slice(0, 2).map((img) => img.src),
        ].filter(Boolean),
        geo: {
          "@type": "GeoCoordinates",
          latitude: "20.1",
          longitude: "79.3",
        },
        address: {
          "@type": "PostalAddress",
          addressLocality: "Tadoba",
          addressRegion: "Maharashtra",
          addressCountry: "IN",
        },
        touristType: [
          "Luxury Travelers",
          "Wildlife Enthusiasts",
          "Nature Lovers",
        ],
        availableLanguage: ["English", "Hindi"],
        includesAttraction: [
          {
            "@type": "TouristAttraction",
            name: "Tadoba National Park",
            description: "Home to magnificent tigers and diverse wildlife",
            touristType: "Wildlife Enthusiasts",
          },
          {
            "@type": "TouristAttraction",
            name: "Tiger Safari Experience",
            description:
              "Close encounters with tigers in their natural habitat",
            touristType: "Adventure Seekers",
          },
        ],
      },
      provider: {
        "@type": "LodgingBusiness",
        name: "Limban Resort",
        url: "https://limban.com",
        logo: "https://limban.com/limban-resort-tadoba-logo.png",
        description: "Luxury safari resort in Tadoba National Park",
        address: {
          "@type": "PostalAddress",
          addressLocality: "Tadoba",
          addressRegion: "Maharashtra",
          addressCountry: "IN",
        },
      },
      about: [
        {
          "@type": "Thing",
          name: "Luxury Safari Experience",
          description:
            "Premium eco-friendly accommodation with tiger safari experiences",
        },
        {
          "@type": "Thing",
          name: "Wildlife Photography",
          description: "Capture magnificent wildlife in Tadoba National Park",
        },
        {
          "@type": "Thing",
          name: "Eco-Tourism",
          description: "Sustainable luxury tourism in Maharashtra",
        },
      ],
      potentialAction: {
        "@type": "ViewAction",
        target: "https://limban.com/rooms",
        name: "Book Your Stay",
      },
    }}
  />

  <!-- ðŸŽ¯ NEW: Critical resource hints for LCP optimization -->
  {heroTiles[0] && (
    <link rel="preload" as="image" href={heroTiles[0].src} fetchpriority="high" />
  )}
  {heroTiles[1] && (
    <link rel="preload" as="image" href={heroTiles[1].src} fetchpriority="high" />
  )}

  <div class="bg-gray-950 text-gray-100 selection:bg-amber-400/20">
    <!-- Skip to content for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-amber-400 text-gray-900 px-4 py-2 rounded z-50"
    >
      Skip to main content
    </a>

    <!-- ðŸŽ¯ ENHANCED: Hero Section with LQIP backgrounds -->
    <section
      class="relative pt-48 pb-32 overflow-hidden bg-gray-950"
      role="banner"
      aria-labelledby="hero-heading"
    >
      <!-- Background Mosaic with LQIP support -->
      <div class="absolute inset-0 grid grid-cols-4 md:grid-cols-6 gap-0 opacity-60">
        {heroTiles.map((image, index) => (
          <div 
            key={`mosaic-${index}`}
            class="relative overflow-hidden h-full fade-in-up"
            style={`animation-delay: ${index * 100}ms`}
          >
            <img
              src={image.src}
              alt={image.alt}
              class="relative w-full h-full object-cover hover:scale-105 transition-all duration-1000"
              loading={index < 12 ? 'eager' : 'lazy'}
              fetchpriority={index < 6 ? 'high' : 'auto'}
              decoding="async"
              width={image.width}
              height={image.height}
              style={image.placeholder ? `background-image: url(${image.placeholder}); background-size: cover; background-position: center;` : ''}
            />
            
            <!-- Optional: Image overlay on hover -->
            <div class="absolute inset-0 bg-gray-900/80 opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
              <span class="text-white text-xs font-medium text-center px-2">
                {image.caption || 'Limban Experience'}
              </span>
            </div>
          </div>
        ))}
      </div>

      <!-- Layered Gradients for Perfect Text Readability -->
      <div class="absolute inset-0 bg-gradient-to-br from-black/80 via-black/50 to-black/70"></div>
      <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-black/40"></div>
      <div class="absolute inset-0 bg-gradient-to-r from-transparent via-amber-400/5 to-transparent animate-pulse"></div>
      
      <!-- Hero content -->
      <div class="relative z-10 max-w-7xl mx-auto px-6 text-center">
        <div class="text-sm text-gray-300 tracking-[0.2em] uppercase mb-6" role="doc-subtitle">
          Luxury Wilderness Resort
        </div>
        <h1 id="hero-heading" class="font-serif italic text-5xl md:text-7xl lg:text-8xl text-amber-400 mb-8 drop-shadow-2xl">
          Feel The Vibe
        </h1>
        <p class="text-xl md:text-2xl text-gray-200 max-w-4xl mx-auto leading-relaxed drop-shadow-lg">
          Sustainable luxury 20mins from Moharli Gate. Where passionate hosts, exceptional naturalists, and Tadoba's tigers create your perfect safari base.
        </p>
        
      </div>
    </section>
  </div>

  <!-- Main content wrapper -->
  <main id="main-content" role="main">
    <!-- Breadcrumb Navigation -->
    <nav class="py-6 border-b border-gray-800/50" aria-label="Breadcrumb">
      <div class="max-w-7xl mx-auto px-6">
        <ol
          class="flex items-center justify-center space-x-2 text-sm text-gray-400"
        >
          <li>
            <a
              href="/"
              class="hover:text-amber-400 transition-colors duration-300"
              >Home</a
            >
          </li>
          <li aria-hidden="true">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                clip-rule="evenodd"></path>
            </svg>
          </li>
          <li aria-current="page">
            <span class="text-amber-400 font-medium">The Vibe</span>
          </li>
        </ol>
      </div>
    </nav>

    <!-- Resort Vibe Section -->
    <section class="py-32 bg-gray-900" aria-labelledby="resort-heading">
      <div class="max-w-7xl mx-auto px-6">
        <div class="text-center mb-20">
          <div
            class="inline-block px-6 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-8"
          >
            <span
              class="text-amber-400 text-sm font-medium tracking-widest uppercase"
              >Resort Experience</span
            >
          </div>
          <h2
            id="resort-heading"
            class="font-serif italic text-5xl md:text-7xl text-white mb-8"
          >
            Live the Luxury.
            <span class="block text-amber-400">Feel the Soul.</span>
          </h2>
          <p
            class="text-xl text-gray-300 font-light leading-relaxed max-w-4xl mx-auto"
          >
            Every corner whispers stories. Every moment breathes life. This is
            how luxury feels when it's crafted with soul.
          </p>
        </div>

        <GalleryGrid
          images={initialVibeImages}
          galleryType="vibe"
          gridId="vibe-gallery-grid"
        />

        <LoadMoreGallery
          buttonId="load-more-vibe"
          remainingImages={remainingVibeImages}
          initialImages={initialVibeImages}
          galleryType="vibe"
          galleryGridId="vibe-gallery-grid"
        />

        <div class="text-center mt-6">
          <p class="text-gray-400 font-light italic">
            Click any image to explore the Limban experience in detail
          </p>
        </div>
      </div>
    </section>

    <!-- Transition Section -->
    <section class="py-20 bg-gradient-to-b from-gray-900 to-green-950/30">
      <div class="max-w-4xl mx-auto text-center px-6">
        <h3 class="font-serif italic text-4xl md:text-5xl text-white mb-6">
          And then...
          <span class="block text-amber-400">The Wild Calls</span>
        </h3>
        <p class="text-xl text-gray-300 font-light leading-relaxed">
          Beyond the luxury, beyond the comfort, lies the reason you came here.
          The untamed. The magnificent. The wild heart of Tadoba.
        </p>
      </div>
    </section>

    <!-- Wildlife Gallery Section -->
    <section class="py-32 bg-gray-950" aria-labelledby="wildlife-heading">
      <div class="max-w-7xl mx-auto px-6">
        <div class="text-center mb-20">
          <div
            class="inline-block px-6 py-2 bg-green-400/10 border border-green-400/30 rounded-full mb-8"
          >
            <span
              class="text-green-400 text-sm font-medium tracking-widest uppercase"
              >Wild Encounters</span
            >
          </div>
          <h2
            id="wildlife-heading"
            class="font-serif italic text-5xl md:text-7xl text-white mb-8"
          >
            Meet Your
            <span class="block text-green-400">Wild Neighbours</span>
          </h2>
          <p
            class="text-xl text-gray-300 font-light leading-relaxed max-w-4xl mx-auto"
          >
            In Tadoba, you're not just a visitorâ€”you're a guest in their ancient
            kingdom. These are the moments that change you forever.
          </p>
        </div>

        <GalleryGrid
          images={initialWildlifeImages}
          galleryType="wildlife"
          gridId="wildlife-gallery-grid"
        />

        <LoadMoreGallery
          buttonId="load-more-wildlife"
          remainingImages={remainingWildlifeImages}
          initialImages={initialWildlifeImages}
          galleryType="wildlife"
          galleryGridId="wildlife-gallery-grid"
        />

        <div class="text-center mt-6">
          <p class="text-gray-400 font-light italic">
            Click any image to explore Tadoba's magnificent wildlife
          </p>
        </div>
      </div>
    </section>

    <!-- Call to Action -->
    <section class="py-32 bg-gray-900">
      <div class="max-w-5xl mx-auto px-6 text-center">
        <h2 class="font-serif italic text-5xl md:text-7xl text-white mb-8">
          Ready to Experience
          <span class="block text-amber-400">The Limban Vibe?</span>
        </h2>
        <p
          class="text-2xl text-gray-300 font-light leading-relaxed mb-12 max-w-4xl mx-auto"
        >
          Every image tells its own story. Your story begins the moment you
          arrive. The wild is calling. Limban is waiting.
        </p>
        <div class="flex flex-col sm:flex-row gap-6 justify-center">
          <a href="/rooms" class="cta-filled">
            Reserve Your Room Now
            <svg
              class="w-6 h-6 ml-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </a>
          <a href="/safaris" class="cta-outlined">
            Explore Tiger Safaris
            <svg
              class="w-6 h-6 ml-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </a>
        </div>
      </div>
    </section>
  </main>
</Layout>
<GalleryModal />

<!-- Add CSS for staggered animations -->
<style>
  .fade-in-up {
    opacity: 0;
    animation: fadeInUp 1s ease-out forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Performance-optimized transitions */
  .transition-opacity {
    will-change: opacity;
  }

  /* Accessible focus states */
  .focus\:not-sr-only:focus {
    position: absolute !important;
    width: auto !important;
    height: auto !important;
    padding: 1rem !important;
    margin: 0 !important;
    overflow: visible !important;
    clip: auto !important;
    white-space: normal !important;
  }

  /* Respect user motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .transition-all,
    .transition-transform,
    .transition-colors,
    .hover\:scale-105,
    .animate-bounce {
      transition: none !important;
      transform: none !important;
      animation: none !important;
    }
  }
</style>
