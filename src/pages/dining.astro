---
import Layout from "../layouts/Layout.astro";
import { AstroSEO } from "astro-seo-plugin";
import { fetchDiningExperiencesData, fetchSpecialDealData } from "../api.js";
import { getImage } from 'astro:assets';

// Ultra-reliable API fetching with retry logic
async function fetchWithRetry(fetchFn, retries = 2) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fetchFn();
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }
}

// ðŸŽ¯ ENHANCED: Single image optimizer for all dining images
async function optimizeImage(url, width, height, quality = 60) {
  if (!url) return null;
  try {
    const optimized = await getImage({
      src: url,
      width: width,
      height: height,
      format: 'avif',
      quality: quality,
      fit: 'cover',
      inferSize: true,
    });
    return optimized;
  } catch (error) {
    return { src: url };
  }
}

// Server-side data fetching
let data = { experiences: [], specialDeal: null };
let error = null;

try {
  const [diningExperiences, specialDeal] = await Promise.all([
    fetchWithRetry(() => fetchDiningExperiencesData()),
    fetchWithRetry(() => fetchSpecialDealData())
  ]);
  data = { experiences: diningExperiences || [], specialDeal };
} catch (err) {
  console.error("Failed to load dining experiences:", err);
  error = "Failed to load dining experiences from Hygraph";
}

// ðŸŽ¯ ENHANCED: Process and optimize all images with better quality
const experiences = await Promise.all(
  data.experiences.map(async (experience, index) => {
    const sourceUrl = experience.images?.[0]?.large || experience.images?.[0]?.url;
    const logoUrl = experience.logo?.optimisedLogo || experience.logo?.url;
    
    const [optimizedHero, optimizedCard, optimizedLogo, lqip] = await Promise.all([
      optimizeImage(sourceUrl, 600, 400, 85), // Higher quality for hero
      optimizeImage(sourceUrl, 400, 300, 80), // Cards
      optimizeImage(logoUrl, 64, 64, 90), // High quality logos
      optimizeImage(sourceUrl, 24, 18, 20) // LQIP
    ]);


    return {
      id: experience.id,
      name: experience.restaurantName,
      intro: experience.shortIntro,
      description: experience.longDescription,
      optimizedLogo: optimizedLogo?.src || logoUrl || "",
      optimizedHero: optimizedHero?.src || sourceUrl || "",
      optimizedCard: optimizedCard?.src || sourceUrl || "",
      lqip: lqip?.src || sourceUrl || "",
      slug: experience.url || `experience-${index + 1}`,
      alt: `${experience.restaurantName} dining experience at Limban Resort`,
      priority: index < 3 // First 3 get priority loading
    };
  })
);

// ðŸŽ¯ ENHANCED: Create randomized hero mosaic
function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// Create randomized mosaic tiles (24 total)
const mosaicTiles = [];
const availableExperiences = [...experiences];

for (let i = 0; i < 24; i++) {
  if (availableExperiences.length === 0) {
    availableExperiences.push(...shuffleArray(experiences));
  }
  mosaicTiles.push(availableExperiences.pop());
}

// Safe hero image for meta
const heroImageSrc = experiences[0]?.optimizedHero || "/img/dining-hero.avif";
---

<Layout>
  <AstroSEO
    slot="head"
    title="Dining Experiences | Limban Resort - Tadoba Safari Lodge"
    description="Discover authentic dining experiences at Limban Resort - from jungle-fresh ingredients to intimate bush dinners under starlit skies in the heart of Tadoba National Park, Maharashtra."
    canonical="https://limban.com/dining"
    openGraph={{
      title: "Dining Experiences at Limban Resort - Tadoba Safari Lodge",
      description: "Authentic Indian cuisine, locally sourced ingredients, and unforgettable dining settings in the wilderness of Tadoba National Park.",
      image: heroImageSrc,
      type: "website",
      url: "https://limban.com/dining",
      site_name: "Limban Resort"
    }}
    jsonLd={{
      "@context": "https://schema.org",
      "@type": ["Restaurant", "TouristDestination"],
      "@id": "https://limban.com/dining#restaurant",
      "name": "Limban Resort Dining Experiences",
      "description": "Authentic dining experiences in the heart of Tadoba National Park. From dawn coffee with morning chorus to candlelit dinners under ancient trees, discover flavors crafted from the freshest local ingredients.",
      "url": "https://limban.com/dining",
      "image": [heroImageSrc, ...experiences.slice(0, 5).map(exp => exp.optimizedHero)].filter(Boolean),
      "servesCuisine": ["Indian Cuisine", "Local Maharashtrian", "Farm-to-Table"],
      "priceRange": "â‚¹â‚¹â‚¹",
      "acceptsReservations": true,
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Dining Experience Collection",
        "itemListElement": experiences.map((exp, index) => ({
          "@type": "Offer",
          "position": index + 1,
          "itemOffered": {
            "@type": "FoodEvent",
            "name": exp.name,
            "description": exp.intro,
            "url": `https://limban.com/dining/${exp.slug}`,
            "image": exp.optimizedHero
          }
        }))
      }
    }}
  />

  {/* Preload critical images */}
  <link rel="preload" as="image" href={heroImageSrc} fetchpriority="high" />
  {experiences[0]?.optimizedCard && <link rel="preload" as="image" href={experiences[0].optimizedCard} />}

  <div class="bg-gray-950 text-gray-100">
    <!-- ðŸŽ¯ ENHANCED: Hero Section with Dynamic Mosaic -->
    <section class="relative pt-48 pb-32 overflow-hidden bg-gray-950">
      <!-- Dynamic mosaic background -->
      <div class="absolute inset-0 grid grid-cols-4 md:grid-cols-6 gap-0 opacity-60">
        {mosaicTiles.map((experience, index) => (
          <div 
            key={`dining-mosaic-${index}`}
            class="relative overflow-hidden h-full fade-in-up"
            style={`animation-delay: ${index * 50}ms`}
          >
            <img
              src={experience.optimizedHero}
              alt={`${experience.name} dining at Limban Resort`}
              class="relative w-full h-full object-cover hover:scale-105 transition-all duration-1000"
              loading={index < 12 ? 'eager' : 'lazy'}
              fetchpriority={index < 6 ? 'high' : 'auto'}
              decoding="async"
            />
            
            <!-- Experience name overlay on hover -->
            <div class="absolute inset-0 bg-gray-900/80 opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
              <span class="text-white text-xs font-medium text-center px-2">
                {experience.name}
              </span>
            </div>
          </div>
        ))}
      </div>

      <!-- Enhanced gradients -->
      <div class="absolute inset-0 bg-gradient-to-br from-black/80 via-black/50 to-black/70"></div>
      <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-black/40"></div>
      <div class="absolute inset-0 bg-gradient-to-r from-transparent via-amber-400/5 to-transparent animate-pulse"></div>

      <!-- Hero Content -->
      <div class="relative z-20 max-w-7xl mx-auto px-6">
        <div class="text-center space-y-8">
          <!-- Badge -->
          <div class="inline-block px-6 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-8">
            <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">
              Savour the Wild
            </span>
          </div>
          
          <!-- Main Heading -->
          <h1 class="font-serif italic text-5xl md:text-7xl lg:text-8xl text-white leading-tight drop-shadow-2xl">
            Dining <span class="text-amber-400">Experiences</span>
          </h1>
          
          <!-- Subheading -->
          <p class="text-xl md:text-2xl text-gray-200 font-light leading-relaxed max-w-4xl mx-auto drop-shadow-lg">
            In the heart of Tadoba, every meal tells a story. From dawn coffee with the morning chorus 
            to candlelit dinners under ancient trees, discover authentic flavours crafted from the 
            freshest local ingredients.
          </p>
        </div>
      </div>
    </section>

    <!-- Breadcrumb Navigation -->
    <nav class="py-6 bg-gray-900/50 border-b border-gray-800" aria-label="Breadcrumb">
      <div class="max-w-7xl mx-auto px-6">
        <ol class="flex items-center justify-center space-x-2 text-sm">
          <li>
            <a href="/" class="text-gray-400 hover:text-amber-400 transition-colors duration-300 flex items-center">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
              </svg>
              Home
            </a>
          </li>
          <li><svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg></li>
          <li><span class="text-amber-400 font-medium">Dining</span></li>
        </ol>
      </div>
    </nav>

    <!-- ðŸŽ¯ ENHANCED: Dining Experiences Grid -->
    <section class="py-32 bg-gradient-to-b from-gray-950 to-gray-800">
      <div class="max-w-7xl mx-auto px-6">
        
        <!-- Special Deal Section -->
        {data.specialDeal?.html && (
          <div class="max-w-4xl mx-auto mb-20">
            <div class="bg-gradient-to-r from-purple-900/40 to-orange-900/40 border border-amber-400/30 rounded-2xl p-6 text-center shadow-2xl backdrop-blur-xl">
              <div class="font-bold text-lg text-white" set:html={data.specialDeal.html} />
            </div>
          </div>
        )}

        <header class="text-center mb-20">
          <div class="inline-block px-6 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-8">
            <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">
              Culinary Journey
            </span>
          </div>
          <h2 class="font-serif italic text-4xl md:text-6xl text-white mb-6">
            Taste the Wilderness
          </h2>
          <p class="text-xl text-gray-300 max-w-3xl mx-auto">
            Each dining experience is crafted to connect you with the flavors and spirit of Tadoba
          </p>
        </header>
        
        {error ? (
          <div class="text-center py-16">
            <div class="w-16 h-16 mx-auto mb-6 text-red-400">
              <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
              </svg>
            </div>
            <h3 class="text-xl text-red-400 mb-2">Content Unavailable</h3>
            <p class="text-gray-400">{error}</p>
          </div>
        ) : (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" role="list">
            {experiences.map((experience, index) => (
              <article
                key={experience.id}
                class="group relative overflow-hidden rounded-3xl bg-gray-800/40 border border-gray-700/50 hover:border-amber-400/50 transition-all duration-700 hover:-translate-y-2 hover:shadow-2xl hover:shadow-amber-400/10"
                role="listitem"
              >
                <!-- ðŸŽ¯ ENHANCED: Image with LQIP and dining type badge -->
                <div class="relative aspect-[4/3] overflow-hidden">
                  <!-- LQIP Background -->
                  {experience.lqip && (
                    <img
                      src={experience.lqip}
                      alt=""
                      class="absolute inset-0 w-full h-full object-cover blur-sm scale-105"
                      aria-hidden="true"
                    />
                  )}
                  
                  <!-- Main optimized image -->
                  <img
                    src={experience.optimizedCard}
                    alt={experience.alt}
                    class="relative w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                    loading={experience.priority ? 'eager' : 'lazy'}
                    fetchpriority={experience.priority ? 'high' : 'auto'}
                    decoding="async"
                  />
                                    
                  <!-- Gradient overlay -->
                  <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent group-hover:from-black/60 transition-colors duration-500"></div>
                  
                  <!-- ðŸŽ¯ ENHANCED: Experience logo with better positioning -->
                  {experience.optimizedLogo && (
                    <div class="absolute top-4 right-4 w-12 h-12 bg-white/10 backdrop-blur-sm rounded-full p-2 border border-white/20 opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                      <img
                        src={experience.optimizedLogo}
                        alt={`${experience.name} logo`}
                        class="w-full h-full object-contain"
                        loading="lazy"
                      />
                    </div>
                  )}
                </div>

                <!-- Enhanced content -->
                <div class="p-8 space-y-6">
                  <header>
                    <h3 class="font-serif italic text-2xl md:text-3xl text-white mb-4 group-hover:text-amber-300 transition-colors duration-300">
                      {experience.name}
                    </h3>
                    <p class="text-gray-300 font-light leading-relaxed line-clamp-3">
                      {experience.intro}
                    </p>
                  </header>
                  
                  <!-- ðŸŽ¯ ENHANCED: CTA Button with better styling -->
                  <footer>
                    <a
                      href={`/dining/${experience.slug}`}
                      class="action-btn group/cta relative overflow-hidden"
                      aria-label={`Explore ${experience.name} dining experience`}
                    >
                      <span class="relative z-10 flex items-center justify-center">
                        Explore {experience.name}
                        <svg class="w-5 h-5 ml-2 group-hover/cta:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                        </svg>
                      </span>
                      
                      <!-- Animated background effect -->
                      <div class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform translate-x-[-100%] group-hover/cta:translate-x-[100%] transition-transform duration-1000 ease-out"></div>
                    </a>
                  </footer>
                </div>
                
                <!-- ðŸŽ¯ ENHANCED: Glow effect -->
                <div class="absolute inset-0 rounded-3xl bg-gradient-to-br from-amber-500/0 to-orange-500/0 group-hover:from-amber-500/5 group-hover:to-orange-500/5 transition-all duration-700"></div>
              </article>
            ))}
          </div>
        )}
      </div>
    </section>

    <!-- ðŸŽ¯ ENHANCED: Philosophy Section -->
    <section class="py-32 bg-gray-900">
      <div class="max-w-6xl mx-auto px-6 text-center">
        <div class="inline-block px-6 py-2 bg-amber-400/10 border border-amber-400/30 rounded-full mb-8">
          <span class="text-amber-400 text-sm font-medium tracking-widest uppercase">Our Promise</span>
        </div>
        <h2 class="font-serif italic text-4xl md:text-5xl text-white mb-8">
          Fresh. Local. Authentic.
        </h2>
        <p class="text-xl text-gray-300 font-light leading-relaxed max-w-4xl mx-auto mb-12">
          In the heart of Tadoba's wilderness, we believe great food comes from great ingredients. 
          Every dish is crafted from locally sourced produce, prepared with love, and served with 
          the kind of personal attention that makes each meal memorable.
        </p>
        
        <!-- ðŸŽ¯ NEW: Philosophy highlights -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-4xl mx-auto">
          <div class="p-6 bg-gray-800/40 rounded-2xl border border-gray-700/50">
            <div class="w-12 h-12 mx-auto mb-4 text-green-400">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
              </svg>
            </div>
            <h3 class="text-white font-semibold mb-2">Farm to Table</h3>
            <p class="text-gray-400 text-sm">Fresh ingredients sourced locally from Tadoba region</p>
          </div>
          
          <div class="p-6 bg-gray-800/40 rounded-2xl border border-gray-700/50">
            <div class="w-12 h-12 mx-auto mb-4 text-amber-400">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
              </svg>
            </div>
            <h3 class="text-white font-semibold mb-2">Authentic Recipes</h3>
            <p class="text-gray-400 text-sm">Traditional Maharashtrian flavors with modern presentation</p>
          </div>
          
          <div class="p-6 bg-gray-800/40 rounded-2xl border border-gray-700/50">
            <div class="w-12 h-12 mx-auto mb-4 text-blue-400">
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
            </div>
            <h3 class="text-white font-semibold mb-2">Wilderness Setting</h3>
            <p class="text-gray-400 text-sm">Dining experiences in nature's embrace</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Call to Action -->
    <section class="py-32 bg-gray-950">
      <div class="max-w-4xl mx-auto px-6 text-center">
        <h2 class="font-serif italic text-4xl md:text-6xl text-white mb-8">
          Ready to Taste the Wild?
        </h2>
        <p class="text-xl text-gray-300 font-light leading-relaxed mb-12 max-w-3xl mx-auto">
          From sunrise coffee to starlit dinners, every meal at Limban is an experience. 
          Book your stay and discover flavors that connect you to the heart of Tadoba.
        </p>
        <div class="flex flex-col sm:flex-row gap-6 justify-center">
          <a href="/rooms" class="cta-filled">
            Reserve Your Stay
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
            </svg>
          </a>
          <a href="/vibe" class="cta-outlined">
            The Limban Vibe
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
            </svg>
          </a>
        </div>
      </div>
    </section>
  </div>
</Layout>

<style>
  .fade-in-up {
    opacity: 0;
    animation: fadeInUp 0.8s ease-out forwards;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Performance optimizations */
  .group {
    will-change: transform;
  }

  /* Respect user motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .transition-all,
    .transition-transform,
    .transition-colors,
    .hover\:scale-105,
    .animate-pulse,
    .fade-in-up {
      transition: none !important;
      transform: none !important;
      animation: none !important;
    }
  }
</style>
