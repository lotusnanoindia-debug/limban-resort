---
const { heroes } = Astro.props;
---

<section class="h-screen relative overflow-hidden" role="banner" aria-label="Hero carousel">
  <!-- Single loading indicator -->
  <div
    id="loading-overlay"
    class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-opacity duration-300"
    role="status"
    aria-label="Loading content"
  >
    <div class="text-center">
      <div class="w-8 h-8 border-2 border-amber-400 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-white font-light">Loading...</p>
    </div>
  </div>

  <div id="hero-carousel" class="h-full relative">
    {heroes.map((hero, index) => (
      <div
        class="hero-slide absolute inset-0 w-full h-full"
        data-slide={index}
        style={index === 0 ? "opacity: 1; z-index: 2;" : "opacity: 0; z-index: 1;"}
      >
        {/* ðŸŽ¯ CRITICAL: Using Astro-optimized AVIF images */}
        {index === 0 ? (
          // First slide: Immediate load with optimized images
          <div class="absolute inset-0 w-full h-full">
            <picture class="absolute inset-0 w-full h-full">
              {/* Astro-optimized AVIF sources */}
              <source
                srcset={hero.optimizedImages?.hero4K?.src}
                media="(min-width: 1600px)"
                type="image/avif"
              />
              <source
                srcset={hero.optimizedImages?.desktop?.src}
                media="(min-width: 1200px)"
                type="image/avif"
              />
              <source
                srcset={hero.optimizedImages?.tablet?.src}
                media="(min-width: 768px)"
                type="image/avif"
              />
              
              {/* Final fallback - use optimized mobile or original */}
              <img
                src={hero.optimizedImages?.mobile?.src || hero.backgroundImage?.heroMobile}
                alt={`${hero.slideTitle} - Limban Resort luxury safari experience`}
                class="w-full h-full object-cover transition-opacity duration-700"
                loading="eager"
                fetchpriority="high"
                decoding="sync"
              />
            </picture>
          </div>
        ) : (
          // Other slides: Lazy load with optimized images
          <div class="absolute inset-0 w-full h-full">
            <picture class="absolute inset-0 w-full h-full">
              {/* Lazy-loaded Astro-optimized AVIF sources */}
              <source
                data-srcset={hero.optimizedImages?.hero4K?.src}
                media="(min-width: 1600px)"
                type="image/avif"
              />
              <source
                data-srcset={hero.optimizedImages?.desktop?.src}
                media="(min-width: 1200px)"
                type="image/avif"
              />
              <source
                data-srcset={hero.optimizedImages?.tablet?.src}
                media="(min-width: 768px)"
                type="image/avif"
              />
              
              <img
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='9'%3E%3Crect width='100%25' height='100%25' fill='%23111827'/%3E%3C/svg%3E"
                data-src={hero.optimizedImages?.mobile?.src || hero.backgroundImage?.heroMobile}
                alt={`${hero.slideTitle} - Limban Resort luxury safari experience`}
                class="w-full h-full object-cover lazy-image"
                loading="lazy"
                decoding="async"
              />
            </picture>
          </div>
        )}

        <!-- ðŸŽ¯ SIMPLIFIED: Gradient overlays -->
        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent"></div>

        <!-- ðŸŽ¯ OPTIMIZED: Content with better typography hierarchy -->
        <div class="relative h-full flex items-center justify-center text-center z-20">
          <div class="max-w-5xl mx-auto px-6">
            <h1 class="font-serif italic text-4xl sm:text-6xl lg:text-8xl text-white mb-6 leading-tight tracking-tight">
              {hero.slideTitle}
            </h1>
            {hero.subtitle && (
              <p class="text-lg sm:text-xl lg:text-2xl text-gray-100 font-light mb-12 leading-relaxed max-w-4xl mx-auto">
                {hero.subtitle}
              </p>
            )}
            {hero.ctaText && (
              <a
                href={hero.ctaLink || "/rooms"}
                class="inline-flex items-center px-8 py-4 bg-amber-400/90 hover:bg-amber-400 text-gray-900 font-semibold rounded-full transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-amber-400/50 shadow-xl"
              >
                {hero.ctaText}
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                </svg>
              </a>
            )}
          </div>
        </div>
      </div>
    ))}
  </div>

  <!-- ðŸŽ¯ ACCESSIBLE: Navigation dots -->
  {heroes.length > 1 && (
    <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 z-30" role="tablist" aria-label="Slide navigation">
      <div class="flex space-x-3">
        {heroes.map((_, index) => (
          <button
            class={`dot-indicator w-3 h-3 rounded-full transition-all duration-300 ${
              index === 0 ? "bg-amber-400 scale-125" : "bg-white/40 hover:bg-white/70 hover:scale-110"
            }`}
            data-slide={index}
            role="tab"
            aria-selected={index === 0}
            aria-label={`Go to slide ${index + 1}`}
          />
        ))}
      </div>
    </div>
  )}
</section>

<style>
  /* ðŸŽ¯ PERFORMANCE: Optimized transitions */
  .hero-slide {
    transition: opacity 1.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .hero-slide img {
    transform: scale(1.02);
    transition: transform 20s ease-out, opacity 0.7s ease-in-out;
  }

  .lazy-image {
    filter: blur(8px);
    transition: filter 0.5s ease-in-out, opacity 0.5s ease-in-out;
  }

  .lazy-image.loaded {
    filter: none;
  }

  /* ðŸŽ¯ ACCESSIBILITY: Focus states */
  .dot-indicator:focus {
    outline: 2px solid #fbbf24;
    outline-offset: 2px;
  }

  /* ðŸŽ¯ UX: Loading overlay animation */
  .loading-overlay-visible {
    opacity: 1 !important;
    visibility: visible !important;
  }
</style>

<script>
  class HeroCarousel {
    constructor() {
      this.currentSlide = 0;
      this.autoAdvanceInterval = null;
      this.loadedImages = new Set([0]);
      this.slides = document.querySelectorAll(".hero-slide");
      this.dots = document.querySelectorAll(".dot-indicator");
      this.totalSlides = this.slides.length;
      this.loadingOverlay = document.getElementById("loading-overlay");
      
      this.init();
    }

    init() {
      if (this.totalSlides <= 1) return;
      
      this.bindEvents();
      this.startProgressiveLoading();
      this.startAutoAdvance();
    }

    // ðŸŽ¯ OPTIMIZED: Load Astro-optimized images
    async loadImage(slideIndex) {
      if (this.loadedImages.has(slideIndex)) return true;

      const slide = this.slides[slideIndex];
      if (!slide) return false;

      const img = slide.querySelector(".lazy-image");
      const sources = slide.querySelectorAll("source[data-srcset]");

      if (!img?.dataset.src) return true;

      return new Promise((resolve) => {
        // Load Astro-optimized responsive sources
        sources.forEach(source => {
          if (source.dataset.srcset) {
            source.srcset = source.dataset.srcset;
            delete source.dataset.srcset;
          }
        });

        img.onload = () => {
          img.classList.add("loaded");
          delete img.dataset.src;
          this.loadedImages.add(slideIndex);
          resolve(true);
        };

        img.onerror = () => resolve(false);
        img.src = img.dataset.src;
      });
    }

    showLoadingOverlay(show = true) {
      if (!this.loadingOverlay) return;
      this.loadingOverlay.classList.toggle("loading-overlay-visible", show);
    }

    startProgressiveLoading() {
      // Load next slide after 2 seconds
      if (this.totalSlides > 1) {
        setTimeout(() => this.loadImage(1), 2000);
      }

      // Load remaining slides conservatively
      if (this.totalSlides > 2) {
        setTimeout(() => {
          for (let i = 2; i < this.totalSlides; i++) {
            setTimeout(() => this.loadImage(i), (i - 2) * 3000);
          }
        }, 5000);
      }
    }

    async goToSlide(slideIndex, userInitiated = false) {
      if (slideIndex === this.currentSlide || slideIndex >= this.totalSlides) return;

      // Handle user-initiated navigation
      if (userInitiated && !this.loadedImages.has(slideIndex)) {
        this.showLoadingOverlay(true);
        await this.loadImage(slideIndex);
        this.showLoadingOverlay(false);
      }

      // Smooth transition
      this.slides[slideIndex].style.zIndex = "2";
      this.slides[slideIndex].style.opacity = "1";
      this.slides[this.currentSlide].style.opacity = "0";

      // Update dots
      this.dots[this.currentSlide]?.classList.remove("bg-amber-400", "scale-125");
      this.dots[this.currentSlide]?.classList.add("bg-white/40");
      this.dots[this.currentSlide]?.setAttribute("aria-selected", "false");
      
      this.dots[slideIndex]?.classList.remove("bg-white/40");
      this.dots[slideIndex]?.classList.add("bg-amber-400", "scale-125");
      this.dots[slideIndex]?.setAttribute("aria-selected", "true");

      // Update z-index after transition
      setTimeout(() => {
        this.slides[this.currentSlide].style.zIndex = "1";
        this.currentSlide = slideIndex;
      }, 1500);
    }

    nextSlide() {
      const nextIndex = (this.currentSlide + 1) % this.totalSlides;
      this.goToSlide(nextIndex, false);
    }

    startAutoAdvance() {
      if (this.totalSlides <= 1) return;
      this.autoAdvanceInterval = setInterval(() => this.nextSlide(), 8000);
    }

    stopAutoAdvance() {
      if (this.autoAdvanceInterval) {
        clearInterval(this.autoAdvanceInterval);
        this.autoAdvanceInterval = null;
      }
    }

    bindEvents() {
      // Dot navigation
      this.dots.forEach((dot, index) => {
        dot.addEventListener("click", () => {
          if (index !== this.currentSlide) {
            this.stopAutoAdvance();
            this.goToSlide(index, true);
            this.startAutoAdvance();
          }
        });

        // Keyboard navigation
        dot.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            dot.click();
          }
        });
      });

      // Pause on hover/focus
      const carousel = document.getElementById("hero-carousel");
      carousel?.addEventListener("mouseenter", () => this.stopAutoAdvance());
      carousel?.addEventListener("mouseleave", () => this.startAutoAdvance());
      carousel?.addEventListener("focusin", () => this.stopAutoAdvance());
      carousel?.addEventListener("focusout", () => this.startAutoAdvance());
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => new HeroCarousel());
  } else {
    new HeroCarousel();
  }
</script>
