---
// Reservation Form - Standalone (no BaseForm dependency)
export interface Props {
  roomName: string;
  roomSlug: string;
  basePrice?: number;
}

const { roomName, roomSlug, basePrice } = Astro.props;
const pageUrl = Astro.url.href;
---

<section aria-labelledby="reservation-heading">
  <h2
    id="reservation-heading"
    class="font-serif italic text-3xl md:text-4xl text-white mb-6"
  >
    Reserve Now: {roomName}
  </h2>
  <p class="text-gray-300 mb-6">
    Complete the form and our reservations team will confirm availability and
    safaris.
  </p>

  <p
    class="border border-amber-300 p-2 rounded-xl text-center text-gray-400 mb-6 flex items-center justify-center gap-2"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5"
      viewBox="0 0 20 20"
      fill="currentColor"
    >
      <path
        d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.518.76a11.034 11.034 0 006.364 6.364l.76-1.518a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
      ></path>
    </svg>
    <span>24/7 Reservation Hotline:</span>
    <a
      href="tel:+919022680451"
      class="font-semibold text-amber-400 hover:text-amber-300 transition-colors duration-300 whitespace-nowrap"
    >
      +91 90226 80451
    </a>
  </p>

  <!-- Success/Error Message Container -->
  <div id="form-message" class="hidden mb-6 p-4 rounded-xl text-center"></div>

  <form
    id="reservation-form"
    name="reservation"
    class="bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-xl border border-gray-700 rounded-2xl p-8"
  >
    <input type="hidden" name="form-name" value="reservation-room" />
    <input type="hidden" name="pageUrl" value={pageUrl} />
    <input type="hidden" name="roomName" value={roomName} />
    <input type="hidden" name="roomSlug" value={roomSlug} />
    {
      basePrice && (
        <input type="hidden" name="basePrice" value={String(basePrice)} />
      )
    }

    <div class="text-center pt-2">
      <div
        id="nights-message"
        class="bg-gray-950 p-2 rounded-sm text-center mb-6 text-sm transition-opacity duration-500 ease-in-out opacity-0"
      >
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div>
        <label for="check-in" class="block text-sm text-gray-300 mb-2"
          >Check-in</label
        >
        <div class="relative">
          <div
            class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none"
          >
            <svg
              class="w-5 h-5 text-gray-400"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M6 2a1 1 0 00-2 0v1H3a2 2 0 00-2 2v1h18V5a2 2 0 00-2-2h-1V2a1 1 0 10-2 0v1H6V2zM2 8v8a2 2 0 002 2h12a2 2 0 002-2V8H2zm3 3a1 1 0 011-1h1a1 1 0 110 2H6a1 1 0 01-1-1zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z"
              ></path>
            </svg>
          </div>
          <input
            id="check-in"
            name="checkin"
            type="text"
            required
            class="w-full rounded-md bg-gray-800 border border-gray-700 pl-12 pr-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors cursor-pointer"
          />
        </div>
      </div>
      <div>
        <label for="check-out" class="block text-sm text-gray-300 mb-2"
          >Check-out</label
        >
        <div class="relative">
          <div
            class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none"
          >
            <svg
              class="w-5 h-5 text-gray-400"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M6 2a1 1 0 00-2 0v1H3a2 2 0 00-2 2v1h18V5a2 2 0 00-2-2h-1V2a1 1 0 10-2 0v1H6V2zM2 8v8a2 2 0 002 2h12a2 2 0 002-2V8H2zm3 3a1 1 0 011-1h1a1 1 0 110 2H6a1 1 0 01-1-1zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z"
              ></path>
            </svg>
          </div>
          <input
            id="check-out"
            name="checkout"
            type="text"
            required
            class="w-full rounded-md bg-gray-800 border border-gray-700 pl-12 pr-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors cursor-pointer"
          />
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-9">
      <!-- Contact -->
      <div>
        <label for="firstName" class="block text-sm text-gray-300 mb-2"
          >First Name</label
        >
        <input
          id="firstName"
          name="firstName"
          required
          minlength="2"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>
      <div>
        <label for="lastName" class="block text-sm text-gray-300 mb-2"
          >Last Name</label
        >
        <input
          id="lastName"
          name="lastName"
          required
          minlength="2"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>
      <div>
        <label for="email" class="block text-sm text-gray-300 mb-2">Email</label
        >
        <input
          id="email"
          name="email"
          type="email"
          required
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>
      <div>
        <label for="phone" class="block text-sm text-gray-300 mb-2"
          >Phone/WhatsApp</label
        >
        <input
          id="phone"
          name="phone"
          type="tel"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>

      <!-- Party Size -->
      <div>
        <label for="adults" class="block text-sm text-gray-300 mb-2"
          >Adults</label
        >
        <input
          id="adults"
          name="adults"
          type="number"
          min="1"
          max="12"
          value="2"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>
      <div>
        <label for="children" class="block text-sm text-gray-300 mb-2"
          >Children</label
        >
        <input
          id="children"
          name="children"
          type="number"
          min="0"
          max="12"
          value="0"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>

      <!-- Safaris & Transfers -->
      <div>
        <label for="wantSafaris" class="block text-sm text-gray-300 mb-2"
          >Want Tiger Safaris?</label
        >
        <select
          id="wantSafaris"
          name="wantSafaris"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        >
          <option value="yes">Yes, please arrange</option>
          <option value="no">No, room only</option>
          <option value="unsure">Unsure, please advise</option>
        </select>
      </div>
      <div>
        <label for="transfer" class="block text-sm text-gray-300 mb-2"
          >Need Airport Transfers?</label
        >
        <select
          id="transfer"
          name="transfer"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        >
          <option>Yes, both ways</option>
          <option>Arrival only</option>
          <option>Departure only</option>
          <option>Not required</option>
        </select>
      </div>

      <!-- Notes -->
      <div class="md:col-span-2">
        <label for="message" class="block text-sm text-gray-300 mb-2"
          >Special Requests</label
        >
        <textarea
          id="message"
          name="message"
          rows="4"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        ></textarea>
      </div>
    </div>

    <div class="text-center pt-8">
      <button
        type="submit"
        id="submit-btn"
        class="w-full md:w-auto bg-gradient-to-r from-amber-500 to-orange-600 text-white font-semibold px-8 py-4 rounded-xl transition-all duration-300 hover:shadow-xl hover:-translate-y-1 hover:from-amber-600 hover:to-orange-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Request Reservation
      </button>
    </div>
  </form>
</section>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css"
/>

<script>
  // Import and initialize Flatpickr with advanced date validation
  import(
    "https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"
  ).then(() => {
    const checkInRef = document.getElementById("check-in");
    const checkOutRef = document.getElementById("check-out");
    const nightsMessage = document.getElementById("nights-message");
    let checkInPicker, checkOutPicker;

    const calculateNights = () => {
      if (!nightsMessage || !checkInRef?.value || !checkOutRef?.value) {
        nightsMessage.classList.remove("opacity-100");
        nightsMessage.textContent = "";
        return;
      }

      const checkIn = new Date(checkInRef.value);
      const checkOut = new Date(checkOutRef.value);

      if (checkOut <= checkIn) {
        nightsMessage.textContent = "Check-out must be after check-in!";
        nightsMessage.classList.remove("text-green-400");
        nightsMessage.classList.add("text-red-400");
      } else {
        const diffTime = Math.abs(checkOut - checkIn);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        nightsMessage.textContent = `You are reserving for ${diffDays} Night${diffDays !== 1 ? "s" : ""}`;
        nightsMessage.classList.remove("text-red-400");
        nightsMessage.classList.add("text-green-400");
      }
      nightsMessage.classList.add("opacity-100");
    };

    const baseConfig = {
      dateFormat: "M j, Y",
      allowInput: false,
      clickOpens: true,
      theme: "dark",
    };

    // Initialize Check-In Picker
    checkInPicker = flatpickr(checkInRef, {
      ...baseConfig,
      minDate: "today",
      maxDate: new Date().fp_incr(365),
      onChange: function (selectedDates) {
        if (selectedDates.length > 0) {
          const selectedCheckIn = selectedDates[0];
          const minCheckOut = new Date(selectedCheckIn);
          minCheckOut.setDate(minCheckOut.getDate() + 1); // At least 1 day after check-in

          // Update check-out picker constraints
          checkOutPicker?.set("minDate", minCheckOut);

          // Auto-clear check-out if it's now invalid (same day or before check-in)
          if (
            checkOutPicker?.selectedDates[0] &&
            checkOutPicker.selectedDates[0] <= selectedCheckIn
          ) {
            checkOutPicker.clear();
            nightsMessage.classList.remove("opacity-100");
            nightsMessage.textContent = "";
          }

          calculateNights();
        } else {
          // Check-in cleared - reset check-out constraints to default
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          checkOutPicker?.set("minDate", tomorrow);
          calculateNights();
        }
      },
    });

    // Initialize Check-Out Picker (starts from tomorrow by default)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);

    checkOutPicker = flatpickr(checkOutRef, {
      ...baseConfig,
      minDate: tomorrow, // Smart default: starts from tomorrow
      maxDate: new Date().fp_incr(365),
      onChange: function (selectedDates) {
        if (selectedDates.length > 0) {
          const selectedCheckOut = selectedDates[0];
          const maxCheckIn = new Date(selectedCheckOut);
          maxCheckIn.setDate(maxCheckIn.getDate() - 1); // At least 1 day before check-out

          // Update check-in picker constraints (reverse logic)
          checkInPicker?.set("maxDate", maxCheckIn);

          // Auto-clear check-in if it's now invalid (same day or after check-out)
          if (
            checkInPicker?.selectedDates[0] &&
            checkInPicker.selectedDates[0] >= selectedCheckOut
          ) {
            checkInPicker.clear();
            nightsMessage.classList.remove("opacity-100");
            nightsMessage.textContent = "";
          }

          calculateNights();
        } else {
          // Check-out cleared - reset check-in constraints to default
          checkInPicker?.set("maxDate", new Date().fp_incr(365));
          calculateNights();
        }
      },
    });

    // Helper function to reset both pickers (useful for debugging)
    window.resetDatePickers = () => {
      checkInPicker?.clear();
      checkOutPicker?.clear();

      // Reset to default constraints
      checkInPicker?.set("maxDate", new Date().fp_incr(365));

      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      checkOutPicker?.set("minDate", tomorrow);

      nightsMessage.classList.remove("opacity-100");
      nightsMessage.textContent = "";
    };
  });
</script>
