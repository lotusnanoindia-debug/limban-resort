---
import { Icon } from "astro-icon/components";
// Contact Section - Enhanced catch-all enquiry form with luxury glass design
const pageUrl = Astro.url.href;
---

<section id="contact" class="py-32 bg-gray-900">
  <div class="max-w-7xl mx-auto px-6 pt-12">
    <div class="text-center mb-20">
      <div class="text-sm text-gray-400 tracking-[0.2em] uppercase mb-4">
        Get In Touch with Limban Resort
      </div>
      <h2 class="font-serif italic text-4xl md:text-6xl text-white mb-8">
        How Can We Delight You?
      </h2>
      <p class="text-xl text-gray-300 max-w-3xl mx-auto leading-relaxed">
        Stunning rooms, unique dining, breathtaking safaris, rejuvenating
        wellness and personal & corporate events.
      </p>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
      <div
        class="bg-gray-800/50 backdrop-blur-xl border border-gray-700 p-8 rounded-2xl"
      >
        <h3 class="text-3xl text-white mb-8 font-serif italic">Contact Us</h3>

        <!-- Contact Methods -->
        <div class="space-y-6">
          <div class="flex items-start">
            <Icon
              name="material-symbols-light:call-outline"
              class="w-6 h-6 text-gray-400 mt-1 mr-4"
            />
            <div>
              <div class="font-medium text-amber-400 mb-1">Reservations</div>
              <div class="text-gray-300">+91 90226 80451</div>
              <div class="text-gray-300">+91 92262 54475</div>
            </div>
          </div>
          <div class="flex items-start">
            <Icon
              name="material-symbols-light:mail-outline"
              class="w-6 h-6 text-gray-400 mt-1 mr-4"
            />
            <div>
              <div class="font-medium text-amber-400 mb-1">Email</div>
              <div class="text-gray-300">info@limban.com</div>
              <div class="text-gray-300">reservations@limban.com</div>
            </div>
          </div>
          <div class="flex items-start">
            <Icon
              name="material-symbols-light:location-on-outline"
              class="w-6 h-6 text-gray-400 mt-1 mr-4"
            />
            <div>
              <div class="font-medium text-amber-400 mb-1">Location</div>
              <div class="text-gray-300">Near Tadoba-Andhari Tiger Reserve</div>
              <div class="text-gray-300">Chandrapur, Maharashtra, India</div>
            </div>
          </div>
        </div>

        <!-- Condensed Resort Information -->
        <div class="mt-8 pt-8 border-t border-gray-700">
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div class="flex items-center">
              <Icon
                name="material-symbols-light:flight-takeoff"
                class="w-4 h-4 text-amber-400 mr-2"
              />
              <span class="text-gray-400">Airport:</span>
              <span class="text-gray-300 ml-1">Nagpur</span>
            </div>
            <div class="flex items-center">
              <Icon
                name="material-symbols-light:pets"
                class="w-4 h-4 text-amber-400 mr-2"
              />
              <span class="text-gray-400">Pet Friendly:</span>
              <span class="text-gray-300 ml-1">Yes</span>
            </div>

            <div class="flex items-center">
              <Icon
                name="material-symbols-light:train"
                class="w-4 h-4 text-amber-400 mr-2"
              />
              <span class="text-gray-400">Train:</span>
              <span class="text-gray-300 ml-1">Chandrapur</span>
            </div>

            <div class="flex items-center">
              <Icon
                name="material-symbols-light:schedule"
                class="w-4 h-4 text-amber-400 mr-2"
              />
              <span class="text-gray-400">Check-in:</span>
              <span class="text-gray-300 ml-1">1 PM</span>
            </div>

            <div class="flex items-center">
              <Icon
                name="material-symbols-light:transfer-within-a-station"
                class="w-4 h-4 text-amber-400 mr-2"
              />
              <span class="text-gray-400">Transfers:</span>
              <span class="text-gray-300 ml-1">24/7</span>
            </div>
            <div class="flex items-center">
              <Icon
                name="material-symbols-light:schedule"
                class="w-4 h-4 text-amber-400 mr-2"
              />
              <span class="text-gray-400">Check-out:</span>
              <span class="text-gray-300 ml-1">11 AM</span>
            </div>
          </div>

          <div
            class="mt-12 p-3 bg-green-100/10 rounded-lg border border-green-400/20"
          >
            <div class="flex items-center">
              <Icon
                name="material-symbols-light:diversity-3"
                class="w-4 h-4 text-amber-400 mr-4"
              />
              <span class="text-amber-100 text-sm"
                >We welcome guests of all backgrounds and abilities</span
              >
            </div>
          </div>
        </div>
      </div>

      <div>
        <!-- Success/Error Message Container -->
        <div id="form-message" class="hidden mb-6 p-4 rounded-xl text-center">
        </div>

        <!-- Luxury Glass Form Design -->
        <form id="contact-form" name="contact">
          <div
            class="bg-gray-800/50 backdrop-blur-xl border border-white/20 rounded-2xl p-10 shadow-[0_8px_32px_rgba(0,0,0,0.12)]"
          >
            <h3 class="text-3xl text-white mb-8 font-serif italic">
              How Can We Assist You?
            </h3>
            <!-- Turnstile widget -->
            <div
              class="cf-turnstile"
              data-sitekey="0x4AAAAAAB08V5IJ7fONN28Y"
              data-theme="dark"
            >
            </div>

            <!-- Form Fields Wrapper with space-y for elegant vertical spacing -->
            <div class="space-y-6">
              <input type="hidden" name="form-name" value="contact-general" />
              <input type="hidden" name="pageUrl" value={pageUrl} />
              <!-- Enquiry Type Dropdown -->
              <div>
                <select
                  name="enquiryType"
                  required
                  class="w-full px-4 py-4 bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl text-white focus:border-white/40 focus:ring-2 focus:ring-white/20 focus:bg-white/15 transition-all duration-300 appearance-none bg-no-repeat bg-right pr-14"
                  style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 4 5%22><path fill=%22%23ffffff%22 d=%22M2 0L0 2h4zm0 5L0 3h4z%22/></svg>'); background-position: right 20px center; background-size: 12px;"
                >
                  <option value="">Please select...</option>
                  <option value="Room Availability"
                    >Room Availability & Rates</option
                  >
                  <option value="Dining Reservation">Dining Reservation</option>
                  <option value="Safari Activities"
                    >Tiger Safaris & Activities</option
                  >
                  <option value="Group Booking"
                    >Group Bookings (5+ guests)</option
                  >
                  <option value="Personal Events"
                    >Personal Events (Weddings, Celebrations)</option
                  >
                  <option value="Business Events"
                    >Business Events (Corporate, Seminars)</option
                  >
                  <option value="Wellness / Activities"
                    >Wellness / Activities</option
                  >
                  <option value="Travel Agent">Travel Agent Enquiry</option>
                  <option value="General Information"
                    >General Information</option
                  >
                  <option value="Feedback/Suggestions"
                    >Feedback or Suggestions</option
                  >
                </select>
              </div>

              <!-- Name Fields -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-white mb-3"
                    >First Name *</label
                  >
                  <input
                    name="firstName"
                    type="text"
                    required
                    class="w-full px-4 py-4 bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl text-white placeholder-white/50 focus:border-white/40 focus:ring-2 focus:ring-white/20 focus:bg-white/15 transition-all duration-300"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-white mb-3"
                    >Last Name *</label
                  >
                  <input
                    name="lastName"
                    type="text"
                    required
                    class="w-full px-4 py-4 bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl text-white placeholder-white/50 focus:border-white/40 focus:ring-2 focus:ring-white/20 focus:bg-white/15 transition-all duration-300"
                  />
                </div>
              </div>

              <!-- Contact Fields -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-white mb-3"
                    >Email *</label
                  >
                  <input
                    name="email"
                    type="email"
                    pattern="[a-zA-Z0-9._%+\\-]+@[a-zA-Z0-9.\\-]+\\.[a-zA-Z]{2,}"
                    required
                    class="w-full px-4 py-4 bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl text-white placeholder-white/50 focus:border-white/40 focus:ring-2 focus:ring-white/20 focus:bg-white/15 transition-all duration-300"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-white mb-3"
                    >Phone *</label
                  >
                  <input
                    name="phone"
                    type="tel"
                    required
                    class="w-full px-4 py-4 bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl text-white placeholder-white/50 focus:border-white/40 focus:ring-2 focus:ring-white/20 focus:bg-white/15 transition-all duration-300"
                  />
                </div>
              </div>

              <!-- Message Field -->
              <div>
                <label class="block text-sm font-medium text-white mb-3"
                  >Tell Us Some More:</label
                >
                <textarea
                  name="message"
                  rows="2"
                  class="w-full px-4 py-4 bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl text-white placeholder-white/50 focus:border-white/40 focus:ring-2 focus:ring-white/20 focus:bg-white/15 transition-all duration-300 resize-none"
                ></textarea>
              </div>

              <!-- Submit Button -->
              <div>
                <button type="submit" id="submit-btn" class="action-btn">
                  Send Your Enquiry
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Add Supabase form submission with Turnstile validation
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        // Use absolute import path with alias for better maintainability
        const { supabase } = await import("/src/lib/supabase.js");

        // Alternatively, could use static import at component top level:
        // import { supabase } from "@/lib/supabase.js";

        const form = document.getElementById("contact-form");
        const submitBtn = document.getElementById("submit-btn");
        const messageDiv = document.getElementById("form-message");

        if (!form) return;

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          // TURNSTILE VALIDATION
          const turnstileResponse = turnstile.getResponse();
          if (!turnstileResponse) {
            showMessage("Please complete the security check.", "error");
            return;
          }

          // Show loading state
          submitBtn.disabled = true;
          submitBtn.textContent = "Submitting...";
          showMessage("Submitting your enquiry...", "loading");

          try {
            // Get form data - clean structure for general enquiries
            const formData = new FormData(form);
            const submission = {
              form_name: formData.get("form-name"),
              page_url: formData.get("pageUrl"),
              enquiry_type: formData.get("enquiryType"),
              first_name: formData.get("firstName"),
              last_name: formData.get("lastName"),
              email: formData.get("email"),
              phone: formData.get("phone"),
              message: formData.get("message"),
              submitted_at: new Date().toISOString(),
              turnstile_response: turnstileResponse,
            };

            // Submit to Supabase - general_enquiries table
            const { data, error } = await supabase
              .from("general_enquiries")
              .insert([submission]);

            if (error) throw error;

            // Success! Show elegant success message
            showSuccessMessage();
          } catch (error) {
            console.error("Submission error:", error);
            showMessage(
              "Sorry, there was an error submitting your enquiry. Please try again or contact us directly.",
              "error",
            );
            submitBtn.disabled = false;
            submitBtn.textContent = "Send Your Enquiry";
            turnstile.reset();
          }
        });

        function showMessage(text, type) {
          messageDiv.innerHTML = text;
          messageDiv.className = `mb-6 p-4 rounded-xl text-center ${
            type === "success"
              ? "bg-green-900/50 text-green-300 border border-green-700"
              : type === "error"
                ? "bg-red-900/50 text-red-300 border border-red-700"
                : "bg-blue-900/50 text-blue-300 border border-blue-700"
          }`;
          messageDiv.classList.remove("hidden");
        }

        function showSuccessMessage() {
          // Hide the form completely
          form.style.display = "none";

          // Show elegant success message with glass styling
          messageDiv.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-6">âœ…</div>
            <h3 class="text-2xl font-serif italic text-white mb-4">Thank You!</h3>
            <p class="text-lg text-gray-300 mb-2">We've received your enquiry. Please take a look in your inbox for to find our confirmation of receipt.</p>
            <p class="text-gray-400 mb-8">Our team will contact you swiftly to assist you.</p>
            <button 
              onclick="location.reload()" 
              class="home-cta"
            >
              Submit Another Enquiry
            </button>
          </div>
        `;
          messageDiv.className =
            "bg-gradient-to-br from-white/8 to-gray-100/5 backdrop-blur-3xl border border-white/20 rounded-[2rem] p-8 text-center shadow-[0_8px_32px_rgba(0,0,0,0.12)]";
          messageDiv.classList.remove("hidden");

          turnstile.reset();
        }
      } catch (error) {
        console.error("Failed to load Supabase client:", error);
        // Show user-friendly error message
        const messageDiv = document.getElementById("form-message");
        if (messageDiv) {
          messageDiv.innerHTML = `
          <div class="text-red-300">
            <p>We're experiencing technical difficulties.</p>
            <p>Please try again later or contact us directly.</p>
          </div>
        `;
          messageDiv.classList.remove("hidden");
        }
        // Disable form submission
        const submitBtn = document.getElementById("submit-btn");
        if (submitBtn) submitBtn.disabled = true;
      }
    });
  </script>
  <!-- External script for turnstile captcha validation -->
  <script
    src="https://challenges.cloudflare.com/turnstile/v0/api.js"
    async
    defer></script>
</section>
