---
// Dining Reservation Form - Standalone (no BaseForm dependency)
export interface Props {
  itemName: string;
  itemSlug: string;
}

const { itemName, itemSlug } = Astro.props;
const pageUrl = Astro.url.href;
---

<section aria-labelledby="dining-reservation-form-heading">
  <h2
    id="dining-reservation-form-heading"
    class="font-serif italic text-3xl md:text-4xl text-white mb-6"
  >
    <span class="bg-gray-800 px-4 py-1 rounded-2xl">{itemName}</span> - Reserve Now:
  </h2>
  <p
    class="border border-amber-300 p-2 rounded-xl text-center text-gray-400 my-12 flex items-center justify-center gap-2"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5"
      viewBox="0 0 20 20"
      fill="currentColor"
    >
      <path
        d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.518.76a11.034 11.034 0 006.364 6.364l.76-1.518a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
      ></path>
    </svg>
    <span>Hotline:</span>
    <a
      href="tel:+919022680451"
      class="font-semibold text-amber-400 hover:text-amber-300 transition-colors duration-300 whitespace-nowrap"
    >
      +91 90226 80451
    </a>
  </p>

  <!-- Success/Error Message Container -->
  <div id="form-message" class="hidden mb-6 p-4 rounded-xl text-center"></div>

  <form
    id="dining-form"
    name="dining"
    class="bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-xl border border-gray-700 rounded-2xl p-8"
  >
    <!-- Hidden dummy input to prevent autocomplete -->
    <input autocomplete="off" name="fake" style="display:none;" />

    <input type="hidden" name="form-name" value="dining-reservation" />
    <input type="hidden" name="pageUrl" value={pageUrl} />
    <input type="hidden" name="outletName" value={itemName} />
    <input type="hidden" name="outletSlug" value={itemSlug} />

    <!-- Honeypot -->
    <div class="hidden" aria-hidden="true">
      <label for="confirm_email">Do not fill this out if you are human:</label>
      <input
        type="email"
        id="confirm_email"
        name="confirm_email"
        tabindex="-1"
        autocomplete="off"
      />
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- First Name -->
      <div>
        <label for="firstName" class="block text-sm text-gray-300 mb-2"
          >First Name *</label
        >
        <input
          id="firstName"
          name="firstName"
          required
          minlength="2"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>

      <!-- Last Name -->
      <div>
        <label for="lastName" class="block text-sm text-gray-300 mb-2"
          >Last Name *</label
        >
        <input
          id="lastName"
          name="lastName"
          required
          minlength="2"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>

      <!-- Email -->
      <div>
        <label for="email" class="block text-sm text-gray-300 mb-2"
          >Email *</label
        >
        <input
          id="email"
          name="email"
          type="email"
          required
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>

      <!-- Phone/WhatsApp -->
      <div>
        <label for="phone" class="block text-sm text-gray-300 mb-2"
          >Phone/WhatsApp *</label
        >
        <input
          id="phone"
          name="phone"
          type="tel"
          required
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>

      <!-- Date with Air Datepicker -->
      <div>
        <label for="dining-date" class="block text-sm text-gray-300 mb-2"
          >Dining Date *</label
        >
        <div class="relative">
          <div
            class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none"
          >
            <svg
              class="w-5 h-5 text-gray-400"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M6 2a1 1 0 00-2 0v1H3a2 2 0 00-2 2v1h18V5a2 2 0 00-2-2h-1V2a1 1 0 10-2 0v1H6V2zM2 8v8a2 2 0 002 2h12a2 2 0 002-2V8H2zm3 3a1 1 0 011-1h1a1 1 0 110 2H6a1 1 0 01-1-1zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z"
              ></path>
            </svg>
          </div>
          <input
            id="dining-date"
            name="diningDate"
            type="text"
            required
            autocomplete="off"
            class="w-full rounded-md bg-gray-800 border border-gray-700 pl-12 pr-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors cursor-pointer"
          />
        </div>
      </div>

      <!-- Time -->
      <div>
        <label for="dining-time" class="block text-sm text-gray-300 mb-2"
          >Preferred Time *</label
        >
        <select
          id="dining-time"
          name="diningTime"
          required
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        >
          <option value="">Please select...</option>
          <option value="Morning">Morning</option>
          <option value="Afternoon">Afternoon</option>
          <option value="Evening">Evening</option>
          <option value="Night">Night</option>
        </select>
      </div>

      <!-- Adults -->
      <div>
        <label for="adults" class="block text-sm text-gray-300 mb-2"
          >Adults *</label
        >
        <input
          id="adults"
          name="adults"
          type="number"
          min="1"
          max="20"
          value="2"
          required
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>

      <!-- Children -->
      <div>
        <label for="children" class="block text-sm text-gray-300 mb-2"
          >Children</label
        >
        <input
          id="children"
          name="children"
          type="number"
          min="0"
          max="20"
          value="0"
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
        />
      </div>

      <!-- Notes -->
      <div class="md:col-span-2">
        <label for="message" class="block text-sm text-gray-300 mb-2"
          >Special Requests or Occasion?</label
        >
        <textarea
          id="message"
          name="message"
          rows="3"
          placeholder="Anniversary, birthday, work event, special occasion, special dietary requirements, etc."
          class="w-full rounded-md bg-gray-800 border border-gray-700 px-4 py-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors resize-none"
        ></textarea>
      </div>
    </div>

    <div class="text-center pt-8">
      <button
        type="submit"
        id="submit-btn"
        class="w-full md:w-auto bg-gradient-to-r from-amber-500 to-orange-600 text-white font-semibold px-8 py-4 rounded-xl transition-all duration-300 hover:shadow-xl hover:-translate-y-1 hover:from-amber-600 hover:to-orange-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Request a Table
      </button>
    </div>
  </form>
</section>

<!-- Air Datepicker CSS -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/air-datepicker@3.6.0/air-datepicker.css"
/>

<script type="module" client:visible>
  import AirDatepicker from "https://cdn.jsdelivr.net/npm/air-datepicker@3.6.0/+esm";

  document.addEventListener("DOMContentLoaded", () => {
    const diningDateRef = document.getElementById("dining-date");

    if (!diningDateRef) return;

    // Define English locale inline
    const localeEn = {
      days: [
        "Sunday",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday",
      ],
      daysShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
      daysMin: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
      months: [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December",
      ],
      monthsShort: [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ],
      today: "Today",
      clear: "Clear",
      dateFormat: "MMM dd, yyyy",
      timeFormat: "hh:mm aa",
      firstDay: 0,
    };

    // Create today's date for default
    const today = new Date();

    // Initialize Air Datepicker for dining date
    const diningDatePicker = new AirDatepicker(diningDateRef, {
      locale: localeEn, // English locale
      autoClose: true,
      minDate: today, // Can't book in the past
      maxDate: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000), // 6 months ahead
    });
  });
</script>

<script>
  // Keep your existing form submission script here
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const { supabase } = await import("../lib/supabase.js");

      const form = document.getElementById("dining-form");
      const submitBtn = document.getElementById("submit-btn");
      const messageDiv = document.getElementById("form-message");

      if (!form) return;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Check honeypot
        const formData = new FormData(form);
        if (formData.get("confirm_email")) {
          showSuccessMessage(); // Show success to bots
          return;
        }

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";
        showMessage("Submitting your table request...", "loading");

        try {
          // Get form data - matching your form-handler.js structure
          const submission = {
            form_name: formData.get("form-name"),
            page_url: formData.get("pageUrl"),
            outletname: formData.get("outletName"),
            outletslug: formData.get("outletSlug"),
            first_name: formData.get("firstName"),
            last_name: formData.get("lastName"),
            email: formData.get("email"),
            phone: formData.get("phone"),
            dining_date: formData.get("diningDate"),
            dining_time: formData.get("diningTime"),
            adults: parseInt(formData.get("adults")) || 0,
            children: parseInt(formData.get("children")) || 0,
            message: formData.get("message"),
          };

          // Submit to Supabase - using dining_submissions table
          const { data, error } = await supabase
            .from("dining_submissions")
            .insert([submission]);

          if (error) throw error;

          // Success! Show elegant success message
          showSuccessMessage();
        } catch (error) {
          console.error("Submission error:", error);
          showMessage(
            "Sorry, there was an error submitting your table request. Please try again or contact us directly.",
            "error"
          );
          submitBtn.disabled = false;
          submitBtn.textContent = "Request a Table";
        }
      });

      function showMessage(text, type) {
        messageDiv.innerHTML = text;
        messageDiv.className = `mb-6 p-4 rounded-xl text-center ${
          type === "success"
            ? "bg-green-900/50 text-green-300 border border-green-700"
            : type === "error"
              ? "bg-red-900/50 text-red-300 border border-red-700"
              : "bg-blue-900/50 text-blue-300 border border-blue-700"
        }`;
        messageDiv.classList.remove("hidden");
      }

      function showSuccessMessage() {
        // Hide the form completely
        form.style.display = "none";

        // Show elegant success message
        messageDiv.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-6">üçΩÔ∏è</div>
            <h3 class="text-2xl font-serif italic text-white mb-4">Request Received!</h3>
            <p class="text-lg text-gray-300 mb-6">Your request has been submitted successfully.</p>
            <p class="text-gray-400 mb-8">Our team will contact you shortly to confirm your dining experience.</p>
            <button 
              onclick="location.reload()" 
              class="bg-gradient-to-r from-amber-500 to-orange-600 text-white font-semibold px-6 py-3 rounded-xl transition-all duration-300 hover:shadow-xl hover:-translate-y-1 hover:from-amber-600 hover:to-orange-700"
            >
              Request Another Table
            </button>
          </div>
        `;
        messageDiv.className =
          "bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-xl border border-amber-600 rounded-2xl p-8 text-center";
        messageDiv.classList.remove("hidden");
      }
    } catch (error) {
      console.error("Failed to load Supabase:", error);
    }
  });
</script>
